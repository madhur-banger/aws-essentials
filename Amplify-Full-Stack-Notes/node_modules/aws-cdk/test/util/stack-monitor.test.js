"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/* eslint-disable import/order */
const mock_sdk_1 = require("./mock-sdk");
const stack_activity_monitor_1 = require("../../lib/api/util/cloudformation/stack-activity-monitor");
const util_1 = require("../util");
let sdk;
let printer;
beforeEach(() => {
    sdk = new mock_sdk_1.MockSdk();
    printer = new FakePrinter();
});
describe('stack monitor event ordering and pagination', () => {
    test('continue to the next page if it exists', async () => {
        await testMonitorWithEventCalls([
            (request) => {
                expect(request.NextToken).toBeUndefined();
                return {
                    StackEvents: [event(102)],
                    NextToken: 'some-token',
                };
            },
            (request) => {
                expect(request.NextToken).toBe('some-token');
                return {
                    StackEvents: [event(101)],
                };
            },
        ]);
        // Printer sees them in chronological order
        expect(printer.eventIds).toEqual(['101', '102']);
    });
    test('do not page further if we already saw the last event', async () => {
        await testMonitorWithEventCalls([
            (request) => {
                expect(request.NextToken).toBeUndefined();
                return {
                    StackEvents: [event(101)],
                };
            },
            (request) => {
                expect(request.NextToken).toBeUndefined();
                return {
                    StackEvents: [event(102), event(101)],
                    NextToken: 'some-token',
                };
            },
            (request) => {
                // Did not use the token
                expect(request.NextToken).toBeUndefined();
                return {};
            },
        ]);
        // Seen in chronological order
        expect(printer.eventIds).toEqual(['101', '102']);
    });
    test('do not page further if the last event is too old', async () => {
        await testMonitorWithEventCalls([
            (request) => {
                expect(request.NextToken).toBeUndefined();
                return {
                    StackEvents: [event(101), event(95)],
                    NextToken: 'some-token',
                };
            },
            (request) => {
                // Start again from the top
                expect(request.NextToken).toBeUndefined();
                return {};
            },
        ]);
        // Seen only the new one
        expect(printer.eventIds).toEqual(['101']);
    });
    test('do a final request after the monitor is stopped', async () => {
        await testMonitorWithEventCalls([
            // Before stop
            (request) => {
                expect(request.NextToken).toBeUndefined();
                return {
                    StackEvents: [event(101)],
                };
            },
        ], 
        // After stop
        [
            (request) => {
                expect(request.NextToken).toBeUndefined();
                return {
                    StackEvents: [event(102), event(101)],
                };
            },
        ]);
        // Seen both
        expect(printer.eventIds).toEqual(['101', '102']);
    });
});
describe('stack monitor, collecting errors from events', () => {
    test('return errors from the root stack', async () => {
        const monitor = await testMonitorWithEventCalls([
            (request) => {
                expect(request.NextToken).toBeUndefined();
                return {
                    StackEvents: [addErrorToStackEvent(event(100))],
                };
            },
        ]);
        expect(monitor.errors).toStrictEqual(['Test Error']);
    });
    test('return errors from the nested stack', async () => {
        const monitor = await testMonitorWithEventCalls([
            (request) => {
                expect(request.StackName).toStrictEqual('StackName');
                return {
                    StackEvents: [
                        addErrorToStackEvent(event(102), {
                            logicalResourceId: 'nestedStackLogicalResourceId',
                            physicalResourceId: 'nestedStackPhysicalResourceId',
                            resourceType: 'AWS::CloudFormation::Stack',
                            resourceStatusReason: 'nested stack failed',
                            resourceStatus: 'UPDATE_FAILED',
                        }),
                        addErrorToStackEvent(event(100), {
                            logicalResourceId: 'nestedStackLogicalResourceId',
                            physicalResourceId: 'nestedStackPhysicalResourceId',
                            resourceType: 'AWS::CloudFormation::Stack',
                            resourceStatus: 'UPDATE_IN_PROGRESS',
                        }),
                    ],
                };
            },
            (request) => {
                expect(request.StackName).toStrictEqual('nestedStackPhysicalResourceId');
                return {
                    StackEvents: [
                        addErrorToStackEvent(event(101), {
                            logicalResourceId: 'nestedResource',
                            resourceType: 'Some::Nested::Resource',
                            resourceStatusReason: 'actual failure error message',
                        }),
                    ],
                };
            },
        ]);
        expect(monitor.errors).toStrictEqual(['actual failure error message', 'nested stack failed']);
    });
    test('does not consider events without physical resource id for monitoring nested stacks', async () => {
        const monitor = await testMonitorWithEventCalls([
            (request) => {
                expect(request.StackName).toStrictEqual('StackName');
                return {
                    StackEvents: [
                        addErrorToStackEvent(event(100), {
                            logicalResourceId: 'nestedStackLogicalResourceId',
                            physicalResourceId: '',
                            resourceType: 'AWS::CloudFormation::Stack',
                            resourceStatusReason: 'nested stack failed',
                            resourceStatus: 'CREATE_IN_PROGRESS',
                        }),
                    ],
                };
            },
            (request) => {
                // Note that the second call happened for the top level stack instead of a nested stack
                expect(request.StackName).toStrictEqual('StackName');
                return {
                    StackEvents: [
                        addErrorToStackEvent(event(101), {
                            logicalResourceId: 'OtherResource',
                            resourceType: 'Some::Other::Resource',
                            resourceStatusReason: 'some failure',
                        }),
                    ],
                };
            },
        ]);
        expect(monitor.errors).not.toContain('nested stack failed');
        expect(monitor.errors).toContain('some failure');
    });
    test('does not check for nested stacks that have already completed successfully', async () => {
        const monitor = await testMonitorWithEventCalls([
            (request) => {
                expect(request.StackName).toStrictEqual('StackName');
                return {
                    StackEvents: [
                        addErrorToStackEvent(event(100), {
                            logicalResourceId: 'nestedStackLogicalResourceId',
                            physicalResourceId: 'nestedStackPhysicalResourceId',
                            resourceType: 'AWS::CloudFormation::Stack',
                            resourceStatusReason: 'nested stack status reason',
                            resourceStatus: 'CREATE_COMPLETE',
                        }),
                    ],
                };
            },
        ]);
        expect(monitor.errors).toStrictEqual([]);
    });
});
const T0 = 1597837230504;
// Events 0-99 are before we started paying attention
const T100 = T0 + 100 * 1000;
function event(nr) {
    return {
        EventId: `${nr}`,
        StackId: 'StackId',
        StackName: 'StackName',
        Timestamp: new Date(T0 + nr * 1000),
    };
}
function addErrorToStackEvent(eventToUpdate, props = {}) {
    eventToUpdate.ResourceStatus = props.resourceStatus ?? 'UPDATE_FAILED';
    eventToUpdate.ResourceType = props.resourceType ?? 'Test::Resource::Type';
    eventToUpdate.ResourceStatusReason = props.resourceStatusReason ?? 'Test Error';
    eventToUpdate.LogicalResourceId = props.logicalResourceId ?? 'testLogicalId';
    eventToUpdate.PhysicalResourceId = props.physicalResourceId ?? 'testPhysicalResourceId';
    return eventToUpdate;
}
async function testMonitorWithEventCalls(beforeStopInvocations, afterStopInvocations = []) {
    let describeStackEvents = jest.fn();
    let finished = false;
    let error = undefined;
    for (const invocation of beforeStopInvocations) {
        const invocation_ = invocation; // Capture loop variable in local because of closure semantics
        const isLast = invocation === beforeStopInvocations[beforeStopInvocations.length - 1];
        describeStackEvents = describeStackEvents.mockImplementationOnce(request => {
            try {
                const ret = invocation_(request);
                if (isLast) {
                    finished = true;
                }
                return ret;
            }
            catch (e) {
                finished = true;
                error = e;
                throw e;
            }
        });
    }
    if (error) {
        throw error;
    }
    for (const invocation of afterStopInvocations) {
        describeStackEvents = describeStackEvents.mockImplementationOnce(invocation);
    }
    describeStackEvents.mockImplementation(() => { return {}; });
    sdk.stubCloudFormation({ describeStackEvents });
    const monitor = new stack_activity_monitor_1.StackActivityMonitor(sdk.cloudFormation(), 'StackName', printer, undefined, new Date(T100)).start();
    await waitForCondition(() => finished);
    await monitor.stop();
    return monitor;
}
class FakePrinter {
    constructor() {
        this.updateSleep = 0;
        this.activities = [];
    }
    get eventIds() {
        return this.activities.map(a => a.event.EventId);
    }
    addActivity(activity) {
        this.activities.push(activity);
    }
    print() { }
    start() { }
    stop() { }
}
async function waitForCondition(cb) {
    while (!cb()) {
        await (0, util_1.sleep)(10);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhY2stbW9uaXRvci50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic3RhY2stbW9uaXRvci50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsaUNBQWlDO0FBQ2pDLHlDQUFxQztBQUNyQyxxR0FBaUk7QUFDakksa0NBQWdDO0FBRWhDLElBQUksR0FBWSxDQUFDO0FBQ2pCLElBQUksT0FBb0IsQ0FBQztBQUN6QixVQUFVLENBQUMsR0FBRyxFQUFFO0lBQ2QsR0FBRyxHQUFHLElBQUksa0JBQU8sRUFBRSxDQUFDO0lBQ3BCLE9BQU8sR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO0FBQzlCLENBQUMsQ0FBQyxDQUFDO0FBRUgsUUFBUSxDQUFDLDZDQUE2QyxFQUFFLEdBQUcsRUFBRTtJQUMzRCxJQUFJLENBQUMsd0NBQXdDLEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFDeEQsTUFBTSx5QkFBeUIsQ0FBQztZQUM5QixDQUFDLE9BQU8sRUFBRSxFQUFFO2dCQUNWLE1BQU0sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsYUFBYSxFQUFFLENBQUM7Z0JBQzFDLE9BQU87b0JBQ0wsV0FBVyxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO29CQUN6QixTQUFTLEVBQUUsWUFBWTtpQkFDeEIsQ0FBQztZQUNKLENBQUM7WUFDRCxDQUFDLE9BQU8sRUFBRSxFQUFFO2dCQUNWLE1BQU0sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO2dCQUM3QyxPQUFPO29CQUNMLFdBQVcsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztpQkFDMUIsQ0FBQztZQUNKLENBQUM7U0FDRixDQUFDLENBQUM7UUFFSCwyQ0FBMkM7UUFDM0MsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUMs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Q0FBQyxjQUFjLEVBQUUsRUFBRSxXQUFXLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ3hILE1BQU0sZ0JBQWdCLENBQUMsR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDdkMsTUFBTSxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDckIsT0FBTyxPQUFPLENBQUM7QUFDakIsQ0FBQztBQUVELE1BQU0sV0FBVztJQUFqQjtRQUNTLGdCQUFXLEdBQVcsQ0FBQyxDQUFDO1FBQ2YsZUFBVSxHQUFvQixFQUFFLENBQUM7SUFhbkQsQ0FBQztJQVhDLElBQVcsUUFBUTtRQUNqQixPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNuRCxDQUFDO0lBRU0sV0FBVyxDQUFDLFFBQXVCO1FBQ3hDLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ2pDLENBQUM7SUFFTSxLQUFLLEtBQVcsQ0FBQztJQUNqQixLQUFLLEtBQVcsQ0FBQztJQUNqQixJQUFJLEtBQVcsQ0FBQztDQUN4QjtBQUVELEtBQUssVUFBVSxnQkFBZ0IsQ0FBQyxFQUFpQjtJQUMvQyxPQUFPLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQztRQUNiLE1BQU0sSUFBQSxZQUFLLEVBQUMsRUFBRSxDQUFDLENBQUM7SUFDbEIsQ0FBQztBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBpbXBvcnQvb3JkZXIgKi9cbmltcG9ydCB7IE1vY2tTZGsgfSBmcm9tICcuL21vY2stc2RrJztcbmltcG9ydCB7IFN0YWNrQWN0aXZpdHlNb25pdG9yLCBJQWN0aXZpdHlQcmludGVyLCBTdGFja0FjdGl2aXR5IH0gZnJvbSAnLi4vLi4vbGliL2FwaS91dGlsL2Nsb3VkZm9ybWF0aW9uL3N0YWNrLWFjdGl2aXR5LW1vbml0b3InO1xuaW1wb3J0IHsgc2xlZXAgfSBmcm9tICcuLi91dGlsJztcblxubGV0IHNkazogTW9ja1NkaztcbmxldCBwcmludGVyOiBGYWtlUHJpbnRlcjtcbmJlZm9yZUVhY2goKCkgPT4ge1xuICBzZGsgPSBuZXcgTW9ja1NkaygpO1xuICBwcmludGVyID0gbmV3IEZha2VQcmludGVyKCk7XG59KTtcblxuZGVzY3JpYmUoJ3N0YWNrIG1vbml0b3IgZXZlbnQgb3JkZXJpbmcgYW5kIHBhZ2luYXRpb24nLCAoKSA9PiB7XG4gIHRlc3QoJ2NvbnRpbnVlIHRvIHRoZSBuZXh0IHBhZ2UgaWYgaXQgZXhpc3RzJywgYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IHRlc3RNb25pdG9yV2l0aEV2ZW50Q2FsbHMoW1xuICAgICAgKHJlcXVlc3QpID0+IHtcbiAgICAgICAgZXhwZWN0KHJlcXVlc3QuTmV4dFRva2VuKS50b0JlVW5kZWZpbmVkKCk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgU3RhY2tFdmVudHM6IFtldmVudCgxMDIpXSxcbiAgICAgICAgICBOZXh0VG9rZW46ICdzb21lLXRva2VuJyxcbiAgICAgICAgfTtcbiAgICAgIH0sXG4gICAgICAocmVxdWVzdCkgPT4ge1xuICAgICAgICBleHBlY3QocmVxdWVzdC5OZXh0VG9rZW4pLnRvQmUoJ3NvbWUtdG9rZW4nKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBTdGFja0V2ZW50czogW2V2ZW50KDEwMSldLFxuICAgICAgICB9O1xuICAgICAgfSxcbiAgICBdKTtcblxuICAgIC8vIFByaW50ZXIgc2VlcyB0aGVtIGluIGNocm9ub2xvZ2ljYWwgb3JkZXJcbiAgICBleHBlY3QocHJpbnRlci5ldmVudElkcykudG9FcXVhbChbJzEwMScsICcxMDInXSk7XG4gIH0pO1xuXG4gIHRlc3QoJ2RvIG5vdCBwYWdlIGZ1cnRoZXIgaWYgd2UgYWxyZWFkeSBzYXcgdGhlIGxhc3QgZXZlbnQnLCBhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgdGVzdE1vbml0b3JXaXRoRXZlbnRDYWxscyhbXG4gICAgICAocmVxdWVzdCkgPT4ge1xuICAgICAgICBleHBlY3QocmVxdWVzdC5OZXh0VG9rZW4pLnRvQmVVbmRlZmluZWQoKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBTdGFja0V2ZW50czogW2V2ZW50KDEwMSldLFxuICAgICAgICB9O1xuICAgICAgfSxcbiAgICAgIChyZXF1ZXN0KSA9PiB7XG4gICAgICAgIGV4cGVjdChyZXF1ZXN0Lk5leHRUb2tlbikudG9CZVVuZGVmaW5lZCgpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIFN0YWNrRXZlbnRzOiBbZXZlbnQoMTAyKSwgZXZlbnQoMTAxKV0sXG4gICAgICAgICAgTmV4dFRva2VuOiAnc29tZS10b2tlbicsXG4gICAgICAgIH07XG4gICAgICB9LFxuICAgICAgKHJlcXVlc3QpID0+IHtcbiAgICAgICAgLy8gRGlkIG5vdCB1c2UgdGhlIHRva2VuXG4gICAgICAgIGV4cGVjdChyZXF1ZXN0Lk5leHRUb2tlbikudG9CZVVuZGVmaW5lZCgpO1xuICAgICAgICByZXR1cm4ge307XG4gICAgICB9LFxuICAgIF0pO1xuXG4gICAgLy8gU2VlbiBpbiBjaHJvbm9sb2dpY2FsIG9yZGVyXG4gICAgZXhwZWN0KHByaW50ZXIuZXZlbnRJZHMpLnRvRXF1YWwoWycxMDEnLCAnMTAyJ10pO1xuICB9KTtcblxuICB0ZXN0KCdkbyBub3QgcGFnZSBmdXJ0aGVyIGlmIHRoZSBsYXN0IGV2ZW50IGlzIHRvbyBvbGQnLCBhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgdGVzdE1vbml0b3JXaXRoRXZlbnRDYWxscyhbXG4gICAgICAocmVxdWVzdCkgPT4ge1xuICAgICAgICBleHBlY3QocmVxdWVzdC5OZXh0VG9rZW4pLnRvQmVVbmRlZmluZWQoKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBTdGFja0V2ZW50czogW2V2ZW50KDEwMSksIGV2ZW50KDk1KV0sXG4gICAgICAgICAgTmV4dFRva2VuOiAnc29tZS10b2tlbicsXG4gICAgICAgIH07XG4gICAgICB9LFxuICAgICAgKHJlcXVlc3QpID0+IHtcbiAgICAgICAgLy8gU3RhcnQgYWdhaW4gZnJvbSB0aGUgdG9wXG4gICAgICAgIGV4cGVjdChyZXF1ZXN0Lk5leHRUb2tlbikudG9CZVVuZGVmaW5lZCgpO1xuICAgICAgICByZXR1cm4ge307XG4gICAgICB9LFxuICAgIF0pO1xuXG4gICAgLy8gU2VlbiBvbmx5IHRoZSBuZXcgb25lXG4gICAgZXhwZWN0KHByaW50ZXIuZXZlbnRJZHMpLnRvRXF1YWwoWycxMDEnXSk7XG4gIH0pO1xuXG4gIHRlc3QoJ2RvIGEgZmluYWwgcmVxdWVzdCBhZnRlciB0aGUgbW9uaXRvciBpcyBzdG9wcGVkJywgYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IHRlc3RNb25pdG9yV2l0aEV2ZW50Q2FsbHMoW1xuICAgICAgLy8gQmVmb3JlIHN0b3BcbiAgICAgIChyZXF1ZXN0KSA9PiB7XG4gICAgICAgIGV4cGVjdChyZXF1ZXN0Lk5leHRUb2tlbikudG9CZVVuZGVmaW5lZCgpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIFN0YWNrRXZlbnRzOiBbZXZlbnQoMTAxKV0sXG4gICAgICAgIH07XG4gICAgICB9LFxuICAgIF0sXG4gICAgLy8gQWZ0ZXIgc3RvcFxuICAgIFtcbiAgICAgIChyZXF1ZXN0KSA9PiB7XG4gICAgICAgIGV4cGVjdChyZXF1ZXN0Lk5leHRUb2tlbikudG9CZVVuZGVmaW5lZCgpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIFN0YWNrRXZlbnRzOiBbZXZlbnQoMTAyKSwgZXZlbnQoMTAxKV0sXG4gICAgICAgIH07XG4gICAgICB9LFxuICAgIF0pO1xuXG4gICAgLy8gU2VlbiBib3RoXG4gICAgZXhwZWN0KHByaW50ZXIuZXZlbnRJZHMpLnRvRXF1YWwoWycxMDEnLCAnMTAyJ10pO1xuICB9KTtcbn0pO1xuXG5kZXNjcmliZSgnc3RhY2sgbW9uaXRvciwgY29sbGVjdGluZyBlcnJvcnMgZnJvbSBldmVudHMnLCAoKSA9PiB7XG4gIHRlc3QoJ3JldHVybiBlcnJvcnMgZnJvbSB0aGUgcm9vdCBzdGFjaycsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBtb25pdG9yID0gYXdhaXQgdGVzdE1vbml0b3JXaXRoRXZlbnRDYWxscyhbXG4gICAgICAocmVxdWVzdCkgPT4ge1xuICAgICAgICBleHBlY3QocmVxdWVzdC5OZXh0VG9rZW4pLnRvQmVVbmRlZmluZWQoKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBTdGFja0V2ZW50czogW2FkZEVycm9yVG9TdGFja0V2ZW50KGV2ZW50KDEwMCkpXSxcbiAgICAgICAgfTtcbiAgICAgIH0sXG4gICAgXSk7XG5cbiAgICBleHBlY3QobW9uaXRvci5lcnJvcnMpLnRvU3RyaWN0RXF1YWwoWydUZXN0IEVycm9yJ10pO1xuICB9KTtcblxuICB0ZXN0KCdyZXR1cm4gZXJyb3JzIGZyb20gdGhlIG5lc3RlZCBzdGFjaycsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBtb25pdG9yID0gYXdhaXQgdGVzdE1vbml0b3JXaXRoRXZlbnRDYWxscyhbXG4gICAgICAocmVxdWVzdCkgPT4ge1xuICAgICAgICBleHBlY3QocmVxdWVzdC5TdGFja05hbWUpLnRvU3RyaWN0RXF1YWwoJ1N0YWNrTmFtZScpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIFN0YWNrRXZlbnRzOiBbXG4gICAgICAgICAgICBhZGRFcnJvclRvU3RhY2tFdmVudChcbiAgICAgICAgICAgICAgZXZlbnQoMTAyKSwge1xuICAgICAgICAgICAgICAgIGxvZ2ljYWxSZXNvdXJjZUlkOiAnbmVzdGVkU3RhY2tMb2dpY2FsUmVzb3VyY2VJZCcsXG4gICAgICAgICAgICAgICAgcGh5c2ljYWxSZXNvdXJjZUlkOiAnbmVzdGVkU3RhY2tQaHlzaWNhbFJlc291cmNlSWQnLFxuICAgICAgICAgICAgICAgIHJlc291cmNlVHlwZTogJ0FXUzo6Q2xvdWRGb3JtYXRpb246OlN0YWNrJyxcbiAgICAgICAgICAgICAgICByZXNvdXJjZVN0YXR1c1JlYXNvbjogJ25lc3RlZCBzdGFjayBmYWlsZWQnLFxuICAgICAgICAgICAgICAgIHJlc291cmNlU3RhdHVzOiAnVVBEQVRFX0ZBSUxFRCcsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICApLFxuICAgICAgICAgICAgYWRkRXJyb3JUb1N0YWNrRXZlbnQoXG4gICAgICAgICAgICAgIGV2ZW50KDEwMCksIHtcbiAgICAgICAgICAgICAgICBsb2dpY2FsUmVzb3VyY2VJZDogJ25lc3RlZFN0YWNrTG9naWNhbFJlc291cmNlSWQnLFxuICAgICAgICAgICAgICAgIHBoeXNpY2FsUmVzb3VyY2VJZDogJ25lc3RlZFN0YWNrUGh5c2ljYWxSZXNvdXJjZUlkJyxcbiAgICAgICAgICAgICAgICByZXNvdXJjZVR5cGU6ICdBV1M6OkNsb3VkRm9ybWF0aW9uOjpTdGFjaycsXG4gICAgICAgICAgICAgICAgcmVzb3VyY2VTdGF0dXM6ICdVUERBVEVfSU5fUFJPR1JFU1MnLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICBdLFxuICAgICAgICB9O1xuICAgICAgfSxcbiAgICAgIChyZXF1ZXN0KSA9PiB7XG4gICAgICAgIGV4cGVjdChyZXF1ZXN0LlN0YWNrTmFtZSkudG9TdHJpY3RFcXVhbCgnbmVzdGVkU3RhY2tQaHlzaWNhbFJlc291cmNlSWQnKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBTdGFja0V2ZW50czogW1xuICAgICAgICAgICAgYWRkRXJyb3JUb1N0YWNrRXZlbnQoXG4gICAgICAgICAgICAgIGV2ZW50KDEwMSksIHtcbiAgICAgICAgICAgICAgICBsb2dpY2FsUmVzb3VyY2VJZDogJ25lc3RlZFJlc291cmNlJyxcbiAgICAgICAgICAgICAgICByZXNvdXJjZVR5cGU6ICdTb21lOjpOZXN0ZWQ6OlJlc291cmNlJyxcbiAgICAgICAgICAgICAgICByZXNvdXJjZVN0YXR1c1JlYXNvbjogJ2FjdHVhbCBmYWlsdXJlIGVycm9yIG1lc3NhZ2UnLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICBdLFxuICAgICAgICB9O1xuICAgICAgfSxcbiAgICBdKTtcblxuICAgIGV4cGVjdChtb25pdG9yLmVycm9ycykudG9TdHJpY3RFcXVhbChbJ2FjdHVhbCBmYWlsdXJlIGVycm9yIG1lc3NhZ2UnLCAnbmVzdGVkIHN0YWNrIGZhaWxlZCddKTtcbiAgfSk7XG5cbiAgdGVzdCgnZG9lcyBub3QgY29uc2lkZXIgZXZlbnRzIHdpdGhvdXQgcGh5c2ljYWwgcmVzb3VyY2UgaWQgZm9yIG1vbml0b3JpbmcgbmVzdGVkIHN0YWNrcycsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBtb25pdG9yID0gYXdhaXQgdGVzdE1vbml0b3JXaXRoRXZlbnRDYWxscyhbXG4gICAgICAocmVxdWVzdCkgPT4ge1xuICAgICAgICBleHBlY3QocmVxdWVzdC5TdGFja05hbWUpLnRvU3RyaWN0RXF1YWwoJ1N0YWNrTmFtZScpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIFN0YWNrRXZlbnRzOiBbXG4gICAgICAgICAgICBhZGRFcnJvclRvU3RhY2tFdmVudChcbiAgICAgICAgICAgICAgZXZlbnQoMTAwKSwge1xuICAgICAgICAgICAgICAgIGxvZ2ljYWxSZXNvdXJjZUlkOiAnbmVzdGVkU3RhY2tMb2dpY2FsUmVzb3VyY2VJZCcsXG4gICAgICAgICAgICAgICAgcGh5c2ljYWxSZXNvdXJjZUlkOiAnJyxcbiAgICAgICAgICAgICAgICByZXNvdXJjZVR5cGU6ICdBV1M6OkNsb3VkRm9ybWF0aW9uOjpTdGFjaycsXG4gICAgICAgICAgICAgICAgcmVzb3VyY2VTdGF0dXNSZWFzb246ICduZXN0ZWQgc3RhY2sgZmFpbGVkJyxcbiAgICAgICAgICAgICAgICByZXNvdXJjZVN0YXR1czogJ0NSRUFURV9JTl9QUk9HUkVTUycsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICApLFxuICAgICAgICAgIF0sXG4gICAgICAgIH07XG4gICAgICB9LFxuICAgICAgKHJlcXVlc3QpID0+IHtcbiAgICAgICAgLy8gTm90ZSB0aGF0IHRoZSBzZWNvbmQgY2FsbCBoYXBwZW5lZCBmb3IgdGhlIHRvcCBsZXZlbCBzdGFjayBpbnN0ZWFkIG9mIGEgbmVzdGVkIHN0YWNrXG4gICAgICAgIGV4cGVjdChyZXF1ZXN0LlN0YWNrTmFtZSkudG9TdHJpY3RFcXVhbCgnU3RhY2tOYW1lJyk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgU3RhY2tFdmVudHM6IFtcbiAgICAgICAgICAgIGFkZEVycm9yVG9TdGFja0V2ZW50KFxuICAgICAgICAgICAgICBldmVudCgxMDEpLCB7XG4gICAgICAgICAgICAgICAgbG9naWNhbFJlc291cmNlSWQ6ICdPdGhlclJlc291cmNlJyxcbiAgICAgICAgICAgICAgICByZXNvdXJjZVR5cGU6ICdTb21lOjpPdGhlcjo6UmVzb3VyY2UnLFxuICAgICAgICAgICAgICAgIHJlc291cmNlU3RhdHVzUmVhc29uOiAnc29tZSBmYWlsdXJlJyxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICksXG4gICAgICAgICAgXSxcbiAgICAgICAgfTtcbiAgICAgIH0sXG4gICAgXSk7XG5cbiAgICBleHBlY3QobW9uaXRvci5lcnJvcnMpLm5vdC50b0NvbnRhaW4oJ25lc3RlZCBzdGFjayBmYWlsZWQnKTtcbiAgICBleHBlY3QobW9uaXRvci5lcnJvcnMpLnRvQ29udGFpbignc29tZSBmYWlsdXJlJyk7XG4gIH0pO1xuXG4gIHRlc3QoJ2RvZXMgbm90IGNoZWNrIGZvciBuZXN0ZWQgc3RhY2tzIHRoYXQgaGF2ZSBhbHJlYWR5IGNvbXBsZXRlZCBzdWNjZXNzZnVsbHknLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgbW9uaXRvciA9IGF3YWl0IHRlc3RNb25pdG9yV2l0aEV2ZW50Q2FsbHMoW1xuICAgICAgKHJlcXVlc3QpID0+IHtcbiAgICAgICAgZXhwZWN0KHJlcXVlc3QuU3RhY2tOYW1lKS50b1N0cmljdEVxdWFsKCdTdGFja05hbWUnKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBTdGFja0V2ZW50czogW1xuICAgICAgICAgICAgYWRkRXJyb3JUb1N0YWNrRXZlbnQoXG4gICAgICAgICAgICAgIGV2ZW50KDEwMCksIHtcbiAgICAgICAgICAgICAgICBsb2dpY2FsUmVzb3VyY2VJZDogJ25lc3RlZFN0YWNrTG9naWNhbFJlc291cmNlSWQnLFxuICAgICAgICAgICAgICAgIHBoeXNpY2FsUmVzb3VyY2VJZDogJ25lc3RlZFN0YWNrUGh5c2ljYWxSZXNvdXJjZUlkJyxcbiAgICAgICAgICAgICAgICByZXNvdXJjZVR5cGU6ICdBV1M6OkNsb3VkRm9ybWF0aW9uOjpTdGFjaycsXG4gICAgICAgICAgICAgICAgcmVzb3VyY2VTdGF0dXNSZWFzb246ICduZXN0ZWQgc3RhY2sgc3RhdHVzIHJlYXNvbicsXG4gICAgICAgICAgICAgICAgcmVzb3VyY2VTdGF0dXM6ICdDUkVBVEVfQ09NUExFVEUnLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICBdLFxuICAgICAgICB9O1xuICAgICAgfSxcbiAgICBdKTtcblxuICAgIGV4cGVjdChtb25pdG9yLmVycm9ycykudG9TdHJpY3RFcXVhbChbXSk7XG4gIH0pO1xufSk7XG5cbmNvbnN0IFQwID0gMTU5NzgzNzIzMDUwNDtcblxuLy8gRXZlbnRzIDAtOTkgYXJlIGJlZm9yZSB3ZSBzdGFydGVkIHBheWluZyBhdHRlbnRpb25cbmNvbnN0IFQxMDAgPSBUMCArIDEwMCAqIDEwMDA7XG5cbmZ1bmN0aW9uIGV2ZW50KG5yOiBudW1iZXIpOiBBV1MuQ2xvdWRGb3JtYXRpb24uU3RhY2tFdmVudCB7XG4gIHJldHVybiB7XG4gICAgRXZlbnRJZDogYCR7bnJ9YCxcbiAgICBTdGFja0lkOiAnU3RhY2tJZCcsXG4gICAgU3RhY2tOYW1lOiAnU3RhY2tOYW1lJyxcbiAgICBUaW1lc3RhbXA6IG5ldyBEYXRlKFQwICsgbnIgKiAxMDAwKSxcbiAgfTtcbn1cblxuZnVuY3Rpb24gYWRkRXJyb3JUb1N0YWNrRXZlbnQoXG4gIGV2ZW50VG9VcGRhdGU6IEFXUy5DbG91ZEZvcm1hdGlvbi5TdGFja0V2ZW50LFxuICBwcm9wczoge1xuICAgIHJlc291cmNlU3RhdHVzPzogc3RyaW5nO1xuICAgIHJlc291cmNlVHlwZT86IHN0cmluZztcbiAgICByZXNvdXJjZVN0YXR1c1JlYXNvbj86IHN0cmluZztcbiAgICBsb2dpY2FsUmVzb3VyY2VJZD86IHN0cmluZztcbiAgICBwaHlzaWNhbFJlc291cmNlSWQ/OiBzdHJpbmc7XG4gIH0gPSB7fSxcbik6IEFXUy5DbG91ZEZvcm1hdGlvbi5TdGFja0V2ZW50IHtcbiAgZXZlbnRUb1VwZGF0ZS5SZXNvdXJjZVN0YXR1cyA9IHByb3BzLnJlc291cmNlU3RhdHVzID8/ICdVUERBVEVfRkFJTEVEJztcbiAgZXZlbnRUb1VwZGF0ZS5SZXNvdXJjZVR5cGUgPSBwcm9wcy5yZXNvdXJjZVR5cGUgPz8gJ1Rlc3Q6OlJlc291cmNlOjpUeXBlJztcbiAgZXZlbnRUb1VwZGF0ZS5SZXNvdXJjZVN0YXR1c1JlYXNvbiA9IHByb3BzLnJlc291cmNlU3RhdHVzUmVhc29uID8/ICdUZXN0IEVycm9yJztcbiAgZXZlbnRUb1VwZGF0ZS5Mb2dpY2FsUmVzb3VyY2VJZCA9IHByb3BzLmxvZ2ljYWxSZXNvdXJjZUlkID8/ICd0ZXN0TG9naWNhbElkJztcbiAgZXZlbnRUb1VwZGF0ZS5QaHlzaWNhbFJlc291cmNlSWQgPSBwcm9wcy5waHlzaWNhbFJlc291cmNlSWQgPz8gJ3Rlc3RQaHlzaWNhbFJlc291cmNlSWQnO1xuICByZXR1cm4gZXZlbnRUb1VwZGF0ZTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gdGVzdE1vbml0b3JXaXRoRXZlbnRDYWxscyhcbiAgYmVmb3JlU3RvcEludm9jYXRpb25zOiBBcnJheTwoeDogQVdTLkNsb3VkRm9ybWF0aW9uLkRlc2NyaWJlU3RhY2tFdmVudHNJbnB1dCkgPT4gQVdTLkNsb3VkRm9ybWF0aW9uLkRlc2NyaWJlU3RhY2tFdmVudHNPdXRwdXQ+LFxuICBhZnRlclN0b3BJbnZvY2F0aW9uczogQXJyYXk8KHg6IEFXUy5DbG91ZEZvcm1hdGlvbi5EZXNjcmliZVN0YWNrRXZlbnRzSW5wdXQpID0+IEFXUy5DbG91ZEZvcm1hdGlvbi5EZXNjcmliZVN0YWNrRXZlbnRzT3V0cHV0PiA9IFtdLFxuKTogUHJvbWlzZTxTdGFja0FjdGl2aXR5TW9uaXRvcj4ge1xuICBsZXQgZGVzY3JpYmVTdGFja0V2ZW50cyA9IChqZXN0LmZuKCkgYXMgamVzdC5Nb2NrPEFXUy5DbG91ZEZvcm1hdGlvbi5EZXNjcmliZVN0YWNrRXZlbnRzT3V0cHV0LCBbQVdTLkNsb3VkRm9ybWF0aW9uLkRlc2NyaWJlU3RhY2tFdmVudHNJbnB1dF0+KTtcblxuICBsZXQgZmluaXNoZWQgPSBmYWxzZTtcbiAgbGV0IGVycm9yOiBFcnJvciB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcblxuICBmb3IgKGNvbnN0IGludm9jYXRpb24gb2YgYmVmb3JlU3RvcEludm9jYXRpb25zKSB7XG4gICAgY29uc3QgaW52b2NhdGlvbl8gPSBpbnZvY2F0aW9uOyAvLyBDYXB0dXJlIGxvb3AgdmFyaWFibGUgaW4gbG9jYWwgYmVjYXVzZSBvZiBjbG9zdXJlIHNlbWFudGljc1xuICAgIGNvbnN0IGlzTGFzdCA9IGludm9jYXRpb24gPT09IGJlZm9yZVN0b3BJbnZvY2F0aW9uc1tiZWZvcmVTdG9wSW52b2NhdGlvbnMubGVuZ3RoIC0gMV07XG4gICAgZGVzY3JpYmVTdGFja0V2ZW50cyA9IGRlc2NyaWJlU3RhY2tFdmVudHMubW9ja0ltcGxlbWVudGF0aW9uT25jZShyZXF1ZXN0ID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHJldCA9IGludm9jYXRpb25fKHJlcXVlc3QpO1xuICAgICAgICBpZiAoaXNMYXN0KSB7XG4gICAgICAgICAgZmluaXNoZWQgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXQ7XG4gICAgICB9IGNhdGNoIChlOiBhbnkpIHtcbiAgICAgICAgZmluaXNoZWQgPSB0cnVlO1xuICAgICAgICBlcnJvciA9IGU7XG4gICAgICAgIHRocm93IGU7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbiAgaWYgKGVycm9yKSB7XG4gICAgdGhyb3cgZXJyb3I7XG4gIH1cbiAgZm9yIChjb25zdCBpbnZvY2F0aW9uIG9mIGFmdGVyU3RvcEludm9jYXRpb25zKSB7XG4gICAgZGVzY3JpYmVTdGFja0V2ZW50cyA9IGRlc2NyaWJlU3RhY2tFdmVudHMubW9ja0ltcGxlbWVudGF0aW9uT25jZShpbnZvY2F0aW9uKTtcbiAgfVxuICBkZXNjcmliZVN0YWNrRXZlbnRzLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiB7IHJldHVybiB7fTsgfSk7XG5cbiAgc2RrLnN0dWJDbG91ZEZvcm1hdGlvbih7IGRlc2NyaWJlU3RhY2tFdmVudHMgfSk7XG5cbiAgY29uc3QgbW9uaXRvciA9IG5ldyBTdGFja0FjdGl2aXR5TW9uaXRvcihzZGsuY2xvdWRGb3JtYXRpb24oKSwgJ1N0YWNrTmFtZScsIHByaW50ZXIsIHVuZGVmaW5lZCwgbmV3IERhdGUoVDEwMCkpLnN0YXJ0KCk7XG4gIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oKCkgPT4gZmluaXNoZWQpO1xuICBhd2FpdCBtb25pdG9yLnN0b3AoKTtcbiAgcmV0dXJuIG1vbml0b3I7XG59XG5cbmNsYXNzIEZha2VQcmludGVyIGltcGxlbWVudHMgSUFjdGl2aXR5UHJpbnRlciB7XG4gIHB1YmxpYyB1cGRhdGVTbGVlcDogbnVtYmVyID0gMDtcbiAgcHVibGljIHJlYWRvbmx5IGFjdGl2aXRpZXM6IFN0YWNrQWN0aXZpdHlbXSA9IFtdO1xuXG4gIHB1YmxpYyBnZXQgZXZlbnRJZHMoKSB7XG4gICAgcmV0dXJuIHRoaXMuYWN0aXZpdGllcy5tYXAoYSA9PiBhLmV2ZW50LkV2ZW50SWQpO1xuICB9XG5cbiAgcHVibGljIGFkZEFjdGl2aXR5KGFjdGl2aXR5OiBTdGFja0FjdGl2aXR5KTogdm9pZCB7XG4gICAgdGhpcy5hY3Rpdml0aWVzLnB1c2goYWN0aXZpdHkpO1xuICB9XG5cbiAgcHVibGljIHByaW50KCk6IHZvaWQgeyB9XG4gIHB1YmxpYyBzdGFydCgpOiB2b2lkIHsgfVxuICBwdWJsaWMgc3RvcCgpOiB2b2lkIHsgfVxufVxuXG5hc3luYyBmdW5jdGlvbiB3YWl0Rm9yQ29uZGl0aW9uKGNiOiAoKSA9PiBib29sZWFuKTogUHJvbWlzZTx2b2lkPiB7XG4gIHdoaWxlICghY2IoKSkge1xuICAgIGF3YWl0IHNsZWVwKDEwKTtcbiAgfVxufVxuIl19