import { AmplifyFormRenderer, ModuleKind, ReactIndexStudioTemplateRenderer, ReactUtilsStudioTemplateRenderer, ScriptKind, ScriptTarget, getDeclarationFilename, } from '@aws-amplify/codegen-ui-react';
/**
 * Generates GraphQL-compatible forms in React by directly leveraging @aws-amplify/codegen-ui-react
 */
export class LocalGraphqlFormGenerator {
    schemaFetcher;
    renderOptions;
    resultBuilder;
    static defaultConfig = {
        module: ModuleKind.ES2020,
        target: ScriptTarget.ES2020,
        script: ScriptKind.JSX,
        renderTypeDeclarations: true,
    };
    /**
     * Instantiates a LocalGraphqlFormGenerator for a provided schema
     */
    constructor(schemaFetcher, renderOptions, resultBuilder) {
        this.schemaFetcher = schemaFetcher;
        this.renderOptions = renderOptions;
        this.resultBuilder = resultBuilder;
    }
    /**
     * Gets the react render config
     */
    get config() {
        return {
            module: ModuleKind.ES2020,
            target: ScriptTarget.ES2020,
            script: ScriptKind.JSX,
            includeUseClientDirective: true,
            renderTypeDeclarations: true,
            apiConfiguration: {
                dataApi: 'GraphQL',
                fragmentsFilePath: this.renderGraphqlPath('fragments'),
                mutationsFilePath: this.renderGraphqlPath('mutations'),
                queriesFilePath: this.renderGraphqlPath('queries'),
                subscriptionsFilePath: this.renderGraphqlPath('subscriptions'),
                typesFilePath: this.renderGraphqlPath('types'),
            },
            dependencies: {
                // Tell the renderer to generate amplify js v6 compatible code
                'aws-amplify': '^6.0.0',
            },
        };
    }
    generateIndexFile = (schemas) => {
        const { componentText, fileName } = this.createIndexFile(schemas);
        return {
            schemaName: 'AmplifyStudioIndexFile',
            componentText,
            fileName,
            declaration: undefined,
            error: undefined,
        };
    };
    generateForms = async (options) => {
        const dataSchema = await this.schemaFetcher();
        const filteredModels = this.getFilteredModels(dataSchema, options?.models);
        const filteredSchema = this.transformModelListToMap(filteredModels);
        const utilFile = this.generateUtilFile();
        const baseForms = this.generateBaseForms(filteredSchema);
        const indexFile = this.generateIndexFile(baseForms.map(({ name }) => ({
            name,
        })));
        dataSchema.models = Object.entries(dataSchema.models).reduce((prev, [key, value]) => {
            prev[key] = value;
            return prev;
        }, {});
        const forms = baseForms.reduce((prev, formSchema) => {
            const results = this.codegenForm(dataSchema, formSchema);
            results.forEach((result) => {
                prev[result.fileName] = result.componentText;
            });
            return prev;
        }, {});
        forms[utilFile.fileName] = utilFile.componentText;
        forms[indexFile.fileName] = indexFile.componentText;
        return this.resultBuilder(forms);
    };
    /**
     * reduces the dataSchema to a map of models
     */
    getModelMapForDataSchema = (dataSchema) => {
        return Object.entries(dataSchema.models).reduce((prev, [name, model]) => {
            if (!model.isJoinTable) {
                prev[name] = new Set(['create', 'update']);
            }
            return prev;
        }, {});
    };
    getSchema = (name, type) => ({
        name: `${name}${type === 'create' ? 'CreateForm' : 'UpdateForm'}`,
        formActionType: type,
        dataType: { dataSourceType: 'DataStore', dataTypeName: name },
        fields: {},
        sectionalElements: {},
        style: {},
        cta: {},
    });
    generateBaseForms = (modelMap) => {
        const schemas = [];
        Object.entries(modelMap).forEach(([name, set]) => {
            set.forEach((type) => schemas.push(this.getSchema(name, type)));
        });
        return schemas;
    };
    renderGraphqlPath = (submodule) => {
        const graphqlPath = `${this.renderOptions.graphqlDir}/${submodule}`;
        // if the path does not start with a leading ./ or ../, assume that the graphql folder is in the same directory relative to the ui, and prepend a `./`
        if (graphqlPath.startsWith('.')) {
            return graphqlPath;
        }
        return `./${graphqlPath}`;
    };
    createUiBuilderForm = (schema, dataSchema, formFeatureFlags) => {
        const renderer = new AmplifyFormRenderer(schema, dataSchema, this.config, formFeatureFlags);
        const { componentText, declaration } = renderer.renderComponentInternal();
        const files = [
            {
                componentText,
                fileName: renderer.fileName,
            },
        ];
        if (declaration) {
            files.push({
                componentText: declaration,
                fileName: getDeclarationFilename(renderer.fileName),
            });
        }
        return files;
    };
    filterModelsByName = (filteredModelNames, schemaModel) => {
        const lowerCaseModelKeys = new Set(Object.keys(schemaModel).map((k) => k.toLowerCase()));
        const modelEntries = Object.entries(schemaModel);
        return filteredModelNames.reduce((prev, model) => {
            if (lowerCaseModelKeys?.has(model.toLowerCase())) {
                const entry = modelEntries.find(([key]) => key.toLowerCase() === model.toLowerCase());
                if (!entry) {
                    // eslint-disable-next-line amplify-backend-rules/prefer-amplify-errors
                    throw new Error(`Could not find specified model ${model}`);
                }
                prev.push(entry);
                return prev;
            }
            // eslint-disable-next-line amplify-backend-rules/prefer-amplify-errors
            throw new Error(`Could not find specified model ${model}`);
        }, []);
    };
    codegenForm = (dataSchema, formSchema) => {
        return this.createUiBuilderForm(formSchema, dataSchema, {});
    };
    getFilteredModels = (dataSchema, filteredModelNames) => {
        const modelMap = this.getModelMapForDataSchema(dataSchema);
        const filteredModels = [];
        if (!filteredModelNames || !filteredModelNames?.length) {
            filteredModels.push(...Object.entries(modelMap));
        }
        else {
            filteredModels.push(...this.filterModelsByName(filteredModelNames, modelMap));
        }
        return filteredModels;
    };
    transformModelListToMap = (models) => {
        return models.reduce((prev, [key, value]) => ({ ...prev, [key]: value }), {});
    };
    createUtilFile = (utils) => {
        const renderer = new ReactUtilsStudioTemplateRenderer(utils, this.config);
        const { componentText } = renderer.renderComponentInternal();
        return {
            componentText,
            fileName: renderer.fileName,
        };
    };
    /**
     * Return utils file text
     */
    generateUtilFile = () => {
        const utils = [
            'validation',
            'formatter',
            'fetchByPath',
            'processFile',
        ];
        const { componentText, fileName } = this.createUtilFile(utils);
        return {
            schemaName: 'AmplifyStudioUtilFile',
            componentText,
            fileName,
            declaration: undefined,
            error: undefined,
        };
    };
    createIndexFile = (schemas) => {
        const renderer = new ReactIndexStudioTemplateRenderer(schemas, LocalGraphqlFormGenerator.defaultConfig);
        const { componentText } = renderer.renderComponentInternal();
        return {
            componentText,
            fileName: renderer.fileName,
        };
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9jYWxfY29kZWdlbl9ncmFwaHFsX2Zvcm1fZ2VuZXJhdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2xvY2FsX2NvZGVnZW5fZ3JhcGhxbF9mb3JtX2dlbmVyYXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFNQSxPQUFPLEVBQ0wsbUJBQW1CLEVBQ25CLFVBQVUsRUFDVixnQ0FBZ0MsRUFFaEMsZ0NBQWdDLEVBQ2hDLFVBQVUsRUFDVixZQUFZLEVBRVosc0JBQXNCLEdBQ3ZCLE1BQU0sK0JBQStCLENBQUM7QUFzQnZDOztHQUVHO0FBQ0gsTUFBTSxPQUFPLHlCQUF5QjtJQVkxQjtJQUNBO0lBQ0E7SUFiRixNQUFNLENBQUMsYUFBYSxHQUFHO1FBQzdCLE1BQU0sRUFBRSxVQUFVLENBQUMsTUFBTTtRQUN6QixNQUFNLEVBQUUsWUFBWSxDQUFDLE1BQU07UUFDM0IsTUFBTSxFQUFFLFVBQVUsQ0FBQyxHQUFHO1FBQ3RCLHNCQUFzQixFQUFFLElBQUk7S0FDN0IsQ0FBQztJQUVGOztPQUVHO0lBQ0gsWUFDVSxhQUE0QixFQUM1QixhQUE0QixFQUM1QixhQUE0QjtRQUY1QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM1QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM1QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtJQUNuQyxDQUFDO0lBRUo7O09BRUc7SUFDSCxJQUFZLE1BQU07UUFDaEIsT0FBTztZQUNMLE1BQU0sRUFBRSxVQUFVLENBQUMsTUFBTTtZQUN6QixNQUFNLEVBQUUsWUFBWSxDQUFDLE1BQU07WUFDM0IsTUFBTSxFQUFFLFVBQVUsQ0FBQyxHQUFHO1lBQ3RCLHlCQUF5QixFQUFFLElBQUk7WUFDL0Isc0JBQXNCLEVBQUUsSUFBSTtZQUM1QixnQkFBZ0IsRUFBRTtnQkFDaEIsT0FBTyxFQUFFLFNBQVM7Z0JBQ2xCLGlCQUFpQixFQUFFLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLENBQUM7Z0JBQ3RELGlCQUFp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QUFHLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDL0QsT0FBTztZQUNMLFVBQVUsRUFBRSx1QkFBdUI7WUFDbkMsYUFBYTtZQUNiLFFBQVE7WUFDUixXQUFXLEVBQUUsU0FBUztZQUN0QixLQUFLLEVBQUUsU0FBUztTQUNqQixDQUFDO0lBQ0osQ0FBQyxDQUFDO0lBRU0sZUFBZSxHQUFHLENBQUMsT0FBdUIsRUFBRSxFQUFFO1FBQ3BELE1BQU0sUUFBUSxHQUFHLElBQUksZ0NBQWdDLENBQ25ELE9BQU8sRUFDUCx5QkFBeUIsQ0FBQyxhQUFhLENBQ3hDLENBQUM7UUFDRixNQUFNLEVBQUUsYUFBYSxFQUFFLEdBQUcsUUFBUSxDQUFDLHVCQUF1QixFQUFFLENBQUM7UUFDN0QsT0FBTztZQUNMLGFBQWE7WUFDYixRQUFRLEVBQUUsUUFBUSxDQUFDLFFBQVE7U0FDNUIsQ0FBQztJQUNKLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEZvcm1GZWF0dXJlRmxhZ3MsXG4gIEdlbmVyaWNEYXRhU2NoZW1hLFxuICBTdHVkaW9Gb3JtLFxuICBTdHVkaW9TY2hlbWEsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9jb2RlZ2VuLXVpJztcbmltcG9ydCB7XG4gIEFtcGxpZnlGb3JtUmVuZGVyZXIsXG4gIE1vZHVsZUtpbmQsXG4gIFJlYWN0SW5kZXhTdHVkaW9UZW1wbGF0ZVJlbmRlcmVyLFxuICBSZWFjdFJlbmRlckNvbmZpZyxcbiAgUmVhY3RVdGlsc1N0dWRpb1RlbXBsYXRlUmVuZGVyZXIsXG4gIFNjcmlwdEtpbmQsXG4gIFNjcmlwdFRhcmdldCxcbiAgVXRpbFRlbXBsYXRlVHlwZSxcbiAgZ2V0RGVjbGFyYXRpb25GaWxlbmFtZSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2NvZGVnZW4tdWktcmVhY3QnO1xuaW1wb3J0IHtcbiAgRm9ybUdlbmVyYXRpb25PcHRpb25zLFxuICBHcmFwaHFsRm9ybUdlbmVyYXRvcixcbiAgR3JhcGhxbEdlbmVyYXRpb25SZXN1bHQsXG59IGZyb20gJy4vZ3JhcGhxbF9mb3JtX2dlbmVyYXRvci5qcyc7XG5cbnR5cGUgRm9ybURlZiA9IFNldDwnY3JlYXRlJyB8ICd1cGRhdGUnPjtcbnR5cGUgTW9kZWxSZWNvcmQgPSBSZWNvcmQ8c3RyaW5nLCBGb3JtRGVmPjtcblxuLyoqXG4gKiBSZW5kZXIgQ29uZmlndXJhdGlvbiBPcHRpb25zIGZvciByZWFjdCBmb3Jtc1xuICovXG5leHBvcnQgdHlwZSBSZW5kZXJPcHRpb25zID0ge1xuICBncmFwaHFsRGlyOiBzdHJpbmc7XG59O1xuXG5leHBvcnQgdHlwZSBSZXN1bHRCdWlsZGVyID0gKFxuICBmaWxlTWFwOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+XG4pID0+IEdyYXBocWxHZW5lcmF0aW9uUmVzdWx0O1xuXG5leHBvcnQgdHlwZSBTY2hlbWFGZXRjaGVyID0gKCkgPT4gUHJvbWlzZTxHZW5lcmljRGF0YVNjaGVtYT47XG4vKipcbiAqIEdlbmVyYXRlcyBHcmFwaFFMLWNvbXBhdGlibGUgZm9ybXMgaW4gUmVhY3QgYnkgZGlyZWN0bHkgbGV2ZXJhZ2luZyBAYXdzLWFtcGxpZnkvY29kZWdlbi11aS1yZWFjdFxuICovXG5leHBvcnQgY2xhc3MgTG9jYWxHcmFwaHFsRm9ybUdlbmVyYXRvciBpbXBsZW1lbnRzIEdyYXBocWxGb3JtR2VuZXJhdG9yIHtcbiAgcHJpdmF0ZSBzdGF0aWMgZGVmYXVsdENvbmZpZyA9IHtcbiAgICBtb2R1bGU6IE1vZHVsZUtpbmQuRVMyMDIwLFxuICAgIHRhcmdldDogU2NyaXB0VGFyZ2V0LkVTMjAyMCxcbiAgICBzY3JpcHQ6IFNjcmlwdEtpbmQuSlNYLFxuICAgIHJlbmRlclR5cGVEZWNsYXJhdGlvbnM6IHRydWUsXG4gIH07XG5cbiAgLyoqXG4gICAqIEluc3RhbnRpYXRlcyBhIExvY2FsR3JhcGhxbEZvcm1HZW5lcmF0b3IgZm9yIGEgcHJvdmlkZWQgc2NoZW1hXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHNjaGVtYUZldGNoZXI6IFNjaGVtYUZldGNoZXIsXG4gICAgcHJpdmF0ZSByZW5kZXJPcHRpb25zOiBSZW5kZXJPcHRpb25zLFxuICAgIHByaXZhdGUgcmVzdWx0QnVpbGRlcjogUmVzdWx0QnVpbGRlclxuICApIHt9XG5cbiAgLyoqXG4gICAqIEdldHMgdGhlIHJlYWN0IHJlbmRlciBjb25maWdcbiAgICovXG4gIHByaXZhdGUgZ2V0IGNvbmZpZygpOiBSZWFjdFJlbmRlckNvbmZpZyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG1vZHVsZTogTW9kdWxlS2luZC5FUzIwMjAsXG4gICAgICB0YXJnZXQ6IFNjcmlwdFRhcmdldC5FUzIwMjAsXG4gICAgICBzY3JpcHQ6IFNjcmlwdEtpbmQuSlNYLFxuICAgICAgaW5jbHVkZVVzZUNsaWVudERpcmVjdGl2ZTogdHJ1ZSxcbiAgICAgIHJlbmRlclR5cGVEZWNsYXJhdGlvbnM6IHRydWUsXG4gICAgICBhcGlDb25maWd1cmF0aW9uOiB7XG4gICAgICAgIGRhdGFBcGk6ICdHcmFwaFFMJyxcbiAgICAgICAgZnJhZ21lbnRzRmlsZVBhdGg6IHRoaXMucmVuZGVyR3JhcGhxbFBhdGgoJ2ZyYWdtZW50cycpLFxuICAgICAgICBtdXRhdGlvbnNGaWxlUGF0aDogdGhpcy5yZW5kZXJHcmFwaHFsUGF0aCgnbXV0YXRpb25zJyksXG4gICAgICAgIHF1ZXJpZXNGaWxlUGF0aDogdGhpcy5yZW5kZXJHcmFwaHFsUGF0aCgncXVlcmllcycpLFxuICAgICAgICBzdWJzY3JpcHRpb25zRmlsZVBhdGg6IHRoaXMucmVuZGVyR3JhcGhxbFBhdGgoJ3N1YnNjcmlwdGlvbnMnKSxcbiAgICAgICAgdHlwZXNGaWxlUGF0aDogdGhpcy5yZW5kZXJHcmFwaHFsUGF0aCgndHlwZXMnKSxcbiAgICAgIH0sXG4gICAgICBkZXBlbmRlbmNpZXM6IHtcbiAgICAgICAgLy8gVGVsbCB0aGUgcmVuZGVyZXIgdG8gZ2VuZXJhdGUgYW1wbGlmeSBqcyB2NiBjb21wYXRpYmxlIGNvZGVcbiAgICAgICAgJ2F3cy1hbXBsaWZ5JzogJ142LjAuMCcsXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBnZW5lcmF0ZUluZGV4RmlsZSA9IChzY2hlbWFzOiB7IG5hbWU6IHN0cmluZyB9W10pID0+IHtcbiAgICBjb25zdCB7IGNvbXBvbmVudFRleHQsIGZpbGVOYW1lIH0gPSB0aGlzLmNyZWF0ZUluZGV4RmlsZShcbiAgICAgIHNjaGVtYXMgYXMgU3R1ZGlvU2NoZW1hW11cbiAgICApO1xuICAgIHJldHVybiB7XG4gICAgICBzY2hlbWFOYW1lOiAnQW1wbGlmeVN0dWRpb0luZGV4RmlsZScsXG4gICAgICBjb21wb25lbnRUZXh0LFxuICAgICAgZmlsZU5hbWUsXG4gICAgICBkZWNsYXJhdGlvbjogdW5kZWZpbmVkLFxuICAgICAgZXJyb3I6IHVuZGVmaW5lZCxcbiAgICB9O1xuICB9O1xuXG4gIGdlbmVyYXRlRm9ybXMgPSBhc3luYyAoXG4gICAgb3B0aW9ucz86IEZvcm1HZW5lcmF0aW9uT3B0aW9uc1xuICApOiBQcm9taXNlPEdyYXBocWxHZW5lcmF0aW9uUmVzdWx0PiA9PiB7XG4gICAgY29uc3QgZGF0YVNjaGVtYSA9IGF3YWl0IHRoaXMuc2NoZW1hRmV0Y2hlcigpO1xuICAgIGNvbnN0IGZpbHRlcmVkTW9kZWxzID0gdGhpcy5nZXRGaWx0ZXJlZE1vZGVscyhkYXRhU2NoZW1hLCBvcHRpb25zPy5tb2RlbHMpO1xuICAgIGNvbnN0IGZpbHRlcmVkU2NoZW1hID0gdGhpcy50cmFuc2Zvcm1Nb2RlbExpc3RUb01hcChmaWx0ZXJlZE1vZGVscyk7XG4gICAgY29uc3QgdXRpbEZpbGUgPSB0aGlzLmdlbmVyYXRlVXRpbEZpbGUoKTtcbiAgICBjb25zdCBiYXNlRm9ybXMgPSB0aGlzLmdlbmVyYXRlQmFzZUZvcm1zKGZpbHRlcmVkU2NoZW1hKTtcbiAgICBjb25zdCBpbmRleEZpbGUgPSB0aGlzLmdlbmVyYXRlSW5kZXhGaWxlKFxuICAgICAgYmFzZUZvcm1zLm1hcCgoeyBuYW1lIH0pID0+ICh7XG4gICAgICAgIG5hbWUsXG4gICAgICB9KSlcbiAgICApO1xuXG4gICAgZGF0YVNjaGVtYS5tb2RlbHMgPSBPYmplY3QuZW50cmllcyhkYXRhU2NoZW1hLm1vZGVscykucmVkdWNlPFxuICAgICAgKHR5cGVvZiBkYXRhU2NoZW1hKVsnbW9kZWxzJ11cbiAgICA+KChwcmV2LCBba2V5LCB2YWx1ZV0pID0+IHtcbiAgICAgIHByZXZba2V5XSA9IHZhbHVlO1xuXG4gICAgICByZXR1cm4gcHJldjtcbiAgICB9LCB7fSk7XG5cbiAgICBjb25zdCBmb3JtcyA9IGJhc2VGb3Jtcy5yZWR1Y2U8UmVjb3JkPHN0cmluZywgc3RyaW5nPj4oXG4gICAgICAocHJldiwgZm9ybVNjaGVtYSkgPT4ge1xuICAgICAgICBjb25zdCByZXN1bHRzID0gdGhpcy5jb2RlZ2VuRm9ybShkYXRhU2NoZW1hLCBmb3JtU2NoZW1hKTtcbiAgICAgICAgcmVzdWx0cy5mb3JFYWNoKChyZXN1bHQpID0+IHtcbiAgICAgICAgICBwcmV2W3Jlc3VsdC5maWxlTmFtZV0gPSByZXN1bHQuY29tcG9uZW50VGV4dDtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBwcmV2O1xuICAgICAgfSxcbiAgICAgIHt9XG4gICAgKTtcbiAgICBmb3Jtc1t1dGlsRmlsZS5maWxlTmFtZV0gPSB1dGlsRmlsZS5jb21wb25lbnRUZXh0O1xuICAgIGZvcm1zW2luZGV4RmlsZS5maWxlTmFtZV0gPSBpbmRleEZpbGUuY29tcG9uZW50VGV4dDtcbiAgICByZXR1cm4gdGhpcy5yZXN1bHRCdWlsZGVyKGZvcm1zKTtcbiAgfTtcblxuICAvKipcbiAgICogcmVkdWNlcyB0aGUgZGF0YVNjaGVtYSB0byBhIG1hcCBvZiBtb2RlbHNcbiAgICovXG4gIHByaXZhdGUgZ2V0TW9kZWxNYXBGb3JEYXRhU2NoZW1hID0gKGRhdGFTY2hlbWE6IEdlbmVyaWNEYXRhU2NoZW1hKSA9PiB7XG4gICAgcmV0dXJuIE9iamVjdC5lbnRyaWVzKGRhdGFTY2hlbWEubW9kZWxzKS5yZWR1Y2U8TW9kZWxSZWNvcmQ+KFxuICAgICAgKHByZXYsIFtuYW1lLCBtb2RlbF0pID0+IHtcbiAgICAgICAgaWYgKCFtb2RlbC5pc0pvaW5UYWJsZSkge1xuICAgICAgICAgIHByZXZbbmFtZV0gPSBuZXcgU2V0KFsnY3JlYXRlJywgJ3VwZGF0ZSddKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcHJldjtcbiAgICAgIH0sXG4gICAgICB7fVxuICAgICk7XG4gIH07XG5cbiAgcHJpdmF0ZSBnZXRTY2hlbWEgPSAoXG4gICAgbmFtZTogc3RyaW5nLFxuICAgIHR5cGU6ICdjcmVhdGUnIHwgJ3VwZGF0ZSdcbiAgKTogU3R1ZGlvRm9ybSA9PiAoe1xuICAgIG5hbWU6IGAke25hbWV9JHt0eXBlID09PSAnY3JlYXRlJyA/ICdDcmVhdGVGb3JtJyA6ICdVcGRhdGVGb3JtJ31gLFxuICAgIGZvcm1BY3Rpb25UeXBlOiB0eXBlLFxuICAgIGRhdGFUeXBlOiB7IGRhdGFTb3VyY2VUeXBlOiAnRGF0YVN0b3JlJywgZGF0YVR5cGVOYW1lOiBuYW1lIH0sXG4gICAgZmllbGRzOiB7fSxcbiAgICBzZWN0aW9uYWxFbGVtZW50czoge30sXG4gICAgc3R5bGU6IHt9LFxuICAgIGN0YToge30sXG4gIH0pO1xuXG4gIHByaXZhdGUgZ2VuZXJhdGVCYXNlRm9ybXMgPSAobW9kZWxNYXA6IHtcbiAgICBbbW9kZWw6IHN0cmluZ106IFNldDwnY3JlYXRlJyB8ICd1cGRhdGUnPjtcbiAgfSk6IFN0dWRpb0Zvcm1bXSA9PiB7XG4gICAgY29uc3Qgc2NoZW1hczogU3R1ZGlvRm9ybVtdID0gW107XG4gICAgT2JqZWN0LmVudHJpZXMobW9kZWxNYXApLmZvckVhY2goKFtuYW1lLCBzZXRdKSA9PiB7XG4gICAgICBzZXQuZm9yRWFjaCgodHlwZSkgPT4gc2NoZW1hcy5wdXNoKHRoaXMuZ2V0U2NoZW1hKG5hbWUsIHR5cGUpKSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHNjaGVtYXM7XG4gIH07XG5cbiAgcHJpdmF0ZSByZW5kZXJHcmFwaHFsUGF0aCA9IChcbiAgICBzdWJtb2R1bGU6ICdmcmFnbWVudHMnIHwgJ211dGF0aW9ucycgfCAncXVlcmllcycgfCAndHlwZXMnIHwgJ3N1YnNjcmlwdGlvbnMnXG4gICkgPT4ge1xuICAgIGNvbnN0IGdyYXBocWxQYXRoID0gYCR7dGhpcy5yZW5kZXJPcHRpb25zLmdyYXBocWxEaXJ9LyR7c3VibW9kdWxlfWA7XG4gICAgLy8gaWYgdGhlIHBhdGggZG9lcyBub3Qgc3RhcnQgd2l0aCBhIGxlYWRpbmcgLi8gb3IgLi4vLCBhc3N1bWUgdGhhdCB0aGUgZ3JhcGhxbCBmb2xkZXIgaXMgaW4gdGhlIHNhbWUgZGlyZWN0b3J5IHJlbGF0aXZlIHRvIHRoZSB1aSwgYW5kIHByZXBlbmQgYSBgLi9gXG4gICAgaWYgKGdyYXBocWxQYXRoLnN0YXJ0c1dpdGgoJy4nKSkge1xuICAgICAgcmV0dXJuIGdyYXBocWxQYXRoO1xuICAgIH1cbiAgICByZXR1cm4gYC4vJHtncmFwaHFsUGF0aH1gO1xuICB9O1xuXG4gIHByaXZhdGUgY3JlYXRlVWlCdWlsZGVyRm9ybSA9IChcbiAgICBzY2hlbWE6IFN0dWRpb0Zvcm0sXG4gICAgZGF0YVNjaGVtYT86IEdlbmVyaWNEYXRhU2NoZW1hLFxuICAgIGZvcm1GZWF0dXJlRmxhZ3M/OiBGb3JtRmVhdHVyZUZsYWdzXG4gICkgPT4ge1xuICAgIGNvbnN0IHJlbmRlcmVyID0gbmV3IEFtcGxpZnlGb3JtUmVuZGVyZXIoXG4gICAgICBzY2hlbWEsXG4gICAgICBkYXRhU2NoZW1hLFxuICAgICAgdGhpcy5jb25maWcsXG4gICAgICBmb3JtRmVhdHVyZUZsYWdzXG4gICAgKTtcbiAgICBjb25zdCB7IGNvbXBvbmVudFRleHQsIGRlY2xhcmF0aW9uIH0gPSByZW5kZXJlci5yZW5kZXJDb21wb25lbnRJbnRlcm5hbCgpO1xuICAgIGNvbnN0IGZpbGVzID0gW1xuICAgICAge1xuICAgICAgICBjb21wb25lbnRUZXh0LFxuICAgICAgICBmaWxlTmFtZTogcmVuZGVyZXIuZmlsZU5hbWUsXG4gICAgICB9LFxuICAgIF07XG4gICAgaWYgKGRlY2xhcmF0aW9uKSB7XG4gICAgICBmaWxlcy5wdXNoKHtcbiAgICAgICAgY29tcG9uZW50VGV4dDogZGVjbGFyYXRpb24sXG4gICAgICAgIGZpbGVOYW1lOiBnZXREZWNsYXJhdGlvbkZpbGVuYW1lKHJlbmRlcmVyLmZpbGVOYW1lKSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBmaWxlcztcbiAgfTtcbiAgcHJpdmF0ZSBmaWx0ZXJNb2RlbHNCeU5hbWUgPSAoXG4gICAgZmlsdGVyZWRNb2RlbE5hbWVzOiBzdHJpbmdbXSxcbiAgICBzY2hlbWFNb2RlbDogTW9kZWxSZWNvcmRcbiAgKSA9PiB7XG4gICAgY29uc3QgbG93ZXJDYXNlTW9kZWxLZXlzID0gbmV3IFNldChcbiAgICAgIE9iamVjdC5rZXlzKHNjaGVtYU1vZGVsKS5tYXAoKGspID0+IGsudG9Mb3dlckNhc2UoKSlcbiAgICApO1xuICAgIGNvbnN0IG1vZGVsRW50cmllcyA9IE9iamVjdC5lbnRyaWVzKHNjaGVtYU1vZGVsKTtcbiAgICByZXR1cm4gZmlsdGVyZWRNb2RlbE5hbWVzLnJlZHVjZTxBcnJheTxbc3RyaW5nLCBGb3JtRGVmXT4+KFxuICAgICAgKHByZXYsIG1vZGVsKSA9PiB7XG4gICAgICAgIGlmIChsb3dlckNhc2VNb2RlbEtleXM/Lmhhcyhtb2RlbC50b0xvd2VyQ2FzZSgpKSkge1xuICAgICAgICAgIGNvbnN0IGVudHJ5ID0gbW9kZWxFbnRyaWVzLmZpbmQoXG4gICAgICAgICAgICAoW2tleV0pID0+IGtleS50b0xvd2VyQ2FzZSgpID09PSBtb2RlbC50b0xvd2VyQ2FzZSgpXG4gICAgICAgICAgKTtcbiAgICAgICAgICBpZiAoIWVudHJ5KSB7XG4gICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgYW1wbGlmeS1iYWNrZW5kLXJ1bGVzL3ByZWZlci1hbXBsaWZ5LWVycm9yc1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCBzcGVjaWZpZWQgbW9kZWwgJHttb2RlbH1gKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcHJldi5wdXNoKGVudHJ5KTtcbiAgICAgICAgICByZXR1cm4gcHJldjtcbiAgICAgICAgfVxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgYW1wbGlmeS1iYWNrZW5kLXJ1bGVzL3ByZWZlci1hbXBsaWZ5LWVycm9yc1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBmaW5kIHNwZWNpZmllZCBtb2RlbCAke21vZGVsfWApO1xuICAgICAgfSxcbiAgICAgIFtdXG4gICAgKTtcbiAgfTtcbiAgcHJpdmF0ZSBjb2RlZ2VuRm9ybSA9IChcbiAgICBkYXRhU2NoZW1hOiBHZW5lcmljRGF0YVNjaGVtYSxcbiAgICBmb3JtU2NoZW1hOiBTdHVkaW9Gb3JtXG4gICkgPT4ge1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZVVpQnVpbGRlckZvcm0oZm9ybVNjaGVtYSwgZGF0YVNjaGVtYSwge30pO1xuICB9O1xuXG4gIHByaXZhdGUgZ2V0RmlsdGVyZWRNb2RlbHMgPSAoXG4gICAgZGF0YVNjaGVtYTogR2VuZXJpY0RhdGFTY2hlbWEsXG4gICAgZmlsdGVyZWRNb2RlbE5hbWVzPzogc3RyaW5nW11cbiAgKSA9PiB7XG4gICAgY29uc3QgbW9kZWxNYXAgPSB0aGlzLmdldE1vZGVsTWFwRm9yRGF0YVNjaGVtYShkYXRhU2NoZW1hKTtcbiAgICBjb25zdCBmaWx0ZXJlZE1vZGVsczogQXJyYXk8W3N0cmluZywgRm9ybURlZl0+ID0gW107XG4gICAgaWYgKCFmaWx0ZXJlZE1vZGVsTmFtZXMgfHwgIWZpbHRlcmVkTW9kZWxOYW1lcz8ubGVuZ3RoKSB7XG4gICAgICBmaWx0ZXJlZE1vZGVscy5wdXNoKC4uLk9iamVjdC5lbnRyaWVzKG1vZGVsTWFwKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGZpbHRlcmVkTW9kZWxzLnB1c2goXG4gICAgICAgIC4uLnRoaXMuZmlsdGVyTW9kZWxzQnlOYW1lKGZpbHRlcmVkTW9kZWxOYW1lcywgbW9kZWxNYXApXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gZmlsdGVyZWRNb2RlbHM7XG4gIH07XG4gIHByaXZhdGUgdHJhbnNmb3JtTW9kZWxMaXN0VG9NYXAgPSAobW9kZWxzOiBBcnJheTxbc3RyaW5nLCBGb3JtRGVmXT4pID0+IHtcbiAgICByZXR1cm4gbW9kZWxzLnJlZHVjZShcbiAgICAgIChwcmV2LCBba2V5LCB2YWx1ZV0pID0+ICh7IC4uLnByZXYsIFtrZXldOiB2YWx1ZSB9KSxcbiAgICAgIHt9XG4gICAgKTtcbiAgfTtcblxuICBwcml2YXRlIGNyZWF0ZVV0aWxGaWxlID0gKHV0aWxzOiBVdGlsVGVtcGxhdGVUeXBlW10pID0+IHtcbiAgICBjb25zdCByZW5kZXJlciA9IG5ldyBSZWFjdFV0aWxzU3R1ZGlvVGVtcGxhdGVSZW5kZXJlcih1dGlscywgdGhpcy5jb25maWcpO1xuICAgIGNvbnN0IHsgY29tcG9uZW50VGV4dCB9ID0gcmVuZGVyZXIucmVuZGVyQ29tcG9uZW50SW50ZXJuYWwoKTtcbiAgICByZXR1cm4ge1xuICAgICAgY29tcG9uZW50VGV4dCxcbiAgICAgIGZpbGVOYW1lOiByZW5kZXJlci5maWxlTmFtZSxcbiAgICB9O1xuICB9O1xuXG4gIC8qKlxuICAgKiBSZXR1cm4gdXRpbHMgZmlsZSB0ZXh0XG4gICAqL1xuICBwcml2YXRlIGdlbmVyYXRlVXRpbEZpbGUgPSAoKSA9PiB7XG4gICAgY29uc3QgdXRpbHM6IFV0aWxUZW1wbGF0ZVR5cGVbXSA9IFtcbiAgICAgICd2YWxpZGF0aW9uJyxcbiAgICAgICdmb3JtYXR0ZXInLFxuICAgICAgJ2ZldGNoQnlQYXRoJyxcbiAgICAgICdwcm9jZXNzRmlsZScsXG4gICAgXTtcbiAgICBjb25zdCB7IGNvbXBvbmVudFRleHQsIGZpbGVOYW1lIH0gPSB0aGlzLmNyZWF0ZVV0aWxGaWxlKHV0aWxzKTtcbiAgICByZXR1cm4ge1xuICAgICAgc2NoZW1hTmFtZTogJ0FtcGxpZnlTdHVkaW9VdGlsRmlsZScsXG4gICAgICBjb21wb25lbnRUZXh0LFxuICAgICAgZmlsZU5hbWUsXG4gICAgICBkZWNsYXJhdGlvbjogdW5kZWZpbmVkLFxuICAgICAgZXJyb3I6IHVuZGVmaW5lZCxcbiAgICB9O1xuICB9O1xuXG4gIHByaXZhdGUgY3JlYXRlSW5kZXhGaWxlID0gKHNjaGVtYXM6IFN0dWRpb1NjaGVtYVtdKSA9PiB7XG4gICAgY29uc3QgcmVuZGVyZXIgPSBuZXcgUmVhY3RJbmRleFN0dWRpb1RlbXBsYXRlUmVuZGVyZXIoXG4gICAgICBzY2hlbWFzLFxuICAgICAgTG9jYWxHcmFwaHFsRm9ybUdlbmVyYXRvci5kZWZhdWx0Q29uZmlnXG4gICAgKTtcbiAgICBjb25zdCB7IGNvbXBvbmVudFRleHQgfSA9IHJlbmRlcmVyLnJlbmRlckNvbXBvbmVudEludGVybmFsKCk7XG4gICAgcmV0dXJuIHtcbiAgICAgIGNvbXBvbmVudFRleHQsXG4gICAgICBmaWxlTmFtZTogcmVuZGVyZXIuZmlsZU5hbWUsXG4gICAgfTtcbiAgfTtcbn1cbiJdfQ==