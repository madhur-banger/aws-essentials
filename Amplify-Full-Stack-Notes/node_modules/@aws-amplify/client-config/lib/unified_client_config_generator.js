import { unifiedBackendOutputSchema } from '@aws-amplify/backend-output-schemas';
import { AmplifyUserError, ObjectAccumulator, ObjectAccumulatorPropertyAlreadyExistsError, ObjectAccumulatorVersionMismatchError, } from '@aws-amplify/platform-core';
import { BackendOutputClientError, BackendOutputClientErrorType, } from '@aws-amplify/deployed-backend-client';
/**
 * Right now this is mostly a stub. This will become a translation layer between backend output and frontend config
 *
 * There may be multiple implementations of this for different frontends
 */
export class UnifiedClientConfigGenerator {
    fetchOutput;
    clientConfigContributors;
    /**
     * Provide a reference to how this config generator should retrieve backend output
     */
    constructor(fetchOutput, clientConfigContributors) {
        this.fetchOutput = fetchOutput;
        this.clientConfigContributors = clientConfigContributors;
    }
    /**
     * Fetch all backend output, invoke each ClientConfigContributor on the result and merge into a single config object
     */
    generateClientConfig = async () => {
        let output;
        try {
            output = await this.fetchOutput();
        }
        catch (error) {
            if (error instanceof BackendOutputClientError &&
                error.code === BackendOutputClientErrorType.DEPLOYMENT_IN_PROGRESS) {
                throw new AmplifyUserError('DeploymentInProgressError', {
                    message: 'Deployment is currently in progress.',
                    resolution: 'Re-run this command once the deployment completes.',
                }, error);
            }
            if (error instanceof BackendOutputClientError &&
                error.code === BackendOutputClientErrorType.NO_STACK_FOUND) {
                throw new AmplifyUserError('StackDoesNotExistError', {
                    message: 'Stack does not exist.',
                    resolution: 'Ensure the CloudFormation stack ID or Amplify App ID and branch specified are correct and exists, then re-run this command.',
                }, error);
            }
            if (error instanceof BackendOutputClientError &&
                error.code === BackendOutputClientErrorType.METADATA_RETRIEVAL_ERROR) {
                throw new AmplifyUserError('NonAmplifyStackError', {
                    message: 'Stack was not created with Amplify.',
                    resolution: 'Ensure the CloudFormation stack ID references a main stack created with Amplify, then re-run this command.',
                }, error);
            }
            if (error instanceof BackendOutputClientError &&
                error.code === BackendOutputClientErrorType.CREDENTIALS_ERROR) {
                throw new AmplifyUserError('CredentialsError', {
                    message: 'Unable to get backend outputs due to invalid credentials.',
                    resolution: 'Ensure your AWS credentials are correctly set and refreshed.',
                }, error);
            }
            if (error instanceof BackendOutputClientError &&
                error.code === BackendOutputClientErrorType.ACCESS_DENIED) {
                throw new AmplifyUserError('AccessDeniedError', {
                    message: 'Unable to get backend outputs due to insufficient permissions.',
                    resolution: 'Ensure you have permissions to call cloudformation:GetTemplateSummary.',
                }, error);
            }
            throw error;
        }
        const backendOutput = unifiedBackendOutputSchema.parse(output);
        const accumulator = new ObjectAccumulator({});
        for (const contributor of this.clientConfigContributors) {
            const clientConfigContribution = await contributor.contribute(backendOutput);
            try {
                // Partial to DeepPartialAmplifyGeneratedConfigs is always a safe case since it's up-casting
                accumulator.accumulate(clientConfigContribution);
            }
            catch (error) {
                if (error instanceof ObjectAccumulatorPropertyAlreadyExistsError) {
                    throw new AmplifyUserError('OutputEntryAlreadyExistsError', {
                        message: `Duplicated entry with key ${error.key} detected in deployment outputs`,
                        resolution: "Check if 'backend.addOutput' is called multiple times with overlapping inputs or" +
                            " if 'backend.addOutput' is called with values overlapping Amplify managed keys",
                    }, error);
                }
                if (error instanceof ObjectAccumulatorVersionMismatchError) {
                    throw new AmplifyUserError('VersionMismatchError', {
                        message: `Conflicting versions of client configuration found. `,
                        resolution: "Ensure that the version specified in 'backend.addOutput' is consistent" +
                            ' and is same as the one used for generating the client config',
                    }, error);
                }
                throw error;
            }
        }
        return accumulator.getAccumulatedObject();
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidW5pZmllZF9jbGllbnRfY29uZmlnX2dlbmVyYXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy91bmlmaWVkX2NsaWVudF9jb25maWdfZ2VuZXJhdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUlBLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBSWpGLE9BQU8sRUFDTCxnQkFBZ0IsRUFDaEIsaUJBQWlCLEVBQ2pCLDJDQUEyQyxFQUMzQyxxQ0FBcUMsR0FDdEMsTUFBTSw0QkFBNEIsQ0FBQztBQUNwQyxPQUFPLEVBQ0wsd0JBQXdCLEVBQ3hCLDRCQUE0QixHQUM3QixNQUFNLHNDQUFzQyxDQUFDO0FBRTlDOzs7O0dBSUc7QUFDSCxNQUFNLE9BQU8sNEJBQTRCO0lBS3BCO0lBQ0E7SUFMbkI7O09BRUc7SUFDSCxZQUNtQixXQUF5QyxFQUN6Qyx3QkFBbUQ7UUFEbkQsZ0JBQVcsR0FBWCxXQUFXLENBQThCO1FBQ3pDLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBMkI7SUFDbkUsQ0FBQztJQUVKOztPQUVHO0lBQ0gsb0JBQW9CLEdBQUcsS0FBSyxJQUEyQixFQUFFO1FBQ3ZELElBQUksTUFBTSxDQUFDO1FBQ1gsSUFBSTtZQUNGLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztTQUNuQztRQUFDLE9BQU8sS0FBSyxFQUFFO1lBQ2QsSUFDRSxLQUFLLFlBQVksd0JBQXdCO2dCQUN6QyxLQUFLLENBQUMsSUFBSSxLQUFLLDRCQUE0QixDQUFDLHNCQUFzQixFQUNsRTtnQkFDQSxNQUFNLElBQUksZ0JBQWdCLENBQ3hCLDJCQUEyQixFQUMzQjtvQkFDRSxPQUFPLEVBQUUsc0NBQXNDO29CQUMvQyxVQUFVLEVBQUUsb0RBQW9EO2lCQUNqRSxFQUNELEtBQUssQ0FDTixDQUFDO2FBQ0g7WUFDRCxJQUNFLEtBQUssWUFBWSx3QkFBd0I7Z0JBQ3pDLEtBQUssQ0FBQyxJQUFJLEtBQUssNEJBQTRCLENBQUMsY0FBYyxFQUMxRDtnQkFDQSxNQUFNLElBQUksZ0JBQWdCLENBQ3hCLHdCQUF3QixFQUN4QjtvQkFDRSxPQUFPLEVBQUUsdUJBQXVCO29CQUNoQyxVQUFVLEVBQ1IsNkhBQTZIO2lCQUNoSSxFQUNELEtBQUssQ0FDTixDQUFDO2FBQ0g7WUFDRCxJQUNFLEtBQUssWUFBWSx3QkFBd0I7Z0JBQ3pDLEtBQUssQ0FBQyxJQUFJLEtBQUssNEJBQTRCLENBQUMsd0JBQXdCLEVBQ3BFO2dCQUNBLE1BQU0sSUFBSSxnQkFBZ0IsQ0FDeEIsc0JBQXNCLEVBQ3RCO29CQUNFLE9BQU8sRUFBRSxxQ0FBcUM7b0JBQzlDLFVBQVUsRUFDUiw0R0FBNEc7aUJBQy9HLEVBQ0QsS0FBSyxDQUNOLENBQUM7YUFDSDtZQUNELElBQ0UsS0FBSyxZQUFZLHdCQUF3QjtnQkFDekMsS0FBSyxDQUFDLElBQUksS0FBSyw0QkFBNEIsQ0FBQyxpQkFBaUIsRUFDN0Q7Z0JBQ0EsTUFBTSxJQUFJLGdCQUFnQixDQUN4QixrQkFBa0IsRUFDbEI7b0JBQ0UsT0FBTyxFQUNMLDJEQUEyRDtvQkFDN0QsVUFBVSxFQUNSLDhEQUE4RDtpQkFDakUsRUFDRCxLQUFLLENBQ04sQ0FBQzthQUNIO1lBQ0QsSUFDRSxLQUFLLFlBQVksd0JBQXdCO2dCQUN6QyxLQUFLLENBQUMsSUFBSSxLQUFLLDRCQUE0QixDQUFDLGFBQWEsRUFDekQ7Z0JBQ0EsTUFBTSxJQUFJLGdCQUFnQixDQUN4QixtQkFBbUIsRUFDbkI7b0JBQ0UsT0FBTyxFQUNMLGdFQUFnRTtvQkFDbEUsVUFBVSxFQUNSLHdFQUF3RTtpQkFDM0UsRUFDRCxLQUFLLENBQ04sQ0FBQzthQUNIO1lBRUQsTUFBTSxLQUFLLENBQUM7U0FDYjtRQUNELE1BQU0sYUFBYSxHQUFHLDBCQUEwQixDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUUvRCxNQUFNLFdBQVcsR0FBRyxJQUFJLGlCQUFpQixDQUFlLEVBQUUsQ0FBQyxDQUFDO1FBRTVELEtBQUssTUFBTSxXQUFXLElBQUksSUFBSSxDQUFDLHdCQUF3QixFQUFFO1lBQ3ZELE1BQU0sd0JBQXdCLEdBQUcsTUFBTSxXQUFXLENBQUMsVUFBVSxDQUMzRCxhQUFhLENBQ2QsQ0FBQztZQUNGLElBQUk7Z0JBQ0YsNEZBQTRGO2dCQUM1RixXQUFXLENBQUMsVUFBVSxDQUNwQix3QkFBNEUsQ0FDN0UsQ0FBQzthQUNIO1lBQUMsT0FBTyxLQUFLLEVBQUU7Z0JBQ2QsSUFBSSxLQUFLLFlBQVksMkNBQTJDLEVBQUU7b0JBQ2hFLE1BQU0sSUFBSSxnQkFBZ0IsQ0FDeEIsK0JBQStCLEVBQy9CO3dCQUNFLE9BQU8sRUFBRSw2QkFBNkIsS0FBSyxDQUFDLEdBQUcsaUNBQWlDO3dCQUNoRixVQUFVLEVBQ1Isa0ZBQWtGOzRCQUNsRixnRkFBZ0Y7cUJBQ25GLEVBQ0QsS0FBSyxDQUNOLENBQUM7aUJBQ0g7Z0JBQ0QsSUFBSSxLQUFLLFlBQVkscUNBQXFDLEVBQUU7b0JBQzFELE1BQU0sSUFBSSxnQkFBZ0IsQ0FDeEIsc0JBQXNCLEVBQ3RCO3dCQUNFLE9BQU8sRUFBRSxzREFBc0Q7d0JBQy9ELFVBQVUsRUFDUix3RUFBd0U7NEJBQ3hFLCtEQUErRDtxQkFDbEUsRUFDRCxLQUFLLENBQ04sQ0FBQztpQkFDSDtnQkFDRCxNQUFNLEtBQUssQ0FBQzthQUNiO1NBQ0Y7UUFDRCxPQUFxQixXQUFXLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztJQUMxRCxDQUFDLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEJhY2tlbmRPdXRwdXQsXG4gIERlZXBQYXJ0aWFsQW1wbGlmeUdlbmVyYXRlZENvbmZpZ3MsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHsgdW5pZmllZEJhY2tlbmRPdXRwdXRTY2hlbWEgfSBmcm9tICdAYXdzLWFtcGxpZnkvYmFja2VuZC1vdXRwdXQtc2NoZW1hcyc7XG5pbXBvcnQgeyBDbGllbnRDb25maWcgfSBmcm9tICcuL2NsaWVudC1jb25maWctdHlwZXMvY2xpZW50X2NvbmZpZy5qcyc7XG5pbXBvcnQgeyBDbGllbnRDb25maWdDb250cmlidXRvciB9IGZyb20gJy4vY2xpZW50LWNvbmZpZy10eXBlcy9jbGllbnRfY29uZmlnX2NvbnRyaWJ1dG9yLmpzJztcbmltcG9ydCB7IENsaWVudENvbmZpZ0dlbmVyYXRvciB9IGZyb20gJy4vY2xpZW50X2NvbmZpZ19nZW5lcmF0b3IuanMnO1xuaW1wb3J0IHtcbiAgQW1wbGlmeVVzZXJFcnJvcixcbiAgT2JqZWN0QWNjdW11bGF0b3IsXG4gIE9iamVjdEFjY3VtdWxhdG9yUHJvcGVydHlBbHJlYWR5RXhpc3RzRXJyb3IsXG4gIE9iamVjdEFjY3VtdWxhdG9yVmVyc2lvbk1pc21hdGNoRXJyb3IsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcbmltcG9ydCB7XG4gIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvcixcbiAgQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2RlcGxveWVkLWJhY2tlbmQtY2xpZW50JztcblxuLyoqXG4gKiBSaWdodCBub3cgdGhpcyBpcyBtb3N0bHkgYSBzdHViLiBUaGlzIHdpbGwgYmVjb21lIGEgdHJhbnNsYXRpb24gbGF5ZXIgYmV0d2VlbiBiYWNrZW5kIG91dHB1dCBhbmQgZnJvbnRlbmQgY29uZmlnXG4gKlxuICogVGhlcmUgbWF5IGJlIG11bHRpcGxlIGltcGxlbWVudGF0aW9ucyBvZiB0aGlzIGZvciBkaWZmZXJlbnQgZnJvbnRlbmRzXG4gKi9cbmV4cG9ydCBjbGFzcyBVbmlmaWVkQ2xpZW50Q29uZmlnR2VuZXJhdG9yIGltcGxlbWVudHMgQ2xpZW50Q29uZmlnR2VuZXJhdG9yIHtcbiAgLyoqXG4gICAqIFByb3ZpZGUgYSByZWZlcmVuY2UgdG8gaG93IHRoaXMgY29uZmlnIGdlbmVyYXRvciBzaG91bGQgcmV0cmlldmUgYmFja2VuZCBvdXRwdXRcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZmV0Y2hPdXRwdXQ6ICgpID0+IFByb21pc2U8QmFja2VuZE91dHB1dD4sXG4gICAgcHJpdmF0ZSByZWFkb25seSBjbGllbnRDb25maWdDb250cmlidXRvcnM6IENsaWVudENvbmZpZ0NvbnRyaWJ1dG9yW11cbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBGZXRjaCBhbGwgYmFja2VuZCBvdXRwdXQsIGludm9rZSBlYWNoIENsaWVudENvbmZpZ0NvbnRyaWJ1dG9yIG9uIHRoZSByZXN1bHQgYW5kIG1lcmdlIGludG8gYSBzaW5nbGUgY29uZmlnIG9iamVjdFxuICAgKi9cbiAgZ2VuZXJhdGVDbGllbnRDb25maWcgPSBhc3luYyAoKTogUHJvbWlzZTxDbGllbnRDb25maWc+ID0+IHtcbiAgICBsZXQgb3V0cHV0O1xuICAgIHRyeSB7XG4gICAgICBvdXRwdXQgPSBhd2FpdCB0aGlzLmZldGNoT3V0cHV0KCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGlmIChcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3IgJiZcbiAgICAgICAgZXJyb3IuY29kZSA9PT0gQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZS5ERVBMT1lNRU5UX0lOX1BST0dSRVNTXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICAgJ0RlcGxveW1lbnRJblByb2dyZXNzRXJyb3InLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIG1lc3NhZ2U6ICdEZXBsb3ltZW50IGlzIGN1cnJlbnRseSBpbiBwcm9ncmVzcy4nLFxuICAgICAgICAgICAgcmVzb2x1dGlvbjogJ1JlLXJ1biB0aGlzIGNvbW1hbmQgb25jZSB0aGUgZGVwbG95bWVudCBjb21wbGV0ZXMuJyxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGVycm9yXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgQmFja2VuZE91dHB1dENsaWVudEVycm9yICYmXG4gICAgICAgIGVycm9yLmNvZGUgPT09IEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvclR5cGUuTk9fU1RBQ0tfRk9VTkRcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgICAnU3RhY2tEb2VzTm90RXhpc3RFcnJvcicsXG4gICAgICAgICAge1xuICAgICAgICAgICAgbWVzc2FnZTogJ1N0YWNrIGRvZXMgbm90IGV4aXN0LicsXG4gICAgICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICAgICAnRW5zdXJlIHRoZSBDbG91ZEZvcm1hdGlvbiBzdGFjayBJRCBvciBBbXBsaWZ5IEFwcCBJRCBhbmQgYnJhbmNoIHNwZWNpZmllZCBhcmUgY29ycmVjdCBhbmQgZXhpc3RzLCB0aGVuIHJlLXJ1biB0aGlzIGNvbW1hbmQuJyxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGVycm9yXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgQmFja2VuZE91dHB1dENsaWVudEVycm9yICYmXG4gICAgICAgIGVycm9yLmNvZGUgPT09IEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvclR5cGUuTUVUQURBVEFfUkVUUklFVkFMX0VSUk9SXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICAgJ05vbkFtcGxpZnlTdGFja0Vycm9yJyxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBtZXNzYWdlOiAnU3RhY2sgd2FzIG5vdCBjcmVhdGVkIHdpdGggQW1wbGlmeS4nLFxuICAgICAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAgICAgJ0Vuc3VyZSB0aGUgQ2xvdWRGb3JtYXRpb24gc3RhY2sgSUQgcmVmZXJlbmNlcyBhIG1haW4gc3RhY2sgY3JlYXRlZCB3aXRoIEFtcGxpZnksIHRoZW4gcmUtcnVuIHRoaXMgY29tbWFuZC4nLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgZXJyb3JcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3IgJiZcbiAgICAgICAgZXJyb3IuY29kZSA9PT0gQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZS5DUkVERU5USUFMU19FUlJPUlxuICAgICAgKSB7XG4gICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAgICdDcmVkZW50aWFsc0Vycm9yJyxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBtZXNzYWdlOlxuICAgICAgICAgICAgICAnVW5hYmxlIHRvIGdldCBiYWNrZW5kIG91dHB1dHMgZHVlIHRvIGludmFsaWQgY3JlZGVudGlhbHMuJyxcbiAgICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAgICdFbnN1cmUgeW91ciBBV1MgY3JlZGVudGlhbHMgYXJlIGNvcnJlY3RseSBzZXQgYW5kIHJlZnJlc2hlZC4nLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgZXJyb3JcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3IgJiZcbiAgICAgICAgZXJyb3IuY29kZSA9PT0gQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZS5BQ0NFU1NfREVOSUVEXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICAgJ0FjY2Vzc0RlbmllZEVycm9yJyxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBtZXNzYWdlOlxuICAgICAgICAgICAgICAnVW5hYmxlIHRvIGdldCBiYWNrZW5kIG91dHB1dHMgZHVlIHRvIGluc3VmZmljaWVudCBwZXJtaXNzaW9ucy4nLFxuICAgICAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAgICAgJ0Vuc3VyZSB5b3UgaGF2ZSBwZXJtaXNzaW9ucyB0byBjYWxsIGNsb3VkZm9ybWF0aW9uOkdldFRlbXBsYXRlU3VtbWFyeS4nLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgZXJyb3JcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICAgIGNvbnN0IGJhY2tlbmRPdXRwdXQgPSB1bmlmaWVkQmFja2VuZE91dHB1dFNjaGVtYS5wYXJzZShvdXRwdXQpO1xuXG4gICAgY29uc3QgYWNjdW11bGF0b3IgPSBuZXcgT2JqZWN0QWNjdW11bGF0b3I8Q2xpZW50Q29uZmlnPih7fSk7XG5cbiAgICBmb3IgKGNvbnN0IGNvbnRyaWJ1dG9yIG9mIHRoaXMuY2xpZW50Q29uZmlnQ29udHJpYnV0b3JzKSB7XG4gICAgICBjb25zdCBjbGllbnRDb25maWdDb250cmlidXRpb24gPSBhd2FpdCBjb250cmlidXRvci5jb250cmlidXRlKFxuICAgICAgICBiYWNrZW5kT3V0cHV0XG4gICAgICApO1xuICAgICAgdHJ5IHtcbiAgICAgICAgLy8gUGFydGlhbCB0byBEZWVwUGFydGlhbEFtcGxpZnlHZW5lcmF0ZWRDb25maWdzIGlzIGFsd2F5cyBhIHNhZmUgY2FzZSBzaW5jZSBpdCdzIHVwLWNhc3RpbmdcbiAgICAgICAgYWNjdW11bGF0b3IuYWNjdW11bGF0ZShcbiAgICAgICAgICBjbGllbnRDb25maWdDb250cmlidXRpb24gYXMgRGVlcFBhcnRpYWxBbXBsaWZ5R2VuZXJhdGVkQ29uZmlnczxDbGllbnRDb25maWc+XG4gICAgICAgICk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBPYmplY3RBY2N1bXVsYXRvclByb3BlcnR5QWxyZWFkeUV4aXN0c0Vycm9yKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICAgICAnT3V0cHV0RW50cnlBbHJlYWR5RXhpc3RzRXJyb3InLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBtZXNzYWdlOiBgRHVwbGljYXRlZCBlbnRyeSB3aXRoIGtleSAke2Vycm9yLmtleX0gZGV0ZWN0ZWQgaW4gZGVwbG95bWVudCBvdXRwdXRzYCxcbiAgICAgICAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAgICAgICBcIkNoZWNrIGlmICdiYWNrZW5kLmFkZE91dHB1dCcgaXMgY2FsbGVkIG11bHRpcGxlIHRpbWVzIHdpdGggb3ZlcmxhcHBpbmcgaW5wdXRzIG9yXCIgK1xuICAgICAgICAgICAgICAgIFwiIGlmICdiYWNrZW5kLmFkZE91dHB1dCcgaXMgY2FsbGVkIHdpdGggdmFsdWVzIG92ZXJsYXBwaW5nIEFtcGxpZnkgbWFuYWdlZCBrZXlzXCIsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZXJyb3JcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIE9iamVjdEFjY3VtdWxhdG9yVmVyc2lvbk1pc21hdGNoRXJyb3IpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgICAgICdWZXJzaW9uTWlzbWF0Y2hFcnJvcicsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIG1lc3NhZ2U6IGBDb25mbGljdGluZyB2ZXJzaW9ucyBvZiBjbGllbnQgY29uZmlndXJhdGlvbiBmb3VuZC4gYCxcbiAgICAgICAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAgICAgICBcIkVuc3VyZSB0aGF0IHRoZSB2ZXJzaW9uIHNwZWNpZmllZCBpbiAnYmFja2VuZC5hZGRPdXRwdXQnIGlzIGNvbnNpc3RlbnRcIiArXG4gICAgICAgICAgICAgICAgJyBhbmQgaXMgc2FtZSBhcyB0aGUgb25lIHVzZWQgZm9yIGdlbmVyYXRpbmcgdGhlIGNsaWVudCBjb25maWcnLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGVycm9yXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIDxDbGllbnRDb25maWc+YWNjdW11bGF0b3IuZ2V0QWNjdW11bGF0ZWRPYmplY3QoKTtcbiAgfTtcbn1cbiJdfQ==