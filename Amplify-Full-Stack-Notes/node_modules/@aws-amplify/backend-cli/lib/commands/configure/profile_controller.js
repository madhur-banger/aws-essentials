import { DEFAULT_PROFILE, getHomeDir, loadSharedConfigFiles, } from '@smithy/shared-ini-file-loader';
import { fromIni } from '@aws-sdk/credential-providers';
import { EOL } from 'os';
import fs from 'fs/promises';
import path from 'path';
import { existsSync } from 'fs';
/**
 * Manages AWS profiles.
 */
export class ProfileController {
    /**
     * Return true if the provided profile exists in the aws config and/or credential file.
     */
    profileExists = async (profile) => {
        const profileData = await loadSharedConfigFiles({
            ignoreCache: true,
        });
        return (profileData.configFile?.[profile] !== undefined ||
            profileData.credentialsFile?.[profile] !== undefined);
    };
    /**
     * Appends a profile to AWS config and credential files.
     */
    createOrAppendAWSFiles = async (options) => {
        await this.createOrAppendAWSConfigFile(options);
        await this.createOrAppendAWSCredentialFile(options);
    };
    createOrAppendAWSConfigFile = async (options) => {
        const filePath = process.env.AWS_CONFIG_FILE ?? path.join(getHomeDir(), '.aws', 'config');
        const dirName = path.dirname(filePath);
        if (!existsSync(dirName)) {
            await fs.mkdir(dirName, { recursive: true });
        }
        const fileEndsWithEOL = await this.isFileEndsWithEOL(filePath);
        let configData = fileEndsWithEOL ? '' : EOL;
        configData +=
            options.profile === DEFAULT_PROFILE
                ? `[${options.profile}]${EOL}`
                : `[profile ${options.profile}]${EOL}`;
        configData += `region = ${options.region}${EOL}`;
        await fs.appendFile(filePath, configData, { mode: '600' });
        // validate after write. It is to ensure this function is compatible with the current AWS format.
        const profileData = await loadSharedConfigFiles({
            ignoreCache: true,
        });
        const retrievedRegion = profileData.configFile?.[options.profile]?.region;
        if (retrievedRegion !== options.region) {
            throw new Error(`Failed to configure the AWS config file`);
        }
    };
    createOrAppendAWSCredentialFile = async (options) => {
        const filePath = process.env.AWS_SHARED_CREDENTIALS_FILE ??
            path.join(getHomeDir(), '.aws', 'credentials');
        const dirName = path.dirname(filePath);
        if (!existsSync(dirName)) {
            await fs.mkdir(dirName, { recursive: true });
        }
        const fileEndsWithEOL = await this.isFileEndsWithEOL(filePath);
        let credentialData = fileEndsWithEOL ? '' : EOL;
        credentialData += `[${options.profile}]${EOL}`;
        credentialData += `aws_access_key_id = ${options.accessKeyId}${EOL}`;
        credentialData += `aws_secret_access_key = ${options.secretAccessKey}${EOL}`;
        await fs.appendFile(filePath, credentialData, { mode: '600' });
        // validate after write. It is to ensure this function is compatible with the current AWS format.
        const provider = fromIni({
            profile: options.profile,
            ignoreCache: true,
        });
        const retrievedCredentials = await provider();
        if (retrievedCredentials.accessKeyId !== options.accessKeyId ||
            retrievedCredentials.secretAccessKey !== options.secretAccessKey ||
            retrievedCredentials.sessionToken) {
            throw new Error(`Failed to configure the AWS credentials file`);
        }
    };
    isFileEndsWithEOL = async (filePath) => {
        try {
            const data = await fs.readFile(filePath, 'utf-8');
            return data.length > 0 && data.slice(-EOL.length) === EOL;
        }
        catch (err) {
            const error = err;
            if (error.message.includes('ENOENT')) {
                // file doesn't exists
                return true;
            }
            throw err;
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvZmlsZV9jb250cm9sbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbW1hbmRzL2NvbmZpZ3VyZS9wcm9maWxlX2NvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLGVBQWUsRUFDZixVQUFVLEVBQ1YscUJBQXFCLEdBQ3RCLE1BQU0sZ0NBQWdDLENBQUM7QUFDeEMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDekIsT0FBTyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQzdCLE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUN4QixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBd0JoQzs7R0FFRztBQUNILE1BQU0sT0FBTyxpQkFBaUI7SUFDNUI7O09BRUc7SUFDSCxhQUFhLEdBQUcsS0FBSyxFQUFFLE9BQWUsRUFBb0IsRUFBRTtRQUMxRCxNQUFNLFdBQVcsR0FBRyxNQUFNLHFCQUFxQixDQUFDO1lBQzlDLFdBQVcsRUFBRSxJQUFJO1NBQ2xCLENBQUMsQ0FBQztRQUVILE9BQU8sQ0FDTCxXQUFXLENBQUMsVUFBVSxFQUFFLENBQUMsT0FBTyxDQUFDLEtBQUssU0FBUztZQUMvQyxXQUFXLENBQUMsZUFBZSxFQUFFLENBQUMsT0FBTyxDQUFDLEtBQUssU0FBUyxDQUNyRCxDQUFDO0lBQ0osQ0FBQyxDQUFDO0lBRUY7O09BRUc7SUFDSCxzQkFBc0IsR0FBRyxLQUFLLEVBQUUsT0FBdUIsRUFBRSxFQUFFO1FBQ3pELE1BQU0sSUFBSSxDQUFDLDJCQUEyQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ2hELE1BQU0sSUFBSSxDQUFDLCtCQUErQixDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3RELENBQUMsQ0FBQztJQUVNLDJCQUEyQixHQUFHLEtBQUssRUFDekMsT0FB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QUFPO1lBQ3hCLFdBQVcsRUFBRSxJQUFJO1NBQ2xCLENBQUMsQ0FBQztRQUNILE1BQU0sb0JBQW9CLEdBQUcsTUFBTSxRQUFRLEVBQUUsQ0FBQztRQUM5QyxJQUNFLG9CQUFvQixDQUFDLFdBQVcsS0FBSyxPQUFPLENBQUMsV0FBVztZQUN4RCxvQkFBb0IsQ0FBQyxlQUFlLEtBQUssT0FBTyxDQUFDLGVBQWU7WUFDaEUsb0JBQW9CLENBQUMsWUFBWSxFQUNqQztZQUNBLE1BQU0sSUFBSSxLQUFLLENBQUMsOENBQThDLENBQUMsQ0FBQztTQUNqRTtJQUNILENBQUMsQ0FBQztJQUVNLGlCQUFpQixHQUFHLEtBQUssRUFBRSxRQUFnQixFQUFvQixFQUFFO1FBQ3ZFLElBQUk7WUFDRixNQUFNLElBQUksR0FBRyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ2xELE9BQU8sSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSyxHQUFHLENBQUM7U0FDM0Q7UUFBQyxPQUFPLEdBQUcsRUFBRTtZQUNaLE1BQU0sS0FBSyxHQUFHLEdBQVksQ0FBQztZQUMzQixJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxFQUFFO2dCQUNwQyxzQkFBc0I7Z0JBQ3RCLE9BQU8sSUFBSSxDQUFDO2FBQ2I7WUFDRCxNQUFNLEdBQUcsQ0FBQztTQUNYO0lBQ0gsQ0FBQyxDQUFDO0NBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBERUZBVUxUX1BST0ZJTEUsXG4gIGdldEhvbWVEaXIsXG4gIGxvYWRTaGFyZWRDb25maWdGaWxlcyxcbn0gZnJvbSAnQHNtaXRoeS9zaGFyZWQtaW5pLWZpbGUtbG9hZGVyJztcbmltcG9ydCB7IGZyb21JbmkgfSBmcm9tICdAYXdzLXNkay9jcmVkZW50aWFsLXByb3ZpZGVycyc7XG5pbXBvcnQgeyBFT0wgfSBmcm9tICdvcyc7XG5pbXBvcnQgZnMgZnJvbSAnZnMvcHJvbWlzZXMnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBleGlzdHNTeW5jIH0gZnJvbSAnZnMnO1xuXG4vKipcbiAqIE9wdGlvbnMgZm9yIHRoZSBwcm9maWxlIGNvbmZpZ3VyYXRpb24uXG4gKi9cbnR5cGUgQ29uZmlnUHJvZmlsZU9wdGlvbnMgPSB7XG4gIHByb2ZpbGU6IHN0cmluZztcbiAgcmVnaW9uOiBzdHJpbmc7XG59O1xuXG4vKipcbiAqIE9wdGlvbnMgZm9yIHRoZSBwcm9maWxlIGNyZWRlbnRpYWwuXG4gKi9cbnR5cGUgQ3JlZGVudGlhbFByb2ZpbGVPcHRpb25zID0ge1xuICBwcm9maWxlOiBzdHJpbmc7XG4gIGFjY2Vzc0tleUlkOiBzdHJpbmc7XG4gIHNlY3JldEFjY2Vzc0tleTogc3RyaW5nO1xufTtcblxuLyoqXG4gKiBPcHRpb25zIGZvciB0aGUgcHJvZmlsZSBjb25maWd1cmF0aW9uIGFuZCBjcmVkZW50aWFsLlxuICovXG5leHBvcnQgdHlwZSBQcm9maWxlT3B0aW9ucyA9IENvbmZpZ1Byb2ZpbGVPcHRpb25zICYgQ3JlZGVudGlhbFByb2ZpbGVPcHRpb25zO1xuXG4vKipcbiAqIE1hbmFnZXMgQVdTIHByb2ZpbGVzLlxuICovXG5leHBvcnQgY2xhc3MgUHJvZmlsZUNvbnRyb2xsZXIge1xuICAvKipcbiAgICogUmV0dXJuIHRydWUgaWYgdGhlIHByb3ZpZGVkIHByb2ZpbGUgZXhpc3RzIGluIHRoZSBhd3MgY29uZmlnIGFuZC9vciBjcmVkZW50aWFsIGZpbGUuXG4gICAqL1xuICBwcm9maWxlRXhpc3RzID0gYXN5bmMgKHByb2ZpbGU6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4gPT4ge1xuICAgIGNvbnN0IHByb2ZpbGVEYXRhID0gYXdhaXQgbG9hZFNoYXJlZENvbmZpZ0ZpbGVzKHtcbiAgICAgIGlnbm9yZUNhY2hlOiB0cnVlLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIChcbiAgICAgIHByb2ZpbGVEYXRhLmNvbmZpZ0ZpbGU/Lltwcm9maWxlXSAhPT0gdW5kZWZpbmVkIHx8XG4gICAgICBwcm9maWxlRGF0YS5jcmVkZW50aWFsc0ZpbGU/Lltwcm9maWxlXSAhPT0gdW5kZWZpbmVkXG4gICAgKTtcbiAgfTtcblxuICAvKipcbiAgICogQXBwZW5kcyBhIHByb2ZpbGUgdG8gQVdTIGNvbmZpZyBhbmQgY3JlZGVudGlhbCBmaWxlcy5cbiAgICovXG4gIGNyZWF0ZU9yQXBwZW5kQVdTRmlsZXMgPSBhc3luYyAob3B0aW9uczogUHJvZmlsZU9wdGlvbnMpID0+IHtcbiAgICBhd2FpdCB0aGlzLmNyZWF0ZU9yQXBwZW5kQVdTQ29uZmlnRmlsZShvcHRpb25zKTtcbiAgICBhd2FpdCB0aGlzLmNyZWF0ZU9yQXBwZW5kQVdTQ3JlZGVudGlhbEZpbGUob3B0aW9ucyk7XG4gIH07XG5cbiAgcHJpdmF0ZSBjcmVhdGVPckFwcGVuZEFXU0NvbmZpZ0ZpbGUgPSBhc3luYyAoXG4gICAgb3B0aW9uczogQ29uZmlnUHJvZmlsZU9wdGlvbnNcbiAgKSA9PiB7XG4gICAgY29uc3QgZmlsZVBhdGggPVxuICAgICAgcHJvY2Vzcy5lbnYuQVdTX0NPTkZJR19GSUxFID8/IHBhdGguam9pbihnZXRIb21lRGlyKCksICcuYXdzJywgJ2NvbmZpZycpO1xuXG4gICAgY29uc3QgZGlyTmFtZSA9IHBhdGguZGlybmFtZShmaWxlUGF0aCk7XG4gICAgaWYgKCFleGlzdHNTeW5jKGRpck5hbWUpKSB7XG4gICAgICBhd2FpdCBmcy5ta2RpcihkaXJOYW1lLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBmaWxlRW5kc1dpdGhFT0wgPSBhd2FpdCB0aGlzLmlzRmlsZUVuZHNXaXRoRU9MKGZpbGVQYXRoKTtcbiAgICBsZXQgY29uZmlnRGF0YSA9IGZpbGVFbmRzV2l0aEVPTCA/ICcnIDogRU9MO1xuXG4gICAgY29uZmlnRGF0YSArPVxuICAgICAgb3B0aW9ucy5wcm9maWxlID09PSBERUZBVUxUX1BST0ZJTEVcbiAgICAgICAgPyBgWyR7b3B0aW9ucy5wcm9maWxlfV0ke0VPTH1gXG4gICAgICAgIDogYFtwcm9maWxlICR7b3B0aW9ucy5wcm9maWxlfV0ke0VPTH1gO1xuICAgIGNvbmZpZ0RhdGEgKz0gYHJlZ2lvbiA9ICR7b3B0aW9ucy5yZWdpb259JHtFT0x9YDtcblxuICAgIGF3YWl0IGZzLmFwcGVuZEZpbGUoZmlsZVBhdGgsIGNvbmZpZ0RhdGEsIHsgbW9kZTogJzYwMCcgfSk7XG5cbiAgICAvLyB2YWxpZGF0ZSBhZnRlciB3cml0ZS4gSXQgaXMgdG8gZW5zdXJlIHRoaXMgZnVuY3Rpb24gaXMgY29tcGF0aWJsZSB3aXRoIHRoZSBjdXJyZW50IEFXUyBmb3JtYXQuXG4gICAgY29uc3QgcHJvZmlsZURhdGEgPSBhd2FpdCBsb2FkU2hhcmVkQ29uZmlnRmlsZXMoe1xuICAgICAgaWdub3JlQ2FjaGU6IHRydWUsXG4gICAgfSk7XG4gICAgY29uc3QgcmV0cmlldmVkUmVnaW9uID0gcHJvZmlsZURhdGEuY29uZmlnRmlsZT8uW29wdGlvbnMucHJvZmlsZV0/LnJlZ2lvbjtcbiAgICBpZiAocmV0cmlldmVkUmVnaW9uICE9PSBvcHRpb25zLnJlZ2lvbikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gY29uZmlndXJlIHRoZSBBV1MgY29uZmlnIGZpbGVgKTtcbiAgICB9XG4gIH07XG5cbiAgcHJpdmF0ZSBjcmVhdGVPckFwcGVuZEFXU0NyZWRlbnRpYWxGaWxlID0gYXN5bmMgKFxuICAgIG9wdGlvbnM6IENyZWRlbnRpYWxQcm9maWxlT3B0aW9uc1xuICApID0+IHtcbiAgICBjb25zdCBmaWxlUGF0aCA9XG4gICAgICBwcm9jZXNzLmVudi5BV1NfU0hBUkVEX0NSRURFTlRJQUxTX0ZJTEUgPz9cbiAgICAgIHBhdGguam9pbihnZXRIb21lRGlyKCksICcuYXdzJywgJ2NyZWRlbnRpYWxzJyk7XG5cbiAgICBjb25zdCBkaXJOYW1lID0gcGF0aC5kaXJuYW1lKGZpbGVQYXRoKTtcbiAgICBpZiAoIWV4aXN0c1N5bmMoZGlyTmFtZSkpIHtcbiAgICAgIGF3YWl0IGZzLm1rZGlyKGRpck5hbWUsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGZpbGVFbmRzV2l0aEVPTCA9IGF3YWl0IHRoaXMuaXNGaWxlRW5kc1dpdGhFT0woZmlsZVBhdGgpO1xuICAgIGxldCBjcmVkZW50aWFsRGF0YSA9IGZpbGVFbmRzV2l0aEVPTCA/ICcnIDogRU9MO1xuXG4gICAgY3JlZGVudGlhbERhdGEgKz0gYFske29wdGlvbnMucHJvZmlsZX1dJHtFT0x9YDtcbiAgICBjcmVkZW50aWFsRGF0YSArPSBgYXdzX2FjY2Vzc19rZXlfaWQgPSAke29wdGlvbnMuYWNjZXNzS2V5SWR9JHtFT0x9YDtcbiAgICBjcmVkZW50aWFsRGF0YSArPSBgYXdzX3NlY3JldF9hY2Nlc3Nfa2V5ID0gJHtvcHRpb25zLnNlY3JldEFjY2Vzc0tleX0ke0VPTH1gO1xuXG4gICAgYXdhaXQgZnMuYXBwZW5kRmlsZShmaWxlUGF0aCwgY3JlZGVudGlhbERhdGEsIHsgbW9kZTogJzYwMCcgfSk7XG5cbiAgICAvLyB2YWxpZGF0ZSBhZnRlciB3cml0ZS4gSXQgaXMgdG8gZW5zdXJlIHRoaXMgZnVuY3Rpb24gaXMgY29tcGF0aWJsZSB3aXRoIHRoZSBjdXJyZW50IEFXUyBmb3JtYXQuXG4gICAgY29uc3QgcHJvdmlkZXIgPSBmcm9tSW5pKHtcbiAgICAgIHByb2ZpbGU6IG9wdGlvbnMucHJvZmlsZSxcbiAgICAgIGlnbm9yZUNhY2hlOiB0cnVlLFxuICAgIH0pO1xuICAgIGNvbnN0IHJldHJpZXZlZENyZWRlbnRpYWxzID0gYXdhaXQgcHJvdmlkZXIoKTtcbiAgICBpZiAoXG4gICAgICByZXRyaWV2ZWRDcmVkZW50aWFscy5hY2Nlc3NLZXlJZCAhPT0gb3B0aW9ucy5hY2Nlc3NLZXlJZCB8fFxuICAgICAgcmV0cmlldmVkQ3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5ICE9PSBvcHRpb25zLnNlY3JldEFjY2Vzc0tleSB8fFxuICAgICAgcmV0cmlldmVkQ3JlZGVudGlhbHMuc2Vzc2lvblRva2VuXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBjb25maWd1cmUgdGhlIEFXUyBjcmVkZW50aWFscyBmaWxlYCk7XG4gICAgfVxuICB9O1xuXG4gIHByaXZhdGUgaXNGaWxlRW5kc1dpdGhFT0wgPSBhc3luYyAoZmlsZVBhdGg6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4gPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBkYXRhID0gYXdhaXQgZnMucmVhZEZpbGUoZmlsZVBhdGgsICd1dGYtOCcpO1xuICAgICAgcmV0dXJuIGRhdGEubGVuZ3RoID4gMCAmJiBkYXRhLnNsaWNlKC1FT0wubGVuZ3RoKSA9PT0gRU9MO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgY29uc3QgZXJyb3IgPSBlcnIgYXMgRXJyb3I7XG4gICAgICBpZiAoZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnRU5PRU5UJykpIHtcbiAgICAgICAgLy8gZmlsZSBkb2Vzbid0IGV4aXN0c1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIHRocm93IGVycjtcbiAgICB9XG4gIH07XG59XG4iXX0=