import { LogLevel, format, printer } from '@aws-amplify/cli-core';
import { AmplifyError } from '@aws-amplify/platform-core';
import { extractSubCommands } from './extract_sub_commands.js';
let hasAttachUnhandledExceptionListenersBeenCalled = false;
/**
 * Attaches process listeners to handle unhandled exceptions and rejections
 */
export const attachUnhandledExceptionListeners = (usageDataEmitter) => {
    if (hasAttachUnhandledExceptionListenersBeenCalled) {
        return;
    }
    process.on('unhandledRejection', (reason) => {
        process.exitCode = 1;
        if (reason instanceof Error) {
            void handleErrorSafe({ error: reason, usageDataEmitter });
        }
        else if (typeof reason === 'string') {
            void handleErrorSafe({ error: new Error(reason), usageDataEmitter });
        }
        else {
            void handleErrorSafe({
                error: new Error(`Unhandled rejection of type [${typeof reason}]`, {
                    cause: reason,
                }),
                usageDataEmitter,
            });
        }
    });
    process.on('uncaughtException', (error) => {
        process.exitCode = 1;
        void handleErrorSafe({ error, usageDataEmitter });
    });
    hasAttachUnhandledExceptionListenersBeenCalled = true;
};
/**
 * Generates a function that is intended to be used as a callback to yargs.fail()
 * All logic for actually handling errors should be delegated to handleError.
 *
 * For some reason the yargs object that is injected into the fail callback does not include all methods on the Argv type
 * This generator allows us to inject the yargs parser into the callback so that we can call parser.exit() from the failure handler
 * This prevents our top-level error handler from being invoked after the yargs error handler has already been invoked
 */
export const generateCommandFailureHandler = (parser, usageDataEmitter) => {
    /**
     * Format error output when a command fails
     * @param message error message set by the yargs:check validations
     * @param error error thrown by yargs handler
     */
    const handleCommandFailure = async (message, error) => {
        const printHelp = () => {
            printer.printNewLine();
            parser.showHelp();
            printer.printNewLine();
        };
        await handleErrorSafe({
            command: extractSubCommands(parser),
            printMessagePreamble: printHelp,
            error,
            message,
            usageDataEmitter,
        });
        parser.exit(1, error || new Error(message));
    };
    return handleCommandFailure;
};
const handleErrorSafe = async (props) => {
    try {
        await handleError(props);
    }
    catch (e) {
        printer.log(format.error(e), LogLevel.DEBUG);
        // no-op should gracefully exit
        return;
    }
};
/**
 * Error handling for uncaught errors during CLI command execution.
 *
 * This should be the one and only place where we handle unexpected errors.
 * This includes console logging, debug logging, metrics recording, etc.
 * (Note that we don't do all of those things yet, but this is where they should go)
 */
const handleError = async ({ error, printMessagePreamble, message, usageDataEmitter, command, }) => {
    // If yargs threw an error because the customer force-closed a prompt (ie Ctrl+C during a prompt) then the intent to exit the process is clear
    if (isUserForceClosePromptError(error)) {
        return;
    }
    printMessagePreamble?.();
    if (error instanceof AmplifyError) {
        printer.print(format.error(`${error.name}: ${error.message}`));
        if (error.resolution) {
            printer.print(`Resolution: ${error.resolution}`);
        }
        if (error.details) {
            printer.print(`Details: ${error.details}`);
        }
        if (errorHasCauseMessage(error)) {
            printer.print(`Cause: ${error.cause.message}`);
        }
    }
    else {
        // non-Amplify Error object
        printer.print(format.error(message || String(error)));
        if (errorHasCauseMessage(error)) {
            printer.print(`Cause: ${error.cause.message}`);
        }
    }
    // additional debug logging for the stack traces
    if (error?.stack) {
        printer.log(error.stack, LogLevel.DEBUG);
    }
    if (errorHasCauseStackTrace(error)) {
        printer.log(error.cause.stack, LogLevel.DEBUG);
    }
    await usageDataEmitter?.emitFailure(error instanceof AmplifyError
        ? error
        : AmplifyError.fromError(error && error instanceof Error ? error : new Error(message)), { command: command ?? 'UnknownCommand' });
};
const isUserForceClosePromptError = (err) => {
    return !!err && err?.message.includes('User force closed the prompt');
};
const errorHasCauseStackTrace = (error) => {
    return (typeof error?.cause === 'object' &&
        !!error.cause &&
        'stack' in error.cause &&
        typeof error.cause.stack === 'string');
};
const errorHasCauseMessage = (error) => {
    return (typeof error?.cause === 'object' &&
        !!error.cause &&
        'message' in error.cause &&
        typeof error.cause.message === 'string');
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXJyb3JfaGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9lcnJvcl9oYW5kbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRWxFLE9BQU8sRUFBRSxZQUFZLEVBQW9CLE1BQU0sNEJBQTRCLENBQUM7QUFDNUUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFFL0QsSUFBSSw4Q0FBOEMsR0FBRyxLQUFLLENBQUM7QUFVM0Q7O0dBRUc7QUFDSCxNQUFNLENBQUMsTUFBTSxpQ0FBaUMsR0FBRyxDQUMvQyxnQkFBa0MsRUFDNUIsRUFBRTtJQUNSLElBQUksOENBQThDLEVBQUU7UUFDbEQsT0FBTztLQUNSO0lBQ0QsT0FBTyxDQUFDLEVBQUUsQ0FBQyxvQkFBb0IsRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFFO1FBQzFDLE9BQU8sQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDO1FBQ3JCLElBQUksTUFBTSxZQUFZLEtBQUssRUFBRTtZQUMzQixLQUFLLGVBQWUsQ0FBQyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO1NBQzNEO2FBQU0sSUFBSSxPQUFPLE1BQU0sS0FBSyxRQUFRLEVBQUU7WUFDckMsS0FBSyxlQUFlLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO1NBQ3RFO2FBQU07WUFDTCxLQUFLLGVBQWUsQ0FBQztnQkFDbkIsS0FBSyxFQUFFLElBQUksS0FBSyxDQUFDLGdDQUFnQyxPQUFPLE1BQU0sR0FBRyxFQUFFO29CQUNqRSxLQUFLLEVBQUUsTUFBTTtpQkFDZCxDQUFDO2dCQUNGLGdCQUFnQjthQUNqQixDQUFDLENBQUM7U0FDSjtJQUNILENBQUMsQ0FBQyxD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QUMsS0FBSztRQUN0QixPQUFPLEtBQUssQ0FBQyxLQUFLLENBQUMsS0FBSyxLQUFLLFFBQVEsQ0FDdEMsQ0FBQztBQUNKLENBQUMsQ0FBQztBQUVGLE1BQU0sb0JBQW9CLEdBQUcsQ0FDM0IsS0FBYSxFQUNvQyxFQUFFO0lBQ25ELE9BQU8sQ0FDTCxPQUFPLEtBQUssRUFBRSxLQUFLLEtBQUssUUFBUTtRQUNoQyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUs7UUFDYixTQUFTLElBQUksS0FBSyxDQUFDLEtBQUs7UUFDeEIsT0FBTyxLQUFLLENBQUMsS0FBSyxDQUFDLE9BQU8sS0FBSyxRQUFRLENBQ3hDLENBQUM7QUFDSixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBMb2dMZXZlbCwgZm9ybWF0LCBwcmludGVyIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2NsaS1jb3JlJztcbmltcG9ydCB7IEFyZ3YgfSBmcm9tICd5YXJncyc7XG5pbXBvcnQgeyBBbXBsaWZ5RXJyb3IsIFVzYWdlRGF0YUVtaXR0ZXIgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5pbXBvcnQgeyBleHRyYWN0U3ViQ29tbWFuZHMgfSBmcm9tICcuL2V4dHJhY3Rfc3ViX2NvbW1hbmRzLmpzJztcblxubGV0IGhhc0F0dGFjaFVuaGFuZGxlZEV4Y2VwdGlvbkxpc3RlbmVyc0JlZW5DYWxsZWQgPSBmYWxzZTtcblxudHlwZSBIYW5kbGVFcnJvclByb3BzID0ge1xuICBlcnJvcj86IEVycm9yO1xuICBwcmludE1lc3NhZ2VQcmVhbWJsZT86ICgpID0+IHZvaWQ7XG4gIG1lc3NhZ2U/OiBzdHJpbmc7XG4gIHVzYWdlRGF0YUVtaXR0ZXI/OiBVc2FnZURhdGFFbWl0dGVyO1xuICBjb21tYW5kPzogc3RyaW5nO1xufTtcblxuLyoqXG4gKiBBdHRhY2hlcyBwcm9jZXNzIGxpc3RlbmVycyB0byBoYW5kbGUgdW5oYW5kbGVkIGV4Y2VwdGlvbnMgYW5kIHJlamVjdGlvbnNcbiAqL1xuZXhwb3J0IGNvbnN0IGF0dGFjaFVuaGFuZGxlZEV4Y2VwdGlvbkxpc3RlbmVycyA9IChcbiAgdXNhZ2VEYXRhRW1pdHRlcjogVXNhZ2VEYXRhRW1pdHRlclxuKTogdm9pZCA9PiB7XG4gIGlmIChoYXNBdHRhY2hVbmhhbmRsZWRFeGNlcHRpb25MaXN0ZW5lcnNCZWVuQ2FsbGVkKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIHByb2Nlc3Mub24oJ3VuaGFuZGxlZFJlamVjdGlvbicsIChyZWFzb24pID0+IHtcbiAgICBwcm9jZXNzLmV4aXRDb2RlID0gMTtcbiAgICBpZiAocmVhc29uIGluc3RhbmNlb2YgRXJyb3IpIHtcbiAgICAgIHZvaWQgaGFuZGxlRXJyb3JTYWZlKHsgZXJyb3I6IHJlYXNvbiwgdXNhZ2VEYXRhRW1pdHRlciB9KTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiByZWFzb24gPT09ICdzdHJpbmcnKSB7XG4gICAgICB2b2lkIGhhbmRsZUVycm9yU2FmZSh7IGVycm9yOiBuZXcgRXJyb3IocmVhc29uKSwgdXNhZ2VEYXRhRW1pdHRlciB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdm9pZCBoYW5kbGVFcnJvclNhZmUoe1xuICAgICAgICBlcnJvcjogbmV3IEVycm9yKGBVbmhhbmRsZWQgcmVqZWN0aW9uIG9mIHR5cGUgWyR7dHlwZW9mIHJlYXNvbn1dYCwge1xuICAgICAgICAgIGNhdXNlOiByZWFzb24sXG4gICAgICAgIH0pLFxuICAgICAgICB1c2FnZURhdGFFbWl0dGVyLFxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcblxuICBwcm9jZXNzLm9uKCd1bmNhdWdodEV4Y2VwdGlvbicsIChlcnJvcikgPT4ge1xuICAgIHByb2Nlc3MuZXhpdENvZGUgPSAxO1xuICAgIHZvaWQgaGFuZGxlRXJyb3JTYWZlKHsgZXJyb3IsIHVzYWdlRGF0YUVtaXR0ZXIgfSk7XG4gIH0pO1xuICBoYXNBdHRhY2hVbmhhbmRsZWRFeGNlcHRpb25MaXN0ZW5lcnNCZWVuQ2FsbGVkID0gdHJ1ZTtcbn07XG5cbi8qKlxuICogR2VuZXJhdGVzIGEgZnVuY3Rpb24gdGhhdCBpcyBpbnRlbmRlZCB0byBiZSB1c2VkIGFzIGEgY2FsbGJhY2sgdG8geWFyZ3MuZmFpbCgpXG4gKiBBbGwgbG9naWMgZm9yIGFjdHVhbGx5IGhhbmRsaW5nIGVycm9ycyBzaG91bGQgYmUgZGVsZWdhdGVkIHRvIGhhbmRsZUVycm9yLlxuICpcbiAqIEZvciBzb21lIHJlYXNvbiB0aGUgeWFyZ3Mgb2JqZWN0IHRoYXQgaXMgaW5qZWN0ZWQgaW50byB0aGUgZmFpbCBjYWxsYmFjayBkb2VzIG5vdCBpbmNsdWRlIGFsbCBtZXRob2RzIG9uIHRoZSBBcmd2IHR5cGVcbiAqIFRoaXMgZ2VuZXJhdG9yIGFsbG93cyB1cyB0byBpbmplY3QgdGhlIHlhcmdzIHBhcnNlciBpbnRvIHRoZSBjYWxsYmFjayBzbyB0aGF0IHdlIGNhbiBjYWxsIHBhcnNlci5leGl0KCkgZnJvbSB0aGUgZmFpbHVyZSBoYW5kbGVyXG4gKiBUaGlzIHByZXZlbnRzIG91ciB0b3AtbGV2ZWwgZXJyb3IgaGFuZGxlciBmcm9tIGJlaW5nIGludm9rZWQgYWZ0ZXIgdGhlIHlhcmdzIGVycm9yIGhhbmRsZXIgaGFzIGFscmVhZHkgYmVlbiBpbnZva2VkXG4gKi9cbmV4cG9ydCBjb25zdCBnZW5lcmF0ZUNvbW1hbmRGYWlsdXJlSGFuZGxlciA9IChcbiAgcGFyc2VyOiBBcmd2LFxuICB1c2FnZURhdGFFbWl0dGVyPzogVXNhZ2VEYXRhRW1pdHRlclxuKTogKChtZXNzYWdlOiBzdHJpbmcsIGVycm9yOiBFcnJvcikgPT4gUHJvbWlzZTx2b2lkPikgPT4ge1xuICAvKipcbiAgICogRm9ybWF0IGVycm9yIG91dHB1dCB3aGVuIGEgY29tbWFuZCBmYWlsc1xuICAgKiBAcGFyYW0gbWVzc2FnZSBlcnJvciBtZXNzYWdlIHNldCBieSB0aGUgeWFyZ3M6Y2hlY2sgdmFsaWRhdGlvbnNcbiAgICogQHBhcmFtIGVycm9yIGVycm9yIHRocm93biBieSB5YXJncyBoYW5kbGVyXG4gICAqL1xuICBjb25zdCBoYW5kbGVDb21tYW5kRmFpbHVyZSA9IGFzeW5jIChtZXNzYWdlOiBzdHJpbmcsIGVycm9yPzogRXJyb3IpID0+IHtcbiAgICBjb25zdCBwcmludEhlbHAgPSAoKSA9PiB7XG4gICAgICBwcmludGVyLnByaW50TmV3TGluZSgpO1xuICAgICAgcGFyc2VyLnNob3dIZWxwKCk7XG4gICAgICBwcmludGVyLnByaW50TmV3TGluZSgpO1xuICAgIH07XG4gICAgYXdhaXQgaGFuZGxlRXJyb3JTYWZlKHtcbiAgICAgIGNvbW1hbmQ6IGV4dHJhY3RTdWJDb21tYW5kcyhwYXJzZXIpLFxuICAgICAgcHJpbnRNZXNzYWdlUHJlYW1ibGU6IHByaW50SGVscCxcbiAgICAgIGVycm9yLFxuICAgICAgbWVzc2FnZSxcbiAgICAgIHVzYWdlRGF0YUVtaXR0ZXIsXG4gICAgfSk7XG4gICAgcGFyc2VyLmV4aXQoMSwgZXJyb3IgfHwgbmV3IEVycm9yKG1lc3NhZ2UpKTtcbiAgfTtcbiAgcmV0dXJuIGhhbmRsZUNvbW1hbmRGYWlsdXJlO1xufTtcblxuY29uc3QgaGFuZGxlRXJyb3JTYWZlID0gYXN5bmMgKHByb3BzOiBIYW5kbGVFcnJvclByb3BzKSA9PiB7XG4gIHRyeSB7XG4gICAgYXdhaXQgaGFuZGxlRXJyb3IocHJvcHMpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgcHJpbnRlci5sb2coZm9ybWF0LmVycm9yKGUpLCBMb2dMZXZlbC5ERUJVRyk7XG4gICAgLy8gbm8tb3Agc2hvdWxkIGdyYWNlZnVsbHkgZXhpdFxuICAgIHJldHVybjtcbiAgfVxufTtcblxuLyoqXG4gKiBFcnJvciBoYW5kbGluZyBmb3IgdW5jYXVnaHQgZXJyb3JzIGR1cmluZyBDTEkgY29tbWFuZCBleGVjdXRpb24uXG4gKlxuICogVGhpcyBzaG91bGQgYmUgdGhlIG9uZSBhbmQgb25seSBwbGFjZSB3aGVyZSB3ZSBoYW5kbGUgdW5leHBlY3RlZCBlcnJvcnMuXG4gKiBUaGlzIGluY2x1ZGVzIGNvbnNvbGUgbG9nZ2luZywgZGVidWcgbG9nZ2luZywgbWV0cmljcyByZWNvcmRpbmcsIGV0Yy5cbiAqIChOb3RlIHRoYXQgd2UgZG9uJ3QgZG8gYWxsIG9mIHRob3NlIHRoaW5ncyB5ZXQsIGJ1dCB0aGlzIGlzIHdoZXJlIHRoZXkgc2hvdWxkIGdvKVxuICovXG5jb25zdCBoYW5kbGVFcnJvciA9IGFzeW5jICh7XG4gIGVycm9yLFxuICBwcmludE1lc3NhZ2VQcmVhbWJsZSxcbiAgbWVzc2FnZSxcbiAgdXNhZ2VEYXRhRW1pdHRlcixcbiAgY29tbWFuZCxcbn06IEhhbmRsZUVycm9yUHJvcHMpID0+IHtcbiAgLy8gSWYgeWFyZ3MgdGhyZXcgYW4gZXJyb3IgYmVjYXVzZSB0aGUgY3VzdG9tZXIgZm9yY2UtY2xvc2VkIGEgcHJvbXB0IChpZSBDdHJsK0MgZHVyaW5nIGEgcHJvbXB0KSB0aGVuIHRoZSBpbnRlbnQgdG8gZXhpdCB0aGUgcHJvY2VzcyBpcyBjbGVhclxuICBpZiAoaXNVc2VyRm9yY2VDbG9zZVByb21wdEVycm9yKGVycm9yKSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIHByaW50TWVzc2FnZVByZWFtYmxlPy4oKTtcblxuICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBBbXBsaWZ5RXJyb3IpIHtcbiAgICBwcmludGVyLnByaW50KGZvcm1hdC5lcnJvcihgJHtlcnJvci5uYW1lfTogJHtlcnJvci5tZXNzYWdlfWApKTtcblxuICAgIGlmIChlcnJvci5yZXNvbHV0aW9uKSB7XG4gICAgICBwcmludGVyLnByaW50KGBSZXNvbHV0aW9uOiAke2Vycm9yLnJlc29sdXRpb259YCk7XG4gICAgfVxuICAgIGlmIChlcnJvci5kZXRhaWxzKSB7XG4gICAgICBwcmludGVyLnByaW50KGBEZXRhaWxzOiAke2Vycm9yLmRldGFpbHN9YCk7XG4gICAgfVxuICAgIGlmIChlcnJvckhhc0NhdXNlTWVzc2FnZShlcnJvcikpIHtcbiAgICAgIHByaW50ZXIucHJpbnQoYENhdXNlOiAke2Vycm9yLmNhdXNlLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIC8vIG5vbi1BbXBsaWZ5IEVycm9yIG9iamVjdFxuICAgIHByaW50ZXIucHJpbnQoZm9ybWF0LmVycm9yKG1lc3NhZ2UgfHwgU3RyaW5nKGVycm9yKSkpO1xuXG4gICAgaWYgKGVycm9ySGFzQ2F1c2VNZXNzYWdlKGVycm9yKSkge1xuICAgICAgcHJpbnRlci5wcmludChgQ2F1c2U6ICR7ZXJyb3IuY2F1c2UubWVzc2FnZX1gKTtcbiAgICB9XG4gIH1cblxuICAvLyBhZGRpdGlvbmFsIGRlYnVnIGxvZ2dpbmcgZm9yIHRoZSBzdGFjayB0cmFjZXNcbiAgaWYgKGVycm9yPy5zdGFjaykge1xuICAgIHByaW50ZXIubG9nKGVycm9yLnN0YWNrLCBMb2dMZXZlbC5ERUJVRyk7XG4gIH1cbiAgaWYgKGVycm9ySGFzQ2F1c2VTdGFja1RyYWNlKGVycm9yKSkge1xuICAgIHByaW50ZXIubG9nKGVycm9yLmNhdXNlLnN0YWNrLCBMb2dMZXZlbC5ERUJVRyk7XG4gIH1cblxuICBhd2FpdCB1c2FnZURhdGFFbWl0dGVyPy5lbWl0RmFpbHVyZShcbiAgICBlcnJvciBpbnN0YW5jZW9mIEFtcGxpZnlFcnJvclxuICAgICAgPyBlcnJvclxuICAgICAgOiBBbXBsaWZ5RXJyb3IuZnJvbUVycm9yKFxuICAgICAgICAgIGVycm9yICYmIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvciA6IG5ldyBFcnJvcihtZXNzYWdlKVxuICAgICAgICApLFxuICAgIHsgY29tbWFuZDogY29tbWFuZCA/PyAnVW5rbm93bkNvbW1hbmQnIH1cbiAgKTtcbn07XG5cbmNvbnN0IGlzVXNlckZvcmNlQ2xvc2VQcm9tcHRFcnJvciA9IChlcnI/OiBFcnJvcik6IGJvb2xlYW4gPT4ge1xuICByZXR1cm4gISFlcnIgJiYgZXJyPy5tZXNzYWdlLmluY2x1ZGVzKCdVc2VyIGZvcmNlIGNsb3NlZCB0aGUgcHJvbXB0Jyk7XG59O1xuXG5jb25zdCBlcnJvckhhc0NhdXNlU3RhY2tUcmFjZSA9IChcbiAgZXJyb3I/OiBFcnJvclxuKTogZXJyb3IgaXMgRXJyb3IgJiB7IGNhdXNlOiB7IHN0YWNrOiBzdHJpbmcgfSB9ID0+IHtcbiAgcmV0dXJuIChcbiAgICB0eXBlb2YgZXJyb3I/LmNhdXNlID09PSAnb2JqZWN0JyAmJlxuICAgICEhZXJyb3IuY2F1c2UgJiZcbiAgICAnc3RhY2snIGluIGVycm9yLmNhdXNlICYmXG4gICAgdHlwZW9mIGVycm9yLmNhdXNlLnN0YWNrID09PSAnc3RyaW5nJ1xuICApO1xufTtcblxuY29uc3QgZXJyb3JIYXNDYXVzZU1lc3NhZ2UgPSAoXG4gIGVycm9yPzogRXJyb3Jcbik6IGVycm9yIGlzIEVycm9yICYgeyBjYXVzZTogeyBtZXNzYWdlOiBzdHJpbmcgfSB9ID0+IHtcbiAgcmV0dXJuIChcbiAgICB0eXBlb2YgZXJyb3I/LmNhdXNlID09PSAnb2JqZWN0JyAmJlxuICAgICEhZXJyb3IuY2F1c2UgJiZcbiAgICAnbWVzc2FnZScgaW4gZXJyb3IuY2F1c2UgJiZcbiAgICB0eXBlb2YgZXJyb3IuY2F1c2UubWVzc2FnZSA9PT0gJ3N0cmluZydcbiAgKTtcbn07XG4iXX0=