import { Schedule } from 'aws-cdk-lib/aws-events';
import os from 'os';
/**
 * Parses function schedule props in order to create EventBridge rules.
 */
export const convertFunctionSchedulesToRuleSchedules = (lambda, functionSchedules) => {
    const errors = [];
    const ruleSchedules = [];
    const schedules = Array.isArray(functionSchedules)
        ? functionSchedules
        : [functionSchedules];
    schedules.forEach((schedule) => {
        if (isTimeInterval(schedule)) {
            const { value, unit } = parseTimeInterval(schedule);
            if (value && !isPositiveWholeNumber(value)) {
                errors.push('Function schedule rate must be set with a positive whole number');
            }
            else if (value &&
                lambda.timeout &&
                unit === 'm' &&
                value * 60 < lambda.timeout.toSeconds()) {
                const timeout = lambda.timeout.toSeconds();
                errors.push(`Function schedule rate must be greater than the function timeout of ${timeout} ${timeout > 1 ? 'seconds' : 'second'}`);
            }
        }
        else {
            const cronErrors = validateCron(schedule);
            if (cronErrors.length > 0) {
                errors.push(...cronErrors);
            }
        }
        if (errors.length === 0) {
            ruleSchedules.push(Schedule.cron(translateToCronOptions(schedule)));
        }
    });
    if (errors.length > 0) {
        throw new Error(errors.join(os.EOL));
    }
    return ruleSchedules;
};
const isTimeInterval = (schedule) => {
    const parts = schedule.split(' ');
    return (parts[0] === 'every' &&
        ['m', 'h', 'day', 'week', 'month', 'year'].some((a) => parts[1].endsWith(a)) &&
        parts.length === 2);
};
const parseTimeInterval = (timeInterval) => {
    const part = timeInterval.split(' ')[1];
    const value = part.match(/-?\d+\.?\d*/);
    const unit = part.match(/[a-zA-Z]+/);
    return {
        value: value ? Number(value[0]) : undefined,
        unit: unit ? unit[0] : undefined,
    };
};
const isPositiveWholeNumber = (test) => test > 0 && test % 1 === 0;
const validateCron = (cron) => {
    const errors = [];
    const cronParts = cron.split(' ');
    const [minute, hour, dayOfMonth, month, dayOfWeek, year] = cronParts;
    const minuteValidationErrors = validateCronPart('minutes', minute, 0, 59);
    const hourValidationErrors = validateCronPart('hours', hour, 0, 23);
    const dayOfMonthValidationErrors = dayOfMonth === '?'
        ? []
        : validateCronPart('day-of-month', dayOfMonth, 1, 31);
    const monthValidationErrors = validateCronPart('month', month, 1, 12);
    const dayOfWeekValidationErrors = dayOfWeek === '?' ? [] : validateCronPart('day-of-week', dayOfWeek, 1, 7);
    const yearValidationErrors = year
        ? validateCronPart('year', year, 1970, 2199)
        : [];
    errors.push(...minuteValidationErrors, ...hourValidationErrors, ...dayOfMonthValidationErrors, ...monthValidationErrors, ...dayOfWeekValidationErrors, ...yearValidationErrors);
    if (dayOfMonth !== '?' && dayOfWeek !== '?') {
        errors.push('Cron expressions cannot have both day-of-month and day-of-week defined, you must use a ? in one of the fields');
    }
    return errors;
};
const validateCronPart = (cronPart, value, min, max) => {
    const errors = [];
    if (value === '*') {
        return errors;
    }
    const hasStep = value.includes('/');
    const hasRange = value.includes('-');
    const hasList = value.includes(',');
    if (hasList) {
        const listError = validateList(cronPart, value, min, max);
        if (listError) {
            errors.push(listError);
        }
        const listItems = value.split(',');
        listItems.forEach((listItem) => {
            if (listItem.includes('/')) {
                const stepError = validateStepValue(cronPart, listItem, min, max);
                if (stepError) {
                    errors.push(stepError);
                }
            }
            else if (listItem.includes('-')) {
                const rangeError = validateRange(cronPart, listItem, min, max);
                if (rangeError) {
                    errors.push(rangeError);
                }
            }
        });
    }
    else if (hasStep) {
        const stepError = validateStepValue(cronPart, value, min, max);
        if (stepError) {
            errors.push(stepError);
        }
    }
    else if (hasRange) {
        const rangeError = validateRange(cronPart, value, min, max);
        if (rangeError) {
            errors.push(rangeError);
        }
    }
    if (!hasStep &&
        !hasRange &&
        !hasList &&
        !isWholeNumberBetweenInclusive(Number(value), min, max)) {
        errors.push(`Cron field for ${cronPart} must be a whole number between ${min} and ${max}`);
    }
    return errors;
};
const validateStepValue = (cronPart, value, min, max) => {
    const originalBase = value.split('/')[0];
    const [base, step] = value.split('/').map(Number);
    if (originalBase === '*') {
        if (isNaN(step) || step <= 0 || !isPositiveWholeNumber(step)) {
            return `Cron step values for ${cronPart} must be positive whole numbers`;
        }
    }
    else if (isNaN(base) ||
        isNaN(step) ||
        !isWholeNumberBetweenInclusive(base, min, max) ||
        step <= 0) {
        return `Cron step values for ${cronPart} must be whole numbers between ${min} and ${max}`;
    }
    return;
};
const validateRange = (cronPart, value, min, max) => {
    const [start, end] = value.split('-').map(Number);
    if (isNaN(start) ||
        isNaN(end) ||
        !isWholeNumberBetweenInclusive(start, min, max) ||
        !isWholeNumberBetweenInclusive(end, min, max) ||
        start > end) {
        return `Cron range for ${cronPart} must be whole numbers between ${min} and ${max}`;
    }
    return;
};
const validateList = (cronPart, value, min, max) => {
    if (!value
        .split(',')
        .every((v) => isWholeNumberBetweenInclusive(Number(v), min, max))) {
        return `Cron list for ${cronPart} must contain whole numbers between ${min} and ${max}`;
    }
    return;
};
const isWholeNumberBetweenInclusive = (test, min, max) => min <= test && test <= max && test % 1 === 0;
const translateToCronOptions = (schedule) => {
    if (isTimeInterval(schedule)) {
        const { value, unit } = parseTimeInterval(schedule);
        switch (unit) {
            case 'm':
                return { minute: `*/${value}` };
            case 'h':
                return { minute: '0', hour: `*/${value}` };
            case 'day':
                return { minute: '0', hour: '0', day: `*` };
            case 'week':
                return { minute: '0', hour: '0', weekDay: `1` };
            case 'month':
                return { minute: '0', hour: '0', day: '1', month: `*` };
            case 'year':
                return {
                    minute: '0',
                    hour: '0',
                    day: '1',
                    month: '1',
                    year: `*`,
                };
            default:
                // This should never happen with strict types
                throw new Error('Could not determine the schedule rate for the function');
        }
    }
    else {
        const cronArray = schedule.split(' ');
        const result = {
            minute: cronArray[0],
            hour: cronArray[1],
            month: cronArray[3],
            year: cronArray.length === 6 ? cronArray[5] : '*',
        };
        // Branching logic here is because we cannot supply both day and weekDay
        if (cronArray[2] === '?') {
            result.weekDay = cronArray[4];
        }
        else {
            result.day = cronArray[2];
        }
        return result;
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NoZWR1bGVfcGFyc2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3NjaGVkdWxlX3BhcnNlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWUsUUFBUSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFPL0QsT0FBTyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBVXBCOztHQUVHO0FBQ0gsTUFBTSxDQUFDLE1BQU0sdUNBQXVDLEdBQUcsQ0FDckQsTUFBc0IsRUFDdEIsaUJBQXdELEVBQ3hELEVBQUU7SUFDRixNQUFNLE1BQU0sR0FBYSxFQUFFLENBQUM7SUFDNUIsTUFBTSxhQUFhLEdBQWUsRUFBRSxDQUFDO0lBRXJDLE1BQU0sU0FBUyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsaUJBQWlCLENBQUM7UUFDaEQsQ0FBQyxDQUFDLGlCQUFpQjtRQUNuQixDQUFDLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0lBRXhCLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRTtRQUM3QixJQUFJLGNBQWMsQ0FBQyxRQUFRLENBQUMsRUFBRTtZQUM1QixNQUFNLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxHQUFHLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRXBELElBQUksS0FBSyxJQUFJLENBQUMscUJBQXFCLENBQUMsS0FBSyxDQUFDLEVBQUU7Z0JBQzFDLE1BQU0sQ0FBQyxJQUFJLENBQ1QsaUVBQWlFLENBQ2xFLENBQUM7YUFDSDtpQkFBTSxJQUNMLEtBQUs7Z0JBQ0wsTUFBTSxDQUFDLE9BQU87Z0JBQ2QsSUFBSSxLQUFLLEdBQUc7Z0JBQ1osS0FBSyxHQUFHLEVBQUUsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxFQUN2QztnQkFDQSxNQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxDQUFDO2dCQUMzQyxNQUFNLENBQUMsSUFBSSxD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R0FBRyxFQUFFLENBQUM7WUFDMUQsS0FBSyxNQUFNO2dCQUNULE9BQU87b0JBQ0wsTUFBTSxFQUFFLEdBQUc7b0JBQ1gsSUFBSSxFQUFFLEdBQUc7b0JBQ1QsR0FBRyxFQUFFLEdBQUc7b0JBQ1IsS0FBSyxFQUFFLEdBQUc7b0JBQ1YsSUFBSSxFQUFFLEdBQUc7aUJBQ1YsQ0FBQztZQUNKO2dCQUNFLDZDQUE2QztnQkFDN0MsTUFBTSxJQUFJLEtBQUssQ0FDYix3REFBd0QsQ0FDekQsQ0FBQztTQUNMO0tBQ0Y7U0FBTTtRQUNMLE1BQU0sU0FBUyxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdEMsTUFBTSxNQUFNLEdBQTJCO1lBQ3JDLE1BQU0sRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ3BCLElBQUksRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ2xCLEtBQUssRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ25CLElBQUksRUFBRSxTQUFTLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHO1NBQ2xELENBQUM7UUFFRix3RUFBd0U7UUFDeEUsSUFBSSxTQUFTLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxFQUFFO1lBQ3hCLE1BQU0sQ0FBQyxPQUFPLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQy9CO2FBQU07WUFDTCxNQUFNLENBQUMsR0FBRyxHQUFHLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUMzQjtRQUVELE9BQU8sTUFBTSxDQUFDO0tBQ2Y7QUFDSCxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDcm9uT3B0aW9ucywgU2NoZWR1bGUgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZXZlbnRzJztcbmltcG9ydCB7IE5vZGVqc0Z1bmN0aW9uIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYS1ub2RlanMnO1xuaW1wb3J0IHR5cGUge1xuICBDcm9uU2NoZWR1bGUsXG4gIEZ1bmN0aW9uU2NoZWR1bGUsXG4gIFRpbWVJbnRlcnZhbCxcbn0gZnJvbSAnLi9mYWN0b3J5LmpzJztcbmltcG9ydCBvcyBmcm9tICdvcyc7XG5cbnR5cGUgQ3JvblBhcnQgPVxuICB8ICdtaW51dGVzJ1xuICB8ICdob3VycydcbiAgfCAnZGF5LW9mLW1vbnRoJ1xuICB8ICdtb250aCdcbiAgfCAnZGF5LW9mLXdlZWsnXG4gIHwgJ3llYXInO1xuXG4vKipcbiAqIFBhcnNlcyBmdW5jdGlvbiBzY2hlZHVsZSBwcm9wcyBpbiBvcmRlciB0byBjcmVhdGUgRXZlbnRCcmlkZ2UgcnVsZXMuXG4gKi9cbmV4cG9ydCBjb25zdCBjb252ZXJ0RnVuY3Rpb25TY2hlZHVsZXNUb1J1bGVTY2hlZHVsZXMgPSAoXG4gIGxhbWJkYTogTm9kZWpzRnVuY3Rpb24sXG4gIGZ1bmN0aW9uU2NoZWR1bGVzOiBGdW5jdGlvblNjaGVkdWxlIHwgRnVuY3Rpb25TY2hlZHVsZVtdXG4pID0+IHtcbiAgY29uc3QgZXJyb3JzOiBzdHJpbmdbXSA9IFtdO1xuICBjb25zdCBydWxlU2NoZWR1bGVzOiBTY2hlZHVsZVtdID0gW107XG5cbiAgY29uc3Qgc2NoZWR1bGVzID0gQXJyYXkuaXNBcnJheShmdW5jdGlvblNjaGVkdWxlcylcbiAgICA/IGZ1bmN0aW9uU2NoZWR1bGVzXG4gICAgOiBbZnVuY3Rpb25TY2hlZHVsZXNdO1xuXG4gIHNjaGVkdWxlcy5mb3JFYWNoKChzY2hlZHVsZSkgPT4ge1xuICAgIGlmIChpc1RpbWVJbnRlcnZhbChzY2hlZHVsZSkpIHtcbiAgICAgIGNvbnN0IHsgdmFsdWUsIHVuaXQgfSA9IHBhcnNlVGltZUludGVydmFsKHNjaGVkdWxlKTtcblxuICAgICAgaWYgKHZhbHVlICYmICFpc1Bvc2l0aXZlV2hvbGVOdW1iZXIodmFsdWUpKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKFxuICAgICAgICAgICdGdW5jdGlvbiBzY2hlZHVsZSByYXRlIG11c3QgYmUgc2V0IHdpdGggYSBwb3NpdGl2ZSB3aG9sZSBudW1iZXInXG4gICAgICAgICk7XG4gICAgICB9IGVsc2UgaWYgKFxuICAgICAgICB2YWx1ZSAmJlxuICAgICAgICBsYW1iZGEudGltZW91dCAmJlxuICAgICAgICB1bml0ID09PSAnbScgJiZcbiAgICAgICAgdmFsdWUgKiA2MCA8IGxhbWJkYS50aW1lb3V0LnRvU2Vjb25kcygpXG4gICAgICApIHtcbiAgICAgICAgY29uc3QgdGltZW91dCA9IGxhbWJkYS50aW1lb3V0LnRvU2Vjb25kcygpO1xuICAgICAgICBlcnJvcnMucHVzaChcbiAgICAgICAgICBgRnVuY3Rpb24gc2NoZWR1bGUgcmF0ZSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB0aGUgZnVuY3Rpb24gdGltZW91dCBvZiAke3RpbWVvdXR9ICR7XG4gICAgICAgICAgICB0aW1lb3V0ID4gMSA/ICdzZWNvbmRzJyA6ICdzZWNvbmQnXG4gICAgICAgICAgfWBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgY3JvbkVycm9ycyA9IHZhbGlkYXRlQ3JvbihzY2hlZHVsZSk7XG5cbiAgICAgIGlmIChjcm9uRXJyb3JzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgZXJyb3JzLnB1c2goLi4uY3JvbkVycm9ycyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGVycm9ycy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJ1bGVTY2hlZHVsZXMucHVzaChTY2hlZHVsZS5jcm9uKHRyYW5zbGF0ZVRvQ3Jvbk9wdGlvbnMoc2NoZWR1bGUpKSk7XG4gICAgfVxuICB9KTtcblxuICBpZiAoZXJyb3JzLmxlbmd0aCA+IDApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JzLmpvaW4ob3MuRU9MKSk7XG4gIH1cblxuICByZXR1cm4gcnVsZVNjaGVkdWxlcztcbn07XG5cbmNvbnN0IGlzVGltZUludGVydmFsID0gKFxuICBzY2hlZHVsZTogRnVuY3Rpb25TY2hlZHVsZVxuKTogc2NoZWR1bGUgaXMgVGltZUludGVydmFsID0+IHtcbiAgY29uc3QgcGFydHMgPSBzY2hlZHVsZS5zcGxpdCgnICcpO1xuXG4gIHJldHVybiAoXG4gICAgcGFydHNbMF0gPT09ICdldmVyeScgJiZcbiAgICBbJ20nLCAnaCcsICdkYXknLCAnd2VlaycsICdtb250aCcsICd5ZWFyJ10uc29tZSgoYSkgPT5cbiAgICAgIHBhcnRzWzFdLmVuZHNXaXRoKGEpXG4gICAgKSAmJlxuICAgIHBhcnRzLmxlbmd0aCA9PT0gMlxuICApO1xufTtcblxuY29uc3QgcGFyc2VUaW1lSW50ZXJ2YWwgPSAodGltZUludGVydmFsOiBUaW1lSW50ZXJ2YWwpID0+IHtcbiAgY29uc3QgcGFydCA9IHRpbWVJbnRlcnZhbC5zcGxpdCgnICcpWzFdO1xuICBjb25zdCB2YWx1ZSA9IHBhcnQubWF0Y2goLy0/XFxkK1xcLj9cXGQqLyk7XG4gIGNvbnN0IHVuaXQgPSBwYXJ0Lm1hdGNoKC9bYS16QS1aXSsvKTtcblxuICByZXR1cm4ge1xuICAgIHZhbHVlOiB2YWx1ZSA/IE51bWJlcih2YWx1ZVswXSkgOiB1bmRlZmluZWQsXG4gICAgdW5pdDogdW5pdCA/IHVuaXRbMF0gOiB1bmRlZmluZWQsXG4gIH07XG59O1xuXG5jb25zdCBpc1Bvc2l0aXZlV2hvbGVOdW1iZXIgPSAodGVzdDogbnVtYmVyKSA9PiB0ZXN0ID4gMCAmJiB0ZXN0ICUgMSA9PT0gMDtcblxuY29uc3QgdmFsaWRhdGVDcm9uID0gKGNyb246IENyb25TY2hlZHVsZSkgPT4ge1xuICBjb25zdCBlcnJvcnM6IHN0cmluZ1tdID0gW107XG4gIGNvbnN0IGNyb25QYXJ0cyA9IGNyb24uc3BsaXQoJyAnKTtcblxuICBjb25zdCBbbWludXRlLCBob3VyLCBkYXlPZk1vbnRoLCBtb250aCwgZGF5T2ZXZWVrLCB5ZWFyXSA9IGNyb25QYXJ0cztcblxuICBjb25zdCBtaW51dGVWYWxpZGF0aW9uRXJyb3JzID0gdmFsaWRhdGVDcm9uUGFydCgnbWludXRlcycsIG1pbnV0ZSwgMCwgNTkpO1xuICBjb25zdCBob3VyVmFsaWRhdGlvbkVycm9ycyA9IHZhbGlkYXRlQ3JvblBhcnQoJ2hvdXJzJywgaG91ciwgMCwgMjMpO1xuICBjb25zdCBkYXlPZk1vbnRoVmFsaWRhdGlvbkVycm9ycyA9XG4gICAgZGF5T2ZNb250aCA9PT0gJz8nXG4gICAgICA/IFtdXG4gICAgICA6IHZhbGlkYXRlQ3JvblBhcnQoJ2RheS1vZi1tb250aCcsIGRheU9mTW9udGgsIDEsIDMxKTtcbiAgY29uc3QgbW9udGhWYWxpZGF0aW9uRXJyb3JzID0gdmFsaWRhdGVDcm9uUGFydCgnbW9udGgnLCBtb250aCwgMSwgMTIpO1xuICBjb25zdCBkYXlPZldlZWtWYWxpZGF0aW9uRXJyb3JzID1cbiAgICBkYXlPZldlZWsgPT09ICc/JyA/IFtdIDogdmFsaWRhdGVDcm9uUGFydCgnZGF5LW9mLXdlZWsnLCBkYXlPZldlZWssIDEsIDcpO1xuICBjb25zdCB5ZWFyVmFsaWRhdGlvbkVycm9ycyA9IHllYXJcbiAgICA/IHZhbGlkYXRlQ3JvblBhcnQoJ3llYXInLCB5ZWFyLCAxOTcwLCAyMTk5KVxuICAgIDogW107XG5cbiAgZXJyb3JzLnB1c2goXG4gICAgLi4ubWludXRlVmFsaWRhdGlvbkVycm9ycyxcbiAgICAuLi5ob3VyVmFsaWRhdGlvbkVycm9ycyxcbiAgICAuLi5kYXlPZk1vbnRoVmFsaWRhdGlvbkVycm9ycyxcbiAgICAuLi5tb250aFZhbGlkYXRpb25FcnJvcnMsXG4gICAgLi4uZGF5T2ZXZWVrVmFsaWRhdGlvbkVycm9ycyxcbiAgICAuLi55ZWFyVmFsaWRhdGlvbkVycm9yc1xuICApO1xuXG4gIGlmIChkYXlPZk1vbnRoICE9PSAnPycgJiYgZGF5T2ZXZWVrICE9PSAnPycpIHtcbiAgICBlcnJvcnMucHVzaChcbiAgICAgICdDcm9uIGV4cHJlc3Npb25zIGNhbm5vdCBoYXZlIGJvdGggZGF5LW9mLW1vbnRoIGFuZCBkYXktb2Ytd2VlayBkZWZpbmVkLCB5b3UgbXVzdCB1c2UgYSA/IGluIG9uZSBvZiB0aGUgZmllbGRzJ1xuICAgICk7XG4gIH1cblxuICByZXR1cm4gZXJyb3JzO1xufTtcblxuY29uc3QgdmFsaWRhdGVDcm9uUGFydCA9IChcbiAgY3JvblBhcnQ6IENyb25QYXJ0LFxuICB2YWx1ZTogc3RyaW5nLFxuICBtaW46IG51bWJlcixcbiAgbWF4OiBudW1iZXJcbikgPT4ge1xuICBjb25zdCBlcnJvcnM6IHN0cmluZ1tdID0gW107XG5cbiAgaWYgKHZhbHVlID09PSAnKicpIHtcbiAgICByZXR1cm4gZXJyb3JzO1xuICB9XG5cbiAgY29uc3QgaGFzU3RlcCA9IHZhbHVlLmluY2x1ZGVzKCcvJyk7XG4gIGNvbnN0IGhhc1JhbmdlID0gdmFsdWUuaW5jbHVkZXMoJy0nKTtcbiAgY29uc3QgaGFzTGlzdCA9IHZhbHVlLmluY2x1ZGVzKCcsJyk7XG5cbiAgaWYgKGhhc0xpc3QpIHtcbiAgICBjb25zdCBsaXN0RXJyb3IgPSB2YWxpZGF0ZUxpc3QoY3JvblBhcnQsIHZhbHVlLCBtaW4sIG1heCk7XG5cbiAgICBpZiAobGlzdEVycm9yKSB7XG4gICAgICBlcnJvcnMucHVzaChsaXN0RXJyb3IpO1xuICAgIH1cbiAgICBjb25zdCBsaXN0SXRlbXMgPSB2YWx1ZS5zcGxpdCgnLCcpO1xuXG4gICAgbGlzdEl0ZW1zLmZvckVhY2goKGxpc3RJdGVtKSA9PiB7XG4gICAgICBpZiAobGlzdEl0ZW0uaW5jbHVkZXMoJy8nKSkge1xuICAgICAgICBjb25zdCBzdGVwRXJyb3IgPSB2YWxpZGF0ZVN0ZXBWYWx1ZShjcm9uUGFydCwgbGlzdEl0ZW0sIG1pbiwgbWF4KTtcblxuICAgICAgICBpZiAoc3RlcEVycm9yKSB7XG4gICAgICAgICAgZXJyb3JzLnB1c2goc3RlcEVycm9yKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChsaXN0SXRlbS5pbmNsdWRlcygnLScpKSB7XG4gICAgICAgIGNvbnN0IHJhbmdlRXJyb3IgPSB2YWxpZGF0ZVJhbmdlKGNyb25QYXJ0LCBsaXN0SXRlbSwgbWluLCBtYXgpO1xuXG4gICAgICAgIGlmIChyYW5nZUVycm9yKSB7XG4gICAgICAgICAgZXJyb3JzLnB1c2gocmFuZ2VFcnJvcik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfSBlbHNlIGlmIChoYXNTdGVwKSB7XG4gICAgY29uc3Qgc3RlcEVycm9yID0gdmFsaWRhdGVTdGVwVmFsdWUoY3JvblBhcnQsIHZhbHVlLCBtaW4sIG1heCk7XG5cbiAgICBpZiAoc3RlcEVycm9yKSB7XG4gICAgICBlcnJvcnMucHVzaChzdGVwRXJyb3IpO1xuICAgIH1cbiAgfSBlbHNlIGlmIChoYXNSYW5nZSkge1xuICAgIGNvbnN0IHJhbmdlRXJyb3IgPSB2YWxpZGF0ZVJhbmdlKGNyb25QYXJ0LCB2YWx1ZSwgbWluLCBtYXgpO1xuXG4gICAgaWYgKHJhbmdlRXJyb3IpIHtcbiAgICAgIGVycm9ycy5wdXNoKHJhbmdlRXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChcbiAgICAhaGFzU3RlcCAmJlxuICAgICFoYXNSYW5nZSAmJlxuICAgICFoYXNMaXN0ICYmXG4gICAgIWlzV2hvbGVOdW1iZXJCZXR3ZWVuSW5jbHVzaXZlKE51bWJlcih2YWx1ZSksIG1pbiwgbWF4KVxuICApIHtcbiAgICBlcnJvcnMucHVzaChcbiAgICAgIGBDcm9uIGZpZWxkIGZvciAke2Nyb25QYXJ0fSBtdXN0IGJlIGEgd2hvbGUgbnVtYmVyIGJldHdlZW4gJHttaW59IGFuZCAke21heH1gXG4gICAgKTtcbiAgfVxuXG4gIHJldHVybiBlcnJvcnM7XG59O1xuXG5jb25zdCB2YWxpZGF0ZVN0ZXBWYWx1ZSA9IChcbiAgY3JvblBhcnQ6IENyb25QYXJ0LFxuICB2YWx1ZTogc3RyaW5nLFxuICBtaW46IG51bWJlcixcbiAgbWF4OiBudW1iZXJcbikgPT4ge1xuICBjb25zdCBvcmlnaW5hbEJhc2UgPSB2YWx1ZS5zcGxpdCgnLycpWzBdO1xuICBjb25zdCBbYmFzZSwgc3RlcF0gPSB2YWx1ZS5zcGxpdCgnLycpLm1hcChOdW1iZXIpO1xuXG4gIGlmIChvcmlnaW5hbEJhc2UgPT09ICcqJykge1xuICAgIGlmIChpc05hTihzdGVwKSB8fCBzdGVwIDw9IDAgfHwgIWlzUG9zaXRpdmVXaG9sZU51bWJlcihzdGVwKSkge1xuICAgICAgcmV0dXJuIGBDcm9uIHN0ZXAgdmFsdWVzIGZvciAke2Nyb25QYXJ0fSBtdXN0IGJlIHBvc2l0aXZlIHdob2xlIG51bWJlcnNgO1xuICAgIH1cbiAgfSBlbHNlIGlmIChcbiAgICBpc05hTihiYXNlKSB8fFxuICAgIGlzTmFOKHN0ZXApIHx8XG4gICAgIWlzV2hvbGVOdW1iZXJCZXR3ZWVuSW5jbHVzaXZlKGJhc2UsIG1pbiwgbWF4KSB8fFxuICAgIHN0ZXAgPD0gMFxuICApIHtcbiAgICByZXR1cm4gYENyb24gc3RlcCB2YWx1ZXMgZm9yICR7Y3JvblBhcnR9IG11c3QgYmUgd2hvbGUgbnVtYmVycyBiZXR3ZWVuICR7bWlufSBhbmQgJHttYXh9YDtcbiAgfVxuXG4gIHJldHVybjtcbn07XG5cbmNvbnN0IHZhbGlkYXRlUmFuZ2UgPSAoXG4gIGNyb25QYXJ0OiBDcm9uUGFydCxcbiAgdmFsdWU6IHN0cmluZyxcbiAgbWluOiBudW1iZXIsXG4gIG1heDogbnVtYmVyXG4pID0+IHtcbiAgY29uc3QgW3N0YXJ0LCBlbmRdID0gdmFsdWUuc3BsaXQoJy0nKS5tYXAoTnVtYmVyKTtcblxuICBpZiAoXG4gICAgaXNOYU4oc3RhcnQpIHx8XG4gICAgaXNOYU4oZW5kKSB8fFxuICAgICFpc1dob2xlTnVtYmVyQmV0d2VlbkluY2x1c2l2ZShzdGFydCwgbWluLCBtYXgpIHx8XG4gICAgIWlzV2hvbGVOdW1iZXJCZXR3ZWVuSW5jbHVzaXZlKGVuZCwgbWluLCBtYXgpIHx8XG4gICAgc3RhcnQgPiBlbmRcbiAgKSB7XG4gICAgcmV0dXJuIGBDcm9uIHJhbmdlIGZvciAke2Nyb25QYXJ0fSBtdXN0IGJlIHdob2xlIG51bWJlcnMgYmV0d2VlbiAke21pbn0gYW5kICR7bWF4fWA7XG4gIH1cblxuICByZXR1cm47XG59O1xuXG5jb25zdCB2YWxpZGF0ZUxpc3QgPSAoXG4gIGNyb25QYXJ0OiBDcm9uUGFydCxcbiAgdmFsdWU6IHN0cmluZyxcbiAgbWluOiBudW1iZXIsXG4gIG1heDogbnVtYmVyXG4pID0+IHtcbiAgaWYgKFxuICAgICF2YWx1ZVxuICAgICAgLnNwbGl0KCcsJylcbiAgICAgIC5ldmVyeSgodikgPT4gaXNXaG9sZU51bWJlckJldHdlZW5JbmNsdXNpdmUoTnVtYmVyKHYpLCBtaW4sIG1heCkpXG4gICkge1xuICAgIHJldHVybiBgQ3JvbiBsaXN0IGZvciAke2Nyb25QYXJ0fSBtdXN0IGNvbnRhaW4gd2hvbGUgbnVtYmVycyBiZXR3ZWVuICR7bWlufSBhbmQgJHttYXh9YDtcbiAgfVxuXG4gIHJldHVybjtcbn07XG5cbmNvbnN0IGlzV2hvbGVOdW1iZXJCZXR3ZWVuSW5jbHVzaXZlID0gKFxuICB0ZXN0OiBudW1iZXIsXG4gIG1pbjogbnVtYmVyLFxuICBtYXg6IG51bWJlclxuKSA9PiBtaW4gPD0gdGVzdCAmJiB0ZXN0IDw9IG1heCAmJiB0ZXN0ICUgMSA9PT0gMDtcblxuY29uc3QgdHJhbnNsYXRlVG9Dcm9uT3B0aW9ucyA9IChzY2hlZHVsZTogRnVuY3Rpb25TY2hlZHVsZSk6IENyb25PcHRpb25zID0+IHtcbiAgaWYgKGlzVGltZUludGVydmFsKHNjaGVkdWxlKSkge1xuICAgIGNvbnN0IHsgdmFsdWUsIHVuaXQgfSA9IHBhcnNlVGltZUludGVydmFsKHNjaGVkdWxlKTtcbiAgICBzd2l0Y2ggKHVuaXQpIHtcbiAgICAgIGNhc2UgJ20nOlxuICAgICAgICByZXR1cm4geyBtaW51dGU6IGAqLyR7dmFsdWV9YCB9O1xuICAgICAgY2FzZSAnaCc6XG4gICAgICAgIHJldHVybiB7IG1pbnV0ZTogJzAnLCBob3VyOiBgKi8ke3ZhbHVlfWAgfTtcbiAgICAgIGNhc2UgJ2RheSc6XG4gICAgICAgIHJldHVybiB7IG1pbnV0ZTogJzAnLCBob3VyOiAnMCcsIGRheTogYCpgIH07XG4gICAgICBjYXNlICd3ZWVrJzpcbiAgICAgICAgcmV0dXJuIHsgbWludXRlOiAnMCcsIGhvdXI6ICcwJywgd2Vla0RheTogYDFgIH07XG4gICAgICBjYXNlICdtb250aCc6XG4gICAgICAgIHJldHVybiB7IG1pbnV0ZTogJzAnLCBob3VyOiAnMCcsIGRheTogJzEnLCBtb250aDogYCpgIH07XG4gICAgICBjYXNlICd5ZWFyJzpcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBtaW51dGU6ICcwJyxcbiAgICAgICAgICBob3VyOiAnMCcsXG4gICAgICAgICAgZGF5OiAnMScsXG4gICAgICAgICAgbW9udGg6ICcxJyxcbiAgICAgICAgICB5ZWFyOiBgKmAsXG4gICAgICAgIH07XG4gICAgICBkZWZhdWx0OlxuICAgICAgICAvLyBUaGlzIHNob3VsZCBuZXZlciBoYXBwZW4gd2l0aCBzdHJpY3QgdHlwZXNcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICdDb3VsZCBub3QgZGV0ZXJtaW5lIHRoZSBzY2hlZHVsZSByYXRlIGZvciB0aGUgZnVuY3Rpb24nXG4gICAgICAgICk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGNvbnN0IGNyb25BcnJheSA9IHNjaGVkdWxlLnNwbGl0KCcgJyk7XG4gICAgY29uc3QgcmVzdWx0OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge1xuICAgICAgbWludXRlOiBjcm9uQXJyYXlbMF0sXG4gICAgICBob3VyOiBjcm9uQXJyYXlbMV0sXG4gICAgICBtb250aDogY3JvbkFycmF5WzNdLFxuICAgICAgeWVhcjogY3JvbkFycmF5Lmxlbmd0aCA9PT0gNiA/IGNyb25BcnJheVs1XSA6ICcqJyxcbiAgICB9O1xuXG4gICAgLy8gQnJhbmNoaW5nIGxvZ2ljIGhlcmUgaXMgYmVjYXVzZSB3ZSBjYW5ub3Qgc3VwcGx5IGJvdGggZGF5IGFuZCB3ZWVrRGF5XG4gICAgaWYgKGNyb25BcnJheVsyXSA9PT0gJz8nKSB7XG4gICAgICByZXN1bHQud2Vla0RheSA9IGNyb25BcnJheVs0XTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVzdWx0LmRheSA9IGNyb25BcnJheVsyXTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG59O1xuIl19