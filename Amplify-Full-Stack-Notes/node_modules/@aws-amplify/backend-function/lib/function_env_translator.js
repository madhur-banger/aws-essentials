import { Arn, Lazy, Stack } from 'aws-cdk-lib';
import { Effect, PolicyStatement } from 'aws-cdk-lib/aws-iam';
import { AmplifyUserError } from '@aws-amplify/platform-core';
/**
 * Translates function environment props into appropriate environment records and builds a policy statement
 * in order to resolve secrets in environment props.
 */
export class FunctionEnvironmentTranslator {
    lambda;
    functionEnvironmentProp;
    backendSecretResolver;
    functionEnvironmentTypeGenerator;
    ssmPaths = [];
    ssmEnvVars = {};
    amplifySsmEnvConfigKey = 'AMPLIFY_SSM_ENV_CONFIG';
    ssmValuePlaceholderText = '<value will be resolved during runtime>';
    // List of environment variable names for typed shim generation
    amplifyBackendEnvVarNames = [];
    /**
     * Initialize translated environment variable records
     */
    constructor(lambda, // we need to use a specific type here so that we have all the method goodies
    functionEnvironmentProp, backendSecretResolver, functionEnvironmentTypeGenerator) {
        this.lambda = lambda;
        this.functionEnvironmentProp = functionEnvironmentProp;
        this.backendSecretResolver = backendSecretResolver;
        this.functionEnvironmentTypeGenerator = functionEnvironmentTypeGenerator;
        for (const [key, value] of Object.entries(this.functionEnvironmentProp)) {
            this.addEnvironmentEntry(key, value);
        }
        // add an environment variable for ssm parameter metadata that is resolved after initialization but before synth is finalized
        this.lambda.addEnvironment(this.amplifySsmEnvConfigKey, Lazy.string({
            produce: () => JSON.stringify(this.ssmEnvVars),
        }));
        this.lambda.node.addValidation({
            validate: () => {
                // only add the ssm access policy if there are ssm paths
                if (this.ssmPaths.length > 0) {
                    const ssmAccessPolicy = new PolicyStatement({
                        effect: Effect.ALLOW,
                        actions: ['ssm:GetParameters'],
                        resources: this.ssmPaths
                            .map((path) => (path.startsWith('/') ? path.slice(1) : path)) // the Arn formatter will add a leading slash between the resource and resourceName
                            .map((path) => Arn.format({
                            service: 'ssm',
                            resource: 'parameter',
                            resourceName: path,
                        }, Stack.of(this.lambda))),
                    });
                    this.lambda.grantPrincipal.addToPrincipalPolicy(ssmAccessPolicy);
                }
                return [];
            },
        });
        // Using CDK validation mechanism as a way to generate a typed process.env shim file at the end of synthesis
        this.lambda.node.addValidation({
            validate: () => {
                this.functionEnvironmentTypeGenerator.generateTypedProcessEnvShim(this.amplifyBackendEnvVarNames);
                return [];
            },
        });
    }
    /**
     * Adds an environment variable to the lambda to be used at runtime
     * @param key The environment variable name
     * @param value envVar value that can be a plain text or a secret
     */
    addEnvironmentEntry = (key, value) => {
        {
            if (key === this.amplifySsmEnvConfigKey) {
                throw new Error(`${this.amplifySsmEnvConfigKey} is a reserved environment variable name`);
            }
            if (typeof value === 'undefined') {
                throw new AmplifyUserError('InvalidFunctionConfigurationError', {
                    message: `The value of environment variable ${key} is undefined.`,
                    resolution: `Ensure that all defineFunction environment variables are defined.`,
                });
            }
            else if (typeof value === 'string') {
                this.lambda.addEnvironment(key, value);
            }
            else {
                const { branchSecretPath, sharedSecretPath } = this.backendSecretResolver.resolvePath(value);
                this.lambda.addEnvironment(key, this.ssmValuePlaceholderText);
                this.ssmEnvVars[branchSecretPath] = {
                    name: key,
                    sharedPath: sharedSecretPath,
                };
                this.ssmPaths.push(branchSecretPath, sharedSecretPath);
            }
            this.amplifyBackendEnvVarNames.push(key);
        }
    };
    /**
     * Adds an environment variable to the lambda whose value will be fetched from SSM at runtime
     * @param name The environment variable name
     * @param ssmPath The SSM path where the value is stored
     */
    addSsmEnvironmentEntry = (name, ssmPath) => {
        this.lambda.addEnvironment(name, this.ssmValuePlaceholderText);
        this.ssmPaths.push(ssmPath);
        this.ssmEnvVars[ssmPath] = { name };
        this.amplifyBackendEnvVarNames.push(name);
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnVuY3Rpb25fZW52X3RyYW5zbGF0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZnVuY3Rpb25fZW52X3RyYW5zbGF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBSUEsT0FBTyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRy9DLE9BQU8sRUFBRSxNQUFNLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFOUQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFFOUQ7OztHQUdHO0FBQ0gsTUFBTSxPQUFPLDZCQUE2QjtJQWVyQjtJQUNBO0lBQ0E7SUFDQTtJQWpCRixRQUFRLEdBQWEsRUFBRSxDQUFDO0lBQ3hCLFVBQVUsR0FBZSxFQUFFLENBQUM7SUFFNUIsc0JBQXNCLEdBQUcsd0JBQXdCLENBQUM7SUFDbEQsdUJBQXVCLEdBQ3RDLHlDQUF5QyxDQUFDO0lBRTVDLCtEQUErRDtJQUM5Qyx5QkFBeUIsR0FBYSxFQUFFLENBQUM7SUFFMUQ7O09BRUc7SUFDSCxZQUNtQixNQUFzQixFQUFFLDZFQUE2RTtJQUNyRyx1QkFBK0QsRUFDL0QscUJBQTRDLEVBQzVDLGdDQUFrRTtRQUhsRSxXQUFNLEdBQU4sTUFBTSxDQUFnQjtRQUN0Qiw0QkFBdUIsR0FBdkIsdUJBQXVCLENBQXdDO1FBQy9ELDBCQUFxQixHQUFyQixxQkFBcUIsQ0FBdUI7UUFDNUMscUNBQWdDLEdBQWhDLGdDQUFnQyxDQUFrQztRQUVuRixLQUFLLE1BQU0sQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsdUJBQXVCLENBQUMsRUFBRTtZQUN2RSxJQUFJLENBQUMsbUJBQW1CLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQ3RDO1FBRUQsNkhBQTZIO1FBQzdILElBQUksQ0FBQyxNQUFNLENBQUMsY0FB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LEVBQUUsZ0JBQWdCO2lCQUM3QixDQUFDO2dCQUNGLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLGdCQUFnQixDQUFDLENBQUM7YUFDeEQ7WUFDRCxJQUFJLENBQUMseUJBQXlCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQzFDO0lBQ0gsQ0FBQyxDQUFDO0lBRUY7Ozs7T0FJRztJQUNILHNCQUFzQixHQUFHLENBQUMsSUFBWSxFQUFFLE9BQWUsRUFBRSxFQUFFO1FBQ3pELElBQUksQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsdUJBQXVCLENBQUMsQ0FBQztRQUMvRCxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUM1QixJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLENBQUM7UUFDcEMsSUFBSSxDQUFDLHlCQUF5QixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM1QyxDQUFDLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEJhY2tlbmRTZWNyZXQsXG4gIEJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQgeyBBcm4sIExhenksIFN0YWNrIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgRnVuY3Rpb25Qcm9wcyB9IGZyb20gJy4vZmFjdG9yeS5qcyc7XG5pbXBvcnQgeyBOb2RlanNGdW5jdGlvbiB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEtbm9kZWpzJztcbmltcG9ydCB7IEVmZmVjdCwgUG9saWN5U3RhdGVtZW50IH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSc7XG5pbXBvcnQgeyBGdW5jdGlvbkVudmlyb25tZW50VHlwZUdlbmVyYXRvciB9IGZyb20gJy4vZnVuY3Rpb25fZW52X3R5cGVfZ2VuZXJhdG9yLmpzJztcbmltcG9ydCB7IEFtcGxpZnlVc2VyRXJyb3IgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5cbi8qKlxuICogVHJhbnNsYXRlcyBmdW5jdGlvbiBlbnZpcm9ubWVudCBwcm9wcyBpbnRvIGFwcHJvcHJpYXRlIGVudmlyb25tZW50IHJlY29yZHMgYW5kIGJ1aWxkcyBhIHBvbGljeSBzdGF0ZW1lbnRcbiAqIGluIG9yZGVyIHRvIHJlc29sdmUgc2VjcmV0cyBpbiBlbnZpcm9ubWVudCBwcm9wcy5cbiAqL1xuZXhwb3J0IGNsYXNzIEZ1bmN0aW9uRW52aXJvbm1lbnRUcmFuc2xhdG9yIHtcbiAgcHJpdmF0ZSByZWFkb25seSBzc21QYXRoczogc3RyaW5nW10gPSBbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBzc21FbnZWYXJzOiBTc21FbnZWYXJzID0ge307XG5cbiAgcHJpdmF0ZSByZWFkb25seSBhbXBsaWZ5U3NtRW52Q29uZmlnS2V5ID0gJ0FNUExJRllfU1NNX0VOVl9DT05GSUcnO1xuICBwcml2YXRlIHJlYWRvbmx5IHNzbVZhbHVlUGxhY2Vob2xkZXJUZXh0ID1cbiAgICAnPHZhbHVlIHdpbGwgYmUgcmVzb2x2ZWQgZHVyaW5nIHJ1bnRpbWU+JztcblxuICAvLyBMaXN0IG9mIGVudmlyb25tZW50IHZhcmlhYmxlIG5hbWVzIGZvciB0eXBlZCBzaGltIGdlbmVyYXRpb25cbiAgcHJpdmF0ZSByZWFkb25seSBhbXBsaWZ5QmFja2VuZEVudlZhck5hbWVzOiBzdHJpbmdbXSA9IFtdO1xuXG4gIC8qKlxuICAgKiBJbml0aWFsaXplIHRyYW5zbGF0ZWQgZW52aXJvbm1lbnQgdmFyaWFibGUgcmVjb3Jkc1xuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBsYW1iZGE6IE5vZGVqc0Z1bmN0aW9uLCAvLyB3ZSBuZWVkIHRvIHVzZSBhIHNwZWNpZmljIHR5cGUgaGVyZSBzbyB0aGF0IHdlIGhhdmUgYWxsIHRoZSBtZXRob2QgZ29vZGllc1xuICAgIHByaXZhdGUgcmVhZG9ubHkgZnVuY3Rpb25FbnZpcm9ubWVudFByb3A6IFJlcXVpcmVkPEZ1bmN0aW9uUHJvcHM+WydlbnZpcm9ubWVudCddLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYmFja2VuZFNlY3JldFJlc29sdmVyOiBCYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gICAgcHJpdmF0ZSByZWFkb25seSBmdW5jdGlvbkVudmlyb25tZW50VHlwZUdlbmVyYXRvcjogRnVuY3Rpb25FbnZpcm9ubWVudFR5cGVHZW5lcmF0b3JcbiAgKSB7XG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXModGhpcy5mdW5jdGlvbkVudmlyb25tZW50UHJvcCkpIHtcbiAgICAgIHRoaXMuYWRkRW52aXJvbm1lbnRFbnRyeShrZXksIHZhbHVlKTtcbiAgICB9XG5cbiAgICAvLyBhZGQgYW4gZW52aXJvbm1lbnQgdmFyaWFibGUgZm9yIHNzbSBwYXJhbWV0ZXIgbWV0YWRhdGEgdGhhdCBpcyByZXNvbHZlZCBhZnRlciBpbml0aWFsaXphdGlvbiBidXQgYmVmb3JlIHN5bnRoIGlzIGZpbmFsaXplZFxuICAgIHRoaXMubGFtYmRhLmFkZEVudmlyb25tZW50KFxuICAgICAgdGhpcy5hbXBsaWZ5U3NtRW52Q29uZmlnS2V5LFxuICAgICAgTGF6eS5zdHJpbmcoe1xuICAgICAgICBwcm9kdWNlOiAoKSA9PiBKU09OLnN0cmluZ2lmeSh0aGlzLnNzbUVudlZhcnMpLFxuICAgICAgfSlcbiAgICApO1xuXG4gICAgdGhpcy5sYW1iZGEubm9kZS5hZGRWYWxpZGF0aW9uKHtcbiAgICAgIHZhbGlkYXRlOiAoKSA9PiB7XG4gICAgICAgIC8vIG9ubHkgYWRkIHRoZSBzc20gYWNjZXNzIHBvbGljeSBpZiB0aGVyZSBhcmUgc3NtIHBhdGhzXG4gICAgICAgIGlmICh0aGlzLnNzbVBhdGhzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBjb25zdCBzc21BY2Nlc3NQb2xpY3kgPSBuZXcgUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgIGVmZmVjdDogRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgYWN0aW9uczogWydzc206R2V0UGFyYW1ldGVycyddLFxuICAgICAgICAgICAgcmVzb3VyY2VzOiB0aGlzLnNzbVBhdGhzXG4gICAgICAgICAgICAgIC5tYXAoKHBhdGgpID0+IChwYXRoLnN0YXJ0c1dpdGgoJy8nKSA/IHBhdGguc2xpY2UoMSkgOiBwYXRoKSkgLy8gdGhlIEFybiBmb3JtYXR0ZXIgd2lsbCBhZGQgYSBsZWFkaW5nIHNsYXNoIGJldHdlZW4gdGhlIHJlc291cmNlIGFuZCByZXNvdXJjZU5hbWVcbiAgICAgICAgICAgICAgLm1hcCgocGF0aCkgPT5cbiAgICAgICAgICAgICAgICBBcm4uZm9ybWF0KFxuICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlOiAnc3NtJyxcbiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2U6ICdwYXJhbWV0ZXInLFxuICAgICAgICAgICAgICAgICAgICByZXNvdXJjZU5hbWU6IHBhdGgsXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgU3RhY2sub2YodGhpcy5sYW1iZGEpXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICApLFxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHRoaXMubGFtYmRhLmdyYW50UHJpbmNpcGFsLmFkZFRvUHJpbmNpcGFsUG9saWN5KHNzbUFjY2Vzc1BvbGljeSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIFVzaW5nIENESyB2YWxpZGF0aW9uIG1lY2hhbmlzbSBhcyBhIHdheSB0byBnZW5lcmF0ZSBhIHR5cGVkIHByb2Nlc3MuZW52IHNoaW0gZmlsZSBhdCB0aGUgZW5kIG9mIHN5bnRoZXNpc1xuICAgIHRoaXMubGFtYmRhLm5vZGUuYWRkVmFsaWRhdGlvbih7XG4gICAgICB2YWxpZGF0ZTogKCk6IHN0cmluZ1tdID0+IHtcbiAgICAgICAgdGhpcy5mdW5jdGlvbkVudmlyb25tZW50VHlwZUdlbmVyYXRvci5nZW5lcmF0ZVR5cGVkUHJvY2Vzc0VudlNoaW0oXG4gICAgICAgICAgdGhpcy5hbXBsaWZ5QmFja2VuZEVudlZhck5hbWVzXG4gICAgICAgICk7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQWRkcyBhbiBlbnZpcm9ubWVudCB2YXJpYWJsZSB0byB0aGUgbGFtYmRhIHRvIGJlIHVzZWQgYXQgcnVudGltZVxuICAgKiBAcGFyYW0ga2V5IFRoZSBlbnZpcm9ubWVudCB2YXJpYWJsZSBuYW1lXG4gICAqIEBwYXJhbSB2YWx1ZSBlbnZWYXIgdmFsdWUgdGhhdCBjYW4gYmUgYSBwbGFpbiB0ZXh0IG9yIGEgc2VjcmV0XG4gICAqL1xuICBhZGRFbnZpcm9ubWVudEVudHJ5ID0gKGtleTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nIHwgQmFja2VuZFNlY3JldCkgPT4ge1xuICAgIHtcbiAgICAgIGlmIChrZXkgPT09IHRoaXMuYW1wbGlmeVNzbUVudkNvbmZpZ0tleSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYCR7dGhpcy5hbXBsaWZ5U3NtRW52Q29uZmlnS2V5fSBpcyBhIHJlc2VydmVkIGVudmlyb25tZW50IHZhcmlhYmxlIG5hbWVgXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcignSW52YWxpZEZ1bmN0aW9uQ29uZmlndXJhdGlvbkVycm9yJywge1xuICAgICAgICAgIG1lc3NhZ2U6IGBUaGUgdmFsdWUgb2YgZW52aXJvbm1lbnQgdmFyaWFibGUgJHtrZXl9IGlzIHVuZGVmaW5lZC5gLFxuICAgICAgICAgIHJlc29sdXRpb246IGBFbnN1cmUgdGhhdCBhbGwgZGVmaW5lRnVuY3Rpb24gZW52aXJvbm1lbnQgdmFyaWFibGVzIGFyZSBkZWZpbmVkLmAsXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHRoaXMubGFtYmRhLmFkZEVudmlyb25tZW50KGtleSwgdmFsdWUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgeyBicmFuY2hTZWNyZXRQYXRoLCBzaGFyZWRTZWNyZXRQYXRoIH0gPVxuICAgICAgICAgIHRoaXMuYmFja2VuZFNlY3JldFJlc29sdmVyLnJlc29sdmVQYXRoKHZhbHVlKTtcbiAgICAgICAgdGhpcy5sYW1iZGEuYWRkRW52aXJvbm1lbnQoa2V5LCB0aGlzLnNzbVZhbHVlUGxhY2Vob2xkZXJUZXh0KTtcbiAgICAgICAgdGhpcy5zc21FbnZWYXJzW2JyYW5jaFNlY3JldFBhdGhdID0ge1xuICAgICAgICAgIG5hbWU6IGtleSxcbiAgICAgICAgICBzaGFyZWRQYXRoOiBzaGFyZWRTZWNyZXRQYXRoLFxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnNzbVBhdGhzLnB1c2goYnJhbmNoU2VjcmV0UGF0aCwgc2hhcmVkU2VjcmV0UGF0aCk7XG4gICAgICB9XG4gICAgICB0aGlzLmFtcGxpZnlCYWNrZW5kRW52VmFyTmFtZXMucHVzaChrZXkpO1xuICAgIH1cbiAgfTtcblxuICAvKipcbiAgICogQWRkcyBhbiBlbnZpcm9ubWVudCB2YXJpYWJsZSB0byB0aGUgbGFtYmRhIHdob3NlIHZhbHVlIHdpbGwgYmUgZmV0Y2hlZCBmcm9tIFNTTSBhdCBydW50aW1lXG4gICAqIEBwYXJhbSBuYW1lIFRoZSBlbnZpcm9ubWVudCB2YXJpYWJsZSBuYW1lXG4gICAqIEBwYXJhbSBzc21QYXRoIFRoZSBTU00gcGF0aCB3aGVyZSB0aGUgdmFsdWUgaXMgc3RvcmVkXG4gICAqL1xuICBhZGRTc21FbnZpcm9ubWVudEVudHJ5ID0gKG5hbWU6IHN0cmluZywgc3NtUGF0aDogc3RyaW5nKSA9PiB7XG4gICAgdGhpcy5sYW1iZGEuYWRkRW52aXJvbm1lbnQobmFtZSwgdGhpcy5zc21WYWx1ZVBsYWNlaG9sZGVyVGV4dCk7XG4gICAgdGhpcy5zc21QYXRocy5wdXNoKHNzbVBhdGgpO1xuICAgIHRoaXMuc3NtRW52VmFyc1tzc21QYXRoXSA9IHsgbmFtZSB9O1xuICAgIHRoaXMuYW1wbGlmeUJhY2tlbmRFbnZWYXJOYW1lcy5wdXNoKG5hbWUpO1xuICB9O1xufVxuXG4vKipcbiAqIERlZmluZXMgbWV0YWRhdGEgYXJvdW5kIGVudmlyb25tZW50IHZhcmlhYmxlIHZhbHVlcyB0aGF0IGFyZSBmZXRjaGVkIGZyb20gU1NNIGR1cmluZyBydW50aW1lIG9mIHRoZSBsYW1iZGEgZnVuY3Rpb25cbiAqL1xuZXhwb3J0IHR5cGUgU3NtRW52VmFycyA9IHtcbiAgLyoqXG4gICAqIFRoZSByZWNvcmQga2V5IG5hbWVzIGFyZSB0aGUgYnJhbmNoLXNwZWNpZmljIFNTTSBwYXRocyB0byBmZXRjaCB0aGUgdmFsdWUgZnJvbVxuICAgKi9cbiAgW2JyYW5jaFBhdGg6IHN0cmluZ106IHtcbiAgICAvKipcbiAgICAgKiBUaGUgZW52aXJvbm1lbnQgdmFyaWFibGUgbmFtZSB0byBwbGFjZSB0aGUgcmVzb2x2ZWQgdmFsdWUgaW5cbiAgICAgKi9cbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgLyoqXG4gICAgICogQW4gb3B0aW9uYWwgXCJmYWxsYmFja1wiIFNTTSBwYXRoIHdoZXJlIHRoZSB2YWx1ZSB3aWxsIGJlIGxvb2tlZCB1cCBpZiBub3QgZm91bmQgYXQgdGhlIGJyYW5jaC1zcGVjaWZpYyBwYXRoXG4gICAgICovXG4gICAgc2hhcmVkUGF0aD86IHN0cmluZztcbiAgfTtcbn07XG4iXX0=