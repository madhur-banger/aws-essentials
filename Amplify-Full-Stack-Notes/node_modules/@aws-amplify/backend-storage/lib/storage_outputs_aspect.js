import { storageOutputKey, } from '@aws-amplify/backend-output-schemas';
import { AmplifyUserError } from '@aws-amplify/platform-core';
import { Stack } from 'aws-cdk-lib';
import { AmplifyStorage } from './construct.js';
/**
 * Aspect to store the storage outputs in the backend
 */
export class StorageOutputsAspect {
    isStorageProcessed = false;
    outputStorageStrategy;
    /**
     * Constructs a new instance of the StorageValidator class.
     */
    constructor(outputStorageStrategy) {
        this.outputStorageStrategy = outputStorageStrategy;
    }
    /**
     * Visit the given node.
     * If the node is an AmplifyStorage construct, we will traverse its siblings in the same stack
     * @param node The node to visit.
     */
    visit(node) {
        if (!(node instanceof AmplifyStorage) || this.isStorageProcessed) {
            return;
        }
        /**
         * only traverse the siblings once to store the outputs,
         * storing the same outputs multiple times result in error
         */
        this.isStorageProcessed = true;
        const storageInstances = Stack.of(node).node.children.filter((el) => el instanceof AmplifyStorage);
        const storageCount = storageInstances.length;
        let defaultStorageFound = false;
        Stack.of(node).node.children.forEach((child) => {
            if (!(child instanceof AmplifyStorage)) {
                return;
            }
            if (child.isDefault && !defaultStorageFound) {
                defaultStorageFound = true;
            }
            else if (child.isDefault && defaultStorageFound) {
                throw new AmplifyUserError('MultipleDefaultStorageError', {
                    message: `More than one default storage set in the Amplify project.`,
                    resolution: 'Remove `isDefault: true` from all `defineStorage` calls except for one in your Amplify project.',
                });
            }
        });
        /*
         * If there is no default bucket set and there is only one bucket,
         * we need to set the bucket as default.
         */
        if (!defaultStorageFound && storageCount === 1) {
            this.storeOutput(this.outputStorageStrategy, true, node);
        }
        else if (!defaultStorageFound && storageCount > 1) {
            throw new AmplifyUserError('NoDefaultStorageError', {
                message: 'No default storage set in the Amplify project.',
                resolution: 'Add `isDefault: true` to one of the `defineStorage` calls in your Amplify project.',
            });
        }
        else {
            Stack.of(node).node.children.forEach((child) => {
                if (!(child instanceof AmplifyStorage)) {
                    return;
                }
                this.storeOutput(this.outputStorageStrategy, child.isDefault, child);
            });
        }
    }
    storeOutput = (outputStorageStrategy, isDefault = false, node) => {
        if (isDefault) {
            outputStorageStrategy.addBackendOutputEntry(storageOutputKey, {
                version: '1',
                payload: {
                    storageRegion: Stack.of(node).region,
                    bucketName: node.resources.bucket.bucketName,
                },
            });
        }
        const bucketsPayload = {
            name: node.name,
            bucketName: node.resources.bucket.bucketName,
            storageRegion: Stack.of(node).region,
        };
        if (node.accessDefinition) {
            bucketsPayload.paths = node.accessDefinition;
        }
        // both default and non-default buckets should have the name, bucket name, and storage region stored in `buckets` field
        outputStorageStrategy.appendToBackendOutputList(storageOutputKey, {
            version: '1',
            payload: {
                buckets: JSON.stringify(bucketsPayload),
            },
        });
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmFnZV9vdXRwdXRzX2FzcGVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zdG9yYWdlX291dHB1dHNfYXNwZWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFFTCxnQkFBZ0IsR0FDakIsTUFBTSxxQ0FBcUMsQ0FBQztBQUM3QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUU5RCxPQUFPLEVBQVcsS0FBSyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRTdDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUdoRDs7R0FFRztBQUNILE1BQU0sT0FBTyxvQkFBb0I7SUFDL0Isa0JBQWtCLEdBQUcsS0FBSyxDQUFDO0lBQzNCLHFCQUFxQixDQUFDO0lBQ3RCOztPQUVHO0lBQ0gsWUFDRSxxQkFBa0U7UUFFbEUsSUFBSSxDQUFDLHFCQUFxQixHQUFHLHFCQUFxQixDQUFDO0lBQ3JELENBQUM7SUFFRDs7OztPQUlHO0lBQ0ksS0FBSyxDQUFDLElBQWdCO1FBQzNCLElBQUksQ0FBQyxDQUFDLElBQUksWUFBWSxjQUFjLENBQUMsSUFBSSxJQUFJLENBQUMsa0JBQWtCLEVBQUU7WUFDaEUsT0FBTztTQUNSO1FBQ0Q7OztXQUdHO1FBQ0gsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQztRQUUvQixNQUFNLGdCQUFnQixHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQzFELENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLFlBQVksY0FBYyxDQUNyQyxDQUFDO1FBQ0YsTUFBTSxZQUFZLEdBQUcsZ0JBQWdCLENBQUMsTUFBTSxDQUFDO1FBRTdDLElBQUksbUJBQW1CLEdBQUcsS0FBSyxDQUFDO1FBRWhDLEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZQUM3QyxJQUFJLENBQUMsQ0FBQyxLQUFLLFlBQVksY0FBYyxDQUFDLEVBQUU7Z0JBQ3RDLE9BQU87YUFDUjtZQUNELElBQUksS0FBSyxDQUFDLFNBQVMsSUFBSSxDQUFDLG1CQUFtQixFQUFFO2dCQUMzQyxtQkFBbUIsR0FBRyxJQUFJLENBQUM7YUFDNUI7aUJBQU0sSUFBSSxLQUFLLENBQUMsU0FBUyxJQUFJLG1CQUFtQixFQUFFO2dCQUNqRCxNQUFNLElBQUksZ0JBQWdCLENBQUMsNkJBQTZCLEVBQUU7b0JBQ3hELE9BQU8sRUFBRSwyREFBMkQ7b0JBQ3BFLFVBQVUsRUFDUixpR0FBaUc7aUJBQ3BHLENBQUMsQ0FBQzthQUNKO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDSDs7O1dBR0c7UUFDSCxJQUFJLENBQUMsbUJBQW1CLElBQUksWUFBWSxLQUFLLENBQUMsRUFBRTtZQUM5QyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDMUQ7YUFBTSxJQUFJLENBQUMsbUJBQW1CLElBQUksWUFBWSxHQUFHLENBQUMsRUFBRTtZQUNuRCxNQUFNLElBQUksZ0JBQWdCLENBQUMsdUJBQXVCLEVBQUU7Z0JBQ2xELE9BQU8sRUFBRSxnREFBZ0Q7Z0JBQ3pELFVBQVUsRUFDUixvRkFBb0Y7YUFDdkYsQ0FBQyxDQUFDO1NBQ0o7YUFBTTtZQUNMLEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtnQkFDN0MsSUFBSSxDQUFDLENBQUMsS0FBSyxZQUFZLGNBQWMsQ0FBQyxFQUFFO29CQUN0QyxPQUFPO2lCQUNSO2dCQUNELElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLHFCQUFxQixFQUFFLEtBQUssQ0FBQyxTQUFTLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDdkUsQ0FBQyxDQUFDLENBQUM7U0FDSjtJQUNILENBQUM7SUFFTyxXQUFXLEdBQUcsQ0FDcEIscUJBQWtFLEVBQ2xFLFlBQXFCLEtBQUssRUFDMUIsSUFBb0IsRUFDZCxFQUFFO1FBQ1IsSUFBSSxTQUFTLEVBQUU7WUFDYixxQkFBcUIsQ0FBQyxxQkFBcUIsQ0FBQyxnQkFBZ0IsRUFBRTtnQkFDNUQsT0FBTyxFQUFFLEdBQUc7Z0JBQ1osT0FBTyxFQUFFO29CQUNQLGFBQWEsRUFBRSxLQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU07b0JBQ3BDLFVBQVUsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxVQUFVO2lCQUM3QzthQUNGLENBQUMsQ0FBQztTQUNKO1FBQ0QsTUFBTSxjQUFjLEdBR2hCO1lBQ0YsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJO1lBQ2YsVUFBVSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFVBQVU7WUFDNUMsYUFBYSxFQUFFLEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTTtTQUNyQyxDQUFDO1FBQ0YsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7WUFDekIsY0FBYyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUM7U0FDOUM7UUFDRCx1SEFBdUg7UUFDdkgscUJBQXFCLENBQUMseUJBQXlCLENBQUMsZ0JBQWdCLEVBQUU7WUFDaEUsT0FBTyxFQUFFLEdBQUc7WUFDWixPQUFPLEVBQUU7Z0JBQ1AsT0FBTyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDO2FBQ3hDO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDO0NBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBTdG9yYWdlT3V0cHV0LFxuICBzdG9yYWdlT3V0cHV0S2V5LFxufSBmcm9tICdAYXdzLWFtcGxpZnkvYmFja2VuZC1vdXRwdXQtc2NoZW1hcyc7XG5pbXBvcnQgeyBBbXBsaWZ5VXNlckVycm9yIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsYXRmb3JtLWNvcmUnO1xuaW1wb3J0IHsgQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneSB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHsgSUFzcGVjdCwgU3RhY2sgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgeyBJQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgeyBBbXBsaWZ5U3RvcmFnZSB9IGZyb20gJy4vY29uc3RydWN0LmpzJztcbmltcG9ydCB7IFN0b3JhZ2VBY2Nlc3NEZWZpbml0aW9uT3V0cHV0IH0gZnJvbSAnLi9wcml2YXRlX3R5cGVzLmpzJztcblxuLyoqXG4gKiBBc3BlY3QgdG8gc3RvcmUgdGhlIHN0b3JhZ2Ugb3V0cHV0cyBpbiB0aGUgYmFja2VuZFxuICovXG5leHBvcnQgY2xhc3MgU3RvcmFnZU91dHB1dHNBc3BlY3QgaW1wbGVtZW50cyBJQXNwZWN0IHtcbiAgaXNTdG9yYWdlUHJvY2Vzc2VkID0gZmFsc2U7XG4gIG91dHB1dFN0b3JhZ2VTdHJhdGVneTtcbiAgLyoqXG4gICAqIENvbnN0cnVjdHMgYSBuZXcgaW5zdGFuY2Ugb2YgdGhlIFN0b3JhZ2VWYWxpZGF0b3IgY2xhc3MuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3k6IEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3k8U3RvcmFnZU91dHB1dD5cbiAgKSB7XG4gICAgdGhpcy5vdXRwdXRTdG9yYWdlU3RyYXRlZ3kgPSBvdXRwdXRTdG9yYWdlU3RyYXRlZ3k7XG4gIH1cblxuICAvKipcbiAgICogVmlzaXQgdGhlIGdpdmVuIG5vZGUuXG4gICAqIElmIHRoZSBub2RlIGlzIGFuIEFtcGxpZnlTdG9yYWdlIGNvbnN0cnVjdCwgd2Ugd2lsbCB0cmF2ZXJzZSBpdHMgc2libGluZ3MgaW4gdGhlIHNhbWUgc3RhY2tcbiAgICogQHBhcmFtIG5vZGUgVGhlIG5vZGUgdG8gdmlzaXQuXG4gICAqL1xuICBwdWJsaWMgdmlzaXQobm9kZTogSUNvbnN0cnVjdCk6IHZvaWQge1xuICAgIGlmICghKG5vZGUgaW5zdGFuY2VvZiBBbXBsaWZ5U3RvcmFnZSkgfHwgdGhpcy5pc1N0b3JhZ2VQcm9jZXNzZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgLyoqXG4gICAgICogb25seSB0cmF2ZXJzZSB0aGUgc2libGluZ3Mgb25jZSB0byBzdG9yZSB0aGUgb3V0cHV0cyxcbiAgICAgKiBzdG9yaW5nIHRoZSBzYW1lIG91dHB1dHMgbXVsdGlwbGUgdGltZXMgcmVzdWx0IGluIGVycm9yXG4gICAgICovXG4gICAgdGhpcy5pc1N0b3JhZ2VQcm9jZXNzZWQgPSB0cnVlO1xuXG4gICAgY29uc3Qgc3RvcmFnZUluc3RhbmNlcyA9IFN0YWNrLm9mKG5vZGUpLm5vZGUuY2hpbGRyZW4uZmlsdGVyKFxuICAgICAgKGVsKSA9PiBlbCBpbnN0YW5jZW9mIEFtcGxpZnlTdG9yYWdlXG4gICAgKTtcbiAgICBjb25zdCBzdG9yYWdlQ291bnQgPSBzdG9yYWdlSW5zdGFuY2VzLmxlbmd0aDtcblxuICAgIGxldCBkZWZhdWx0U3RvcmFnZUZvdW5kID0gZmFsc2U7XG5cbiAgICBTdGFjay5vZihub2RlKS5ub2RlLmNoaWxkcmVuLmZvckVhY2goKGNoaWxkKSA9PiB7XG4gICAgICBpZiAoIShjaGlsZCBpbnN0YW5jZW9mIEFtcGxpZnlTdG9yYWdlKSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBpZiAoY2hpbGQuaXNEZWZhdWx0ICYmICFkZWZhdWx0U3RvcmFnZUZvdW5kKSB7XG4gICAgICAgIGRlZmF1bHRTdG9yYWdlRm91bmQgPSB0cnVlO1xuICAgICAgfSBlbHNlIGlmIChjaGlsZC5pc0RlZmF1bHQgJiYgZGVmYXVsdFN0b3JhZ2VGb3VuZCkge1xuICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcignTXVsdGlwbGVEZWZhdWx0U3RvcmFnZUVycm9yJywge1xuICAgICAgICAgIG1lc3NhZ2U6IGBNb3JlIHRoYW4gb25lIGRlZmF1bHQgc3RvcmFnZSBzZXQgaW4gdGhlIEFtcGxpZnkgcHJvamVjdC5gLFxuICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAnUmVtb3ZlIGBpc0RlZmF1bHQ6IHRydWVgIGZyb20gYWxsIGBkZWZpbmVTdG9yYWdlYCBjYWxscyBleGNlcHQgZm9yIG9uZSBpbiB5b3VyIEFtcGxpZnkgcHJvamVjdC4nLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICAvKlxuICAgICAqIElmIHRoZXJlIGlzIG5vIGRlZmF1bHQgYnVja2V0IHNldCBhbmQgdGhlcmUgaXMgb25seSBvbmUgYnVja2V0LFxuICAgICAqIHdlIG5lZWQgdG8gc2V0IHRoZSBidWNrZXQgYXMgZGVmYXVsdC5cbiAgICAgKi9cbiAgICBpZiAoIWRlZmF1bHRTdG9yYWdlRm91bmQgJiYgc3RvcmFnZUNvdW50ID09PSAxKSB7XG4gICAgICB0aGlzLnN0b3JlT3V0cHV0KHRoaXMub3V0cHV0U3RvcmFnZVN0cmF0ZWd5LCB0cnVlLCBub2RlKTtcbiAgICB9IGVsc2UgaWYgKCFkZWZhdWx0U3RvcmFnZUZvdW5kICYmIHN0b3JhZ2VDb3VudCA+IDEpIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdOb0RlZmF1bHRTdG9yYWdlRXJyb3InLCB7XG4gICAgICAgIG1lc3NhZ2U6ICdObyBkZWZhdWx0IHN0b3JhZ2Ugc2V0IGluIHRoZSBBbXBsaWZ5IHByb2plY3QuJyxcbiAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAnQWRkIGBpc0RlZmF1bHQ6IHRydWVgIHRvIG9uZSBvZiB0aGUgYGRlZmluZVN0b3JhZ2VgIGNhbGxzIGluIHlvdXIgQW1wbGlmeSBwcm9qZWN0LicsXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgU3RhY2sub2Yobm9kZSkubm9kZS5jaGlsZHJlbi5mb3JFYWNoKChjaGlsZCkgPT4ge1xuICAgICAgICBpZiAoIShjaGlsZCBpbnN0YW5jZW9mIEFtcGxpZnlTdG9yYWdlKSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnN0b3JlT3V0cHV0KHRoaXMub3V0cHV0U3RvcmFnZVN0cmF0ZWd5LCBjaGlsZC5pc0RlZmF1bHQsIGNoaWxkKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc3RvcmVPdXRwdXQgPSAoXG4gICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5OiBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5PFN0b3JhZ2VPdXRwdXQ+LFxuICAgIGlzRGVmYXVsdDogYm9vbGVhbiA9IGZhbHNlLFxuICAgIG5vZGU6IEFtcGxpZnlTdG9yYWdlXG4gICk6IHZvaWQgPT4ge1xuICAgIGlmIChpc0RlZmF1bHQpIHtcbiAgICAgIG91dHB1dFN0b3JhZ2VTdHJhdGVneS5hZGRCYWNrZW5kT3V0cHV0RW50cnkoc3RvcmFnZU91dHB1dEtleSwge1xuICAgICAgICB2ZXJzaW9uOiAnMScsXG4gICAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgICBzdG9yYWdlUmVnaW9uOiBTdGFjay5vZihub2RlKS5yZWdpb24sXG4gICAgICAgICAgYnVja2V0TmFtZTogbm9kZS5yZXNvdXJjZXMuYnVja2V0LmJ1Y2tldE5hbWUsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9XG4gICAgY29uc3QgYnVja2V0c1BheWxvYWQ6IFJlY29yZDxcbiAgICAgIHN0cmluZyxcbiAgICAgIHN0cmluZyB8IFN0b3JhZ2VBY2Nlc3NEZWZpbml0aW9uT3V0cHV0XG4gICAgPiA9IHtcbiAgICAgIG5hbWU6IG5vZGUubmFtZSxcbiAgICAgIGJ1Y2tldE5hbWU6IG5vZGUucmVzb3VyY2VzLmJ1Y2tldC5idWNrZXROYW1lLFxuICAgICAgc3RvcmFnZVJlZ2lvbjogU3RhY2sub2Yobm9kZSkucmVnaW9uLFxuICAgIH07XG4gICAgaWYgKG5vZGUuYWNjZXNzRGVmaW5pdGlvbikge1xuICAgICAgYnVja2V0c1BheWxvYWQucGF0aHMgPSBub2RlLmFjY2Vzc0RlZmluaXRpb247XG4gICAgfVxuICAgIC8vIGJvdGggZGVmYXVsdCBhbmQgbm9uLWRlZmF1bHQgYnVja2V0cyBzaG91bGQgaGF2ZSB0aGUgbmFtZSwgYnVja2V0IG5hbWUsIGFuZCBzdG9yYWdlIHJlZ2lvbiBzdG9yZWQgaW4gYGJ1Y2tldHNgIGZpZWxkXG4gICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5LmFwcGVuZFRvQmFja2VuZE91dHB1dExpc3Qoc3RvcmFnZU91dHB1dEtleSwge1xuICAgICAgdmVyc2lvbjogJzEnLFxuICAgICAgcGF5bG9hZDoge1xuICAgICAgICBidWNrZXRzOiBKU09OLnN0cmluZ2lmeShidWNrZXRzUGF5bG9hZCksXG4gICAgICB9LFxuICAgIH0pO1xuICB9O1xufVxuIl19