import { AmplifyDataDefinition, } from '@aws-amplify/data-construct';
import { resolveEntryPath } from './resolve_entry_path.js';
import { readFileSync } from 'fs';
/**
 * Determine if the input schema is a derived typed schema object (data-schema), and perform type narrowing.
 * @param schema the schema that might be a derived model schema
 * @returns a boolean indicating whether the schema is a derived model schema, with type narrowing
 */
export const isDataSchema = (schema) => {
    return (schema !== null &&
        typeof schema === 'object' &&
        'transform' in schema &&
        typeof schema.transform === 'function');
};
/**
 * Determine if the input schema is a collection of typed schemas, and perform type narrowing.
 * @param schema the schema that might be a collection of model schemas
 * @returns a boolean indicating whether the schema is a collection of derived model schema, with type narrowing
 */
export const isCombinedSchema = (schema) => {
    return (schema !== null &&
        typeof schema === 'object' &&
        'schemas' in schema &&
        Array.isArray(schema.schemas));
};
// DO NOT EDIT THE FOLLOWING VALUES, UPDATES TO DB TYPE OR STRATEGY WILL RESULT IN DB REPROVISIONING
// Conforms to this interface: https://github.com/aws-amplify/amplify-category-api/blob/274d1176d96e265d02817a975848c767d6d43c31/packages/amplify-graphql-api-construct/src/model-datasource-strategy-types.ts#L35-L41
const DYNAMO_DATA_SOURCE_STRATEGY = {
    dbType: 'DYNAMODB',
    provisionStrategy: 'AMPLIFY_TABLE',
};
// Translate the external engine types to the config values
// Reference: https://github.com/aws-amplify/amplify-category-api/blob/fd7f6fbc17c199331c4b04debaff69ea0424cd74/packages/amplify-graphql-api-construct/src/model-datasource-strategy-types.ts#L25
const SQL_DB_TYPES = {
    mysql: 'MYSQL',
    postgresql: 'POSTGRES',
};
/**
 * Given an input schema type, produce the relevant CDK Graphql Def interface
 * @param schema TS schema builder definition or string GraphQL schema
 * @param backendSecretResolver secret resolver
 * @param stableBackendIdentifiers backend identifiers
 * @returns the cdk graphql definition interface
 */
export const convertSchemaToCDK = (schema, backendSecretResolver, stableBackendIdentifiers) => {
    if (isDataSchema(schema)) {
        /**
         * This is not super obvious, but the IAmplifyDataDefinition interface requires a record of each model type to a
         * data source strategy (how it should be deployed and managed). Normally this is handled for customers by static
         * methods on AmplifyDataDefinition, but since the data-schema-types don't produce that today, we use the builder
         * to generate that argument for us (so it's consistent with a customer using normal Graphql strings), then
         * apply that value back into the final IAmplifyDataDefinition output for data-schema users.
         */
        const { schema: transformedSchema, functionSlots, customSqlDataSourceStrategies, } = schema.transform();
        const provisionStrategyName = stableBackendIdentifiers.getStableBackendHash();
        const dbStrategy = convertDatabaseConfigurationToDataSourceStrategy(schema.data.configuration.database, customSqlDataSourceStrategies, backendSecretResolver, provisionStrategyName);
        const generatedModelDataSourceStrategies = AmplifyDataDefinition.fromString(transformedSchema, dbStrategy).dataSourceStrategies;
        if (dbStrategy.dbType === 'DYNAMODB') {
            return {
                schema: transformedSchema,
                functionSlots,
                dataSourceStrategies: generatedModelDataSourceStrategies,
            };
        }
        return {
            schema: transformedSchema,
            functionSlots,
            dataSourceStrategies: generatedModelDataSourceStrategies,
            customSqlDataSourceStrategies: customSqlDataSourceStrategies?.map((existing) => ({
                ...existing,
                strategy: dbStrategy,
            })) || [],
        };
    }
    return AmplifyDataDefinition.fromString(schema, DYNAMO_DATA_SOURCE_STRATEGY);
};
/**
 * Given an input list of CDK Graphql Def interface schemas, produce the relevant CDK Graphql Def interface
 * @param schemas the cdk graphql definition interfaces to combine
 * @returns the cdk graphql definition interface
 */
export const combineCDKSchemas = (schemas) => {
    return AmplifyDataDefinition.combine(schemas);
};
/**
 * Given the generated rds builder database configuration, convert it into the DataSource strategy
 * @param configuration the database configuration from `data-schema`
 * @returns the data strategy needed to configure the data source
 */
const convertDatabaseConfigurationToDataSourceStrategy = (configuration, customSqlDataSourceStrategies = [], backendSecretResolver, provisionStrategyName) => {
    if (configuration.engine === 'dynamodb') {
        return DYNAMO_DATA_SOURCE_STRATEGY;
    }
    const dbType = SQL_DB_TYPES[configuration.engine];
    let vpcConfiguration = undefined;
    if (configuration.vpcConfig !== undefined) {
        vpcConfiguration = {
            vpcId: configuration.vpcConfig.vpcId,
            securityGroupIds: configuration.vpcConfig.securityGroupIds,
            subnetAvailabilityZoneConfig: configuration.vpcConfig.subnetAvailabilityZones,
        };
    }
    const customSqlStatements = customSqlStatementsFromStrategies(customSqlDataSourceStrategies);
    const { branchSecretPath, sharedSecretPath } = backendSecretResolver.resolvePath(configuration.connectionUri);
    let sslCertConfig;
    if (configuration.sslCert) {
        const { branchSecretPath, sharedSecretPath } = backendSecretResolver.resolvePath(configuration.sslCert);
        sslCertConfig = {
            ssmPath: [branchSecretPath, sharedSecretPath],
        };
    }
    const strategy = {
        dbType,
        name: provisionStrategyName +
            (configuration.identifier ?? configuration.engine),
        dbConnectionConfig: {
            connectionUriSsmPath: [branchSecretPath, sharedSecretPath],
            ...(sslCertConfig ? { sslCertConfig } : undefined),
        },
        vpcConfiguration,
        customSqlStatements,
    };
    return strategy;
};
/**
 * Create a custom sql statement reference dictionary
 * @param customSqlDataSourceStrategies custom sql handler defined in the schema
 * @returns an object mapping the file path to the sql statement
 */
const customSqlStatementsFromStrategies = (customSqlDataSourceStrategies) => {
    const customSqlStatements = customSqlDataSourceStrategies
        .filter((sqlStrategy) => sqlStrategy.entry !== undefined)
        .reduce((acc, sqlStrategy) => {
        const entry = sqlStrategy.entry;
        const reference = typeof entry === 'string' ? entry : entry.relativePath;
        const resolvedPath = resolveEntryPath(entry);
        acc[reference] = readFileSync(resolvedPath, 'utf8');
        return acc;
    }, {});
    return customSqlStatements;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udmVydF9zY2hlbWEuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvY29udmVydF9zY2hlbWEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBTUEsT0FBTyxFQUNMLHFCQUFxQixHQUt0QixNQUFNLDZCQUE2QixDQUFDO0FBTXJDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzNELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFFbEM7Ozs7R0FJRztBQUNILE1BQU0sQ0FBQyxNQUFNLFlBQVksR0FBRyxDQUMxQixNQUFrQixFQUNXLEVBQUU7SUFDL0IsT0FBTyxDQUNMLE1BQU0sS0FBSyxJQUFJO1FBQ2YsT0FBTyxNQUFNLEtBQUssUUFBUTtRQUMxQixXQUFXLElBQUksTUFBTTtRQUNyQixPQUFPLE1BQU0sQ0FBQyxTQUFTLEtBQUssVUFBVSxDQUN2QyxDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBRUY7Ozs7R0FJRztBQUNILE1BQU0sQ0FBQyxNQUFNLGdCQUFnQixHQUFHLENBQzlCLE1BQXVCLEVBQ1UsRUFBRTtJQUNuQyxPQUFPLENBQ0wsTUFBTSxLQUFLLElBQUk7UUFDZixPQUFPLE1BQU0sS0FBSyxRQUFRO1FBQzFCLFNBQVMsSUFBSSxNQUFNO1FBQ25CLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUM5QixDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBRUYsb0dBQW9HO0FBQ3BHLHNOQUFzTjtBQUN0TixNQUFNLDJCQUEyQixHQUFHO0lBQ2xDLE1BQU0sRUFBRSxVQUFVO0lBQ2xCLGlCQUFpQixFQUFFLGVBQWU7Q0FDMUIsQ0FBQztBQUVYLDJEQUEyRDtBQUMzRCxpTUFBaU07QUFDak0sTUFBTSxZQUFZLEdBQUc7SUFDbkIsS0FBSyxFQUFFLE9BQU87SUFDZCxVQUFVLEVBQUUsVUFBVTtDQUNkLENBQUM7QUFFWDs7Ozs7O0dBTUc7QUFDSCxNQUFNLENBQUMs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QW1CLENBQUM7QUFDN0IsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUge1xuICBDdXN0b21TcWxEYXRhU291cmNlU3RyYXRlZ3ksXG4gIERhdGFTb3VyY2VDb25maWd1cmF0aW9uLFxuICBEZXJpdmVkQ29tYmluZWRTY2hlbWEsXG4gIERlcml2ZWRNb2RlbFNjaGVtYSBhcyBEZXJpdmVkRGF0YVNjaGVtYSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2RhdGEtc2NoZW1hLXR5cGVzJztcbmltcG9ydCB7XG4gIEFtcGxpZnlEYXRhRGVmaW5pdGlvbixcbiAgdHlwZSBJQW1wbGlmeURhdGFEZWZpbml0aW9uLFxuICB0eXBlIE1vZGVsRGF0YVNvdXJjZVN0cmF0ZWd5LFxuICB0eXBlIFNzbENlcnRTc21QYXRoQ29uZmlnLFxuICB0eXBlIFZwY0NvbmZpZyxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2RhdGEtY29uc3RydWN0JztcbmltcG9ydCB0eXBlIHsgRGF0YVNjaGVtYSwgRGF0YVNjaGVtYUlucHV0IH0gZnJvbSAnLi90eXBlcy5qcyc7XG5pbXBvcnQgdHlwZSB7XG4gIEJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgU3RhYmxlQmFja2VuZElkZW50aWZpZXJzLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7IHJlc29sdmVFbnRyeVBhdGggfSBmcm9tICcuL3Jlc29sdmVfZW50cnlfcGF0aC5qcyc7XG5pbXBvcnQgeyByZWFkRmlsZVN5bmMgfSBmcm9tICdmcyc7XG5cbi8qKlxuICogRGV0ZXJtaW5lIGlmIHRoZSBpbnB1dCBzY2hlbWEgaXMgYSBkZXJpdmVkIHR5cGVkIHNjaGVtYSBvYmplY3QgKGRhdGEtc2NoZW1hKSwgYW5kIHBlcmZvcm0gdHlwZSBuYXJyb3dpbmcuXG4gKiBAcGFyYW0gc2NoZW1hIHRoZSBzY2hlbWEgdGhhdCBtaWdodCBiZSBhIGRlcml2ZWQgbW9kZWwgc2NoZW1hXG4gKiBAcmV0dXJucyBhIGJvb2xlYW4gaW5kaWNhdGluZyB3aGV0aGVyIHRoZSBzY2hlbWEgaXMgYSBkZXJpdmVkIG1vZGVsIHNjaGVtYSwgd2l0aCB0eXBlIG5hcnJvd2luZ1xuICovXG5leHBvcnQgY29uc3QgaXNEYXRhU2NoZW1hID0gKFxuICBzY2hlbWE6IERhdGFTY2hlbWFcbik6IHNjaGVtYSBpcyBEZXJpdmVkRGF0YVNjaGVtYSA9PiB7XG4gIHJldHVybiAoXG4gICAgc2NoZW1hICE9PSBudWxsICYmXG4gICAgdHlwZW9mIHNjaGVtYSA9PT0gJ29iamVjdCcgJiZcbiAgICAndHJhbnNmb3JtJyBpbiBzY2hlbWEgJiZcbiAgICB0eXBlb2Ygc2NoZW1hLnRyYW5zZm9ybSA9PT0gJ2Z1bmN0aW9uJ1xuICApO1xufTtcblxuLyoqXG4gKiBEZXRlcm1pbmUgaWYgdGhlIGlucHV0IHNjaGVtYSBpcyBhIGNvbGxlY3Rpb24gb2YgdHlwZWQgc2NoZW1hcywgYW5kIHBlcmZvcm0gdHlwZSBuYXJyb3dpbmcuXG4gKiBAcGFyYW0gc2NoZW1hIHRoZSBzY2hlbWEgdGhhdCBtaWdodCBiZSBhIGNvbGxlY3Rpb24gb2YgbW9kZWwgc2NoZW1hc1xuICogQHJldHVybnMgYSBib29sZWFuIGluZGljYXRpbmcgd2hldGhlciB0aGUgc2NoZW1hIGlzIGEgY29sbGVjdGlvbiBvZiBkZXJpdmVkIG1vZGVsIHNjaGVtYSwgd2l0aCB0eXBlIG5hcnJvd2luZ1xuICovXG5leHBvcnQgY29uc3QgaXNDb21iaW5lZFNjaGVtYSA9IChcbiAgc2NoZW1hOiBEYXRhU2NoZW1hSW5wdXRcbik6IHNjaGVtYSBpcyBEZXJpdmVkQ29tYmluZWRTY2hlbWEgPT4ge1xuICByZXR1cm4gKFxuICAgIHNjaGVtYSAhPT0gbnVsbCAmJlxuICAgIHR5cGVvZiBzY2hlbWEgPT09ICdvYmplY3QnICYmXG4gICAgJ3NjaGVtYXMnIGluIHNjaGVtYSAmJlxuICAgIEFycmF5LmlzQXJyYXkoc2NoZW1hLnNjaGVtYXMpXG4gICk7XG59O1xuXG4vLyBETyBOT1QgRURJVCBUSEUgRk9MTE9XSU5HIFZBTFVFUywgVVBEQVRFUyBUTyBEQiBUWVBFIE9SIFNUUkFURUdZIFdJTEwgUkVTVUxUIElOIERCIFJFUFJPVklTSU9OSU5HXG4vLyBDb25mb3JtcyB0byB0aGlzIGludGVyZmFjZTogaHR0cHM6Ly9naXRodWIuY29tL2F3cy1hbXBsaWZ5L2FtcGxpZnktY2F0ZWdvcnktYXBpL2Jsb2IvMjc0ZDExNzZkOTZlMjY1ZDAyODE3YTk3NTg0OGM3NjdkNmQ0M2MzMS9wYWNrYWdlcy9hbXBsaWZ5LWdyYXBocWwtYXBpLWNvbnN0cnVjdC9zcmMvbW9kZWwtZGF0YXNvdXJjZS1zdHJhdGVneS10eXBlcy50cyNMMzUtTDQxXG5jb25zdCBEWU5BTU9fREFUQV9TT1VSQ0VfU1RSQVRFR1kgPSB7XG4gIGRiVHlwZTogJ0RZTkFNT0RCJyxcbiAgcHJvdmlzaW9uU3RyYXRlZ3k6ICdBTVBMSUZZX1RBQkxFJyxcbn0gYXMgY29uc3Q7XG5cbi8vIFRyYW5zbGF0ZSB0aGUgZXh0ZXJuYWwgZW5naW5lIHR5cGVzIHRvIHRoZSBjb25maWcgdmFsdWVzXG4vLyBSZWZlcmVuY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9hd3MtYW1wbGlmeS9hbXBsaWZ5LWNhdGVnb3J5LWFwaS9ibG9iL2ZkN2Y2ZmJjMTdjMTk5MzMxYzRiMDRkZWJhZmY2OWVhMDQyNGNkNzQvcGFja2FnZXMvYW1wbGlmeS1ncmFwaHFsLWFwaS1jb25zdHJ1Y3Qvc3JjL21vZGVsLWRhdGFzb3VyY2Utc3RyYXRlZ3ktdHlwZXMudHMjTDI1XG5jb25zdCBTUUxfREJfVFlQRVMgPSB7XG4gIG15c3FsOiAnTVlTUUwnLFxuICBwb3N0Z3Jlc3FsOiAnUE9TVEdSRVMnLFxufSBhcyBjb25zdDtcblxuLyoqXG4gKiBHaXZlbiBhbiBpbnB1dCBzY2hlbWEgdHlwZSwgcHJvZHVjZSB0aGUgcmVsZXZhbnQgQ0RLIEdyYXBocWwgRGVmIGludGVyZmFjZVxuICogQHBhcmFtIHNjaGVtYSBUUyBzY2hlbWEgYnVpbGRlciBkZWZpbml0aW9uIG9yIHN0cmluZyBHcmFwaFFMIHNjaGVtYVxuICogQHBhcmFtIGJhY2tlbmRTZWNyZXRSZXNvbHZlciBzZWNyZXQgcmVzb2x2ZXJcbiAqIEBwYXJhbSBzdGFibGVCYWNrZW5kSWRlbnRpZmllcnMgYmFja2VuZCBpZGVudGlmaWVyc1xuICogQHJldHVybnMgdGhlIGNkayBncmFwaHFsIGRlZmluaXRpb24gaW50ZXJmYWNlXG4gKi9cbmV4cG9ydCBjb25zdCBjb252ZXJ0U2NoZW1hVG9DREsgPSAoXG4gIHNjaGVtYTogRGF0YVNjaGVtYSxcbiAgYmFja2VuZFNlY3JldFJlc29sdmVyOiBCYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gIHN0YWJsZUJhY2tlbmRJZGVudGlmaWVyczogU3RhYmxlQmFja2VuZElkZW50aWZpZXJzXG4pOiBJQW1wbGlmeURhdGFEZWZpbml0aW9uID0+IHtcbiAgaWYgKGlzRGF0YVNjaGVtYShzY2hlbWEpKSB7XG4gICAgLyoqXG4gICAgICogVGhpcyBpcyBub3Qgc3VwZXIgb2J2aW91cywgYnV0IHRoZSBJQW1wbGlmeURhdGFEZWZpbml0aW9uIGludGVyZmFjZSByZXF1aXJlcyBhIHJlY29yZCBvZiBlYWNoIG1vZGVsIHR5cGUgdG8gYVxuICAgICAqIGRhdGEgc291cmNlIHN0cmF0ZWd5IChob3cgaXQgc2hvdWxkIGJlIGRlcGxveWVkIGFuZCBtYW5hZ2VkKS4gTm9ybWFsbHkgdGhpcyBpcyBoYW5kbGVkIGZvciBjdXN0b21lcnMgYnkgc3RhdGljXG4gICAgICogbWV0aG9kcyBvbiBBbXBsaWZ5RGF0YURlZmluaXRpb24sIGJ1dCBzaW5jZSB0aGUgZGF0YS1zY2hlbWEtdHlwZXMgZG9uJ3QgcHJvZHVjZSB0aGF0IHRvZGF5LCB3ZSB1c2UgdGhlIGJ1aWxkZXJcbiAgICAgKiB0byBnZW5lcmF0ZSB0aGF0IGFyZ3VtZW50IGZvciB1cyAoc28gaXQncyBjb25zaXN0ZW50IHdpdGggYSBjdXN0b21lciB1c2luZyBub3JtYWwgR3JhcGhxbCBzdHJpbmdzKSwgdGhlblxuICAgICAqIGFwcGx5IHRoYXQgdmFsdWUgYmFjayBpbnRvIHRoZSBmaW5hbCBJQW1wbGlmeURhdGFEZWZpbml0aW9uIG91dHB1dCBmb3IgZGF0YS1zY2hlbWEgdXNlcnMuXG4gICAgICovXG4gICAgY29uc3Qge1xuICAgICAgc2NoZW1hOiB0cmFuc2Zvcm1lZFNjaGVtYSxcbiAgICAgIGZ1bmN0aW9uU2xvdHMsXG4gICAgICBjdXN0b21TcWxEYXRhU291cmNlU3RyYXRlZ2llcyxcbiAgICB9ID0gc2NoZW1hLnRyYW5zZm9ybSgpO1xuXG4gICAgY29uc3QgcHJvdmlzaW9uU3RyYXRlZ3lOYW1lID1cbiAgICAgIHN0YWJsZUJhY2tlbmRJZGVudGlmaWVycy5nZXRTdGFibGVCYWNrZW5kSGFzaCgpO1xuXG4gICAgY29uc3QgZGJTdHJhdGVneSA9IGNvbnZlcnREYXRhYmFzZUNvbmZpZ3VyYXRpb25Ub0RhdGFTb3VyY2VTdHJhdGVneShcbiAgICAgIHNjaGVtYS5kYXRhLmNvbmZpZ3VyYXRpb24uZGF0YWJhc2UsXG4gICAgICBjdXN0b21TcWxEYXRhU291cmNlU3RyYXRlZ2llcyxcbiAgICAgIGJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgICAgIHByb3Zpc2lvblN0cmF0ZWd5TmFtZVxuICAgICk7XG5cbiAgICBjb25zdCBnZW5lcmF0ZWRNb2RlbERhdGFTb3VyY2VTdHJhdGVnaWVzID0gQW1wbGlmeURhdGFEZWZpbml0aW9uLmZyb21TdHJpbmcoXG4gICAgICB0cmFuc2Zvcm1lZFNjaGVtYSxcbiAgICAgIGRiU3RyYXRlZ3lcbiAgICApLmRhdGFTb3VyY2VTdHJhdGVnaWVzO1xuXG4gICAgaWYgKGRiU3RyYXRlZ3kuZGJUeXBlID09PSAnRFlOQU1PREInKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzY2hlbWE6IHRyYW5zZm9ybWVkU2NoZW1hLFxuICAgICAgICBmdW5jdGlvblNsb3RzLFxuICAgICAgICBkYXRhU291cmNlU3RyYXRlZ2llczogZ2VuZXJhdGVkTW9kZWxEYXRhU291cmNlU3RyYXRlZ2llcyxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHNjaGVtYTogdHJhbnNmb3JtZWRTY2hlbWEsXG4gICAgICBmdW5jdGlvblNsb3RzLFxuICAgICAgZGF0YVNvdXJjZVN0cmF0ZWdpZXM6IGdlbmVyYXRlZE1vZGVsRGF0YVNvdXJjZVN0cmF0ZWdpZXMsXG4gICAgICBjdXN0b21TcWxEYXRhU291cmNlU3RyYXRlZ2llczpcbiAgICAgICAgY3VzdG9tU3FsRGF0YVNvdXJjZVN0cmF0ZWdpZXM/Lm1hcChcbiAgICAgICAgICAoZXhpc3Rpbmc6IEN1c3RvbVNxbERhdGFTb3VyY2VTdHJhdGVneSkgPT4gKHtcbiAgICAgICAgICAgIC4uLmV4aXN0aW5nLFxuICAgICAgICAgICAgc3RyYXRlZ3k6IGRiU3RyYXRlZ3ksXG4gICAgICAgICAgfSlcbiAgICAgICAgKSB8fCBbXSxcbiAgICB9O1xuICB9XG5cbiAgcmV0dXJuIEFtcGxpZnlEYXRhRGVmaW5pdGlvbi5mcm9tU3RyaW5nKHNjaGVtYSwgRFlOQU1PX0RBVEFfU09VUkNFX1NUUkFURUdZKTtcbn07XG5cbi8qKlxuICogR2l2ZW4gYW4gaW5wdXQgbGlzdCBvZiBDREsgR3JhcGhxbCBEZWYgaW50ZXJmYWNlIHNjaGVtYXMsIHByb2R1Y2UgdGhlIHJlbGV2YW50IENESyBHcmFwaHFsIERlZiBpbnRlcmZhY2VcbiAqIEBwYXJhbSBzY2hlbWFzIHRoZSBjZGsgZ3JhcGhxbCBkZWZpbml0aW9uIGludGVyZmFjZXMgdG8gY29tYmluZVxuICogQHJldHVybnMgdGhlIGNkayBncmFwaHFsIGRlZmluaXRpb24gaW50ZXJmYWNlXG4gKi9cbmV4cG9ydCBjb25zdCBjb21iaW5lQ0RLU2NoZW1hcyA9IChcbiAgc2NoZW1hczogSUFtcGxpZnlEYXRhRGVmaW5pdGlvbltdXG4pOiBJQW1wbGlmeURhdGFEZWZpbml0aW9uID0+IHtcbiAgcmV0dXJuIEFtcGxpZnlEYXRhRGVmaW5pdGlvbi5jb21iaW5lKHNjaGVtYXMpO1xufTtcblxuLyoqXG4gKiBHaXZlbiB0aGUgZ2VuZXJhdGVkIHJkcyBidWlsZGVyIGRhdGFiYXNlIGNvbmZpZ3VyYXRpb24sIGNvbnZlcnQgaXQgaW50byB0aGUgRGF0YVNvdXJjZSBzdHJhdGVneVxuICogQHBhcmFtIGNvbmZpZ3VyYXRpb24gdGhlIGRhdGFiYXNlIGNvbmZpZ3VyYXRpb24gZnJvbSBgZGF0YS1zY2hlbWFgXG4gKiBAcmV0dXJucyB0aGUgZGF0YSBzdHJhdGVneSBuZWVkZWQgdG8gY29uZmlndXJlIHRoZSBkYXRhIHNvdXJjZVxuICovXG5jb25zdCBjb252ZXJ0RGF0YWJhc2VDb25maWd1cmF0aW9uVG9EYXRhU291cmNlU3RyYXRlZ3kgPSAoXG4gIGNvbmZpZ3VyYXRpb246IERhdGFTb3VyY2VDb25maWd1cmF0aW9uLFxuICBjdXN0b21TcWxEYXRhU291cmNlU3RyYXRlZ2llczogQ3VzdG9tU3FsRGF0YVNvdXJjZVN0cmF0ZWd5W10gPSBbXSxcbiAgYmFja2VuZFNlY3JldFJlc29sdmVyOiBCYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gIHByb3Zpc2lvblN0cmF0ZWd5TmFtZTogc3RyaW5nXG4pOiBNb2RlbERhdGFTb3VyY2VTdHJhdGVneSA9PiB7XG4gIGlmIChjb25maWd1cmF0aW9uLmVuZ2luZSA9PT0gJ2R5bmFtb2RiJykge1xuICAgIHJldHVybiBEWU5BTU9fREFUQV9TT1VSQ0VfU1RSQVRFR1k7XG4gIH1cblxuICBjb25zdCBkYlR5cGUgPSBTUUxfREJfVFlQRVNbY29uZmlndXJhdGlvbi5lbmdpbmVdO1xuICBsZXQgdnBjQ29uZmlndXJhdGlvbjogVnBjQ29uZmlnIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkO1xuXG4gIGlmIChjb25maWd1cmF0aW9uLnZwY0NvbmZpZyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgdnBjQ29uZmlndXJhdGlvbiA9IHtcbiAgICAgIHZwY0lkOiBjb25maWd1cmF0aW9uLnZwY0NvbmZpZy52cGNJZCxcbiAgICAgIHNlY3VyaXR5R3JvdXBJZHM6IGNvbmZpZ3VyYXRpb24udnBjQ29uZmlnLnNlY3VyaXR5R3JvdXBJZHMsXG4gICAgICBzdWJuZXRBdmFpbGFiaWxpdHlab25lQ29uZmlnOlxuICAgICAgICBjb25maWd1cmF0aW9uLnZwY0NvbmZpZy5zdWJuZXRBdmFpbGFiaWxpdHlab25lcyxcbiAgICB9O1xuICB9XG5cbiAgY29uc3QgY3VzdG9tU3FsU3RhdGVtZW50cyA9IGN1c3RvbVNxbFN0YXRlbWVudHNGcm9tU3RyYXRlZ2llcyhcbiAgICBjdXN0b21TcWxEYXRhU291cmNlU3RyYXRlZ2llc1xuICApO1xuXG4gIGNvbnN0IHsgYnJhbmNoU2VjcmV0UGF0aCwgc2hhcmVkU2VjcmV0UGF0aCB9ID1cbiAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIucmVzb2x2ZVBhdGgoY29uZmlndXJhdGlvbi5jb25uZWN0aW9uVXJpKTtcblxuICBsZXQgc3NsQ2VydENvbmZpZzogU3NsQ2VydFNzbVBhdGhDb25maWcgfCB1bmRlZmluZWQ7XG4gIGlmIChjb25maWd1cmF0aW9uLnNzbENlcnQpIHtcbiAgICBjb25zdCB7IGJyYW5jaFNlY3JldFBhdGgsIHNoYXJlZFNlY3JldFBhdGggfSA9XG4gICAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIucmVzb2x2ZVBhdGgoY29uZmlndXJhdGlvbi5zc2xDZXJ0KTtcbiAgICBzc2xDZXJ0Q29uZmlnID0ge1xuICAgICAgc3NtUGF0aDogW2JyYW5jaFNlY3JldFBhdGgsIHNoYXJlZFNlY3JldFBhdGhdLFxuICAgIH07XG4gIH1cbiAgY29uc3Qgc3RyYXRlZ3k6IE1vZGVsRGF0YVNvdXJjZVN0cmF0ZWd5ID0ge1xuICAgIGRiVHlwZSxcbiAgICBuYW1lOlxuICAgICAgcHJvdmlzaW9uU3RyYXRlZ3lOYW1lICtcbiAgICAgIChjb25maWd1cmF0aW9uLmlkZW50aWZpZXIgPz8gY29uZmlndXJhdGlvbi5lbmdpbmUpLFxuICAgIGRiQ29ubmVjdGlvbkNvbmZpZzoge1xuICAgICAgY29ubmVjdGlvblVyaVNzbVBhdGg6IFticmFuY2hTZWNyZXRQYXRoLCBzaGFyZWRTZWNyZXRQYXRoXSxcbiAgICAgIC4uLihzc2xDZXJ0Q29uZmlnID8geyBzc2xDZXJ0Q29uZmlnIH0gOiB1bmRlZmluZWQpLFxuICAgIH0sXG4gICAgdnBjQ29uZmlndXJhdGlvbixcbiAgICBjdXN0b21TcWxTdGF0ZW1lbnRzLFxuICB9O1xuXG4gIHJldHVybiBzdHJhdGVneTtcbn07XG5cbi8qKlxuICogQ3JlYXRlIGEgY3VzdG9tIHNxbCBzdGF0ZW1lbnQgcmVmZXJlbmNlIGRpY3Rpb25hcnlcbiAqIEBwYXJhbSBjdXN0b21TcWxEYXRhU291cmNlU3RyYXRlZ2llcyBjdXN0b20gc3FsIGhhbmRsZXIgZGVmaW5lZCBpbiB0aGUgc2NoZW1hXG4gKiBAcmV0dXJucyBhbiBvYmplY3QgbWFwcGluZyB0aGUgZmlsZSBwYXRoIHRvIHRoZSBzcWwgc3RhdGVtZW50XG4gKi9cbmNvbnN0IGN1c3RvbVNxbFN0YXRlbWVudHNGcm9tU3RyYXRlZ2llcyA9IChcbiAgY3VzdG9tU3FsRGF0YVNvdXJjZVN0cmF0ZWdpZXM6IEN1c3RvbVNxbERhdGFTb3VyY2VTdHJhdGVneVtdXG4pOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0+IHtcbiAgY29uc3QgY3VzdG9tU3FsU3RhdGVtZW50cyA9IGN1c3RvbVNxbERhdGFTb3VyY2VTdHJhdGVnaWVzXG4gICAgLmZpbHRlcigoc3FsU3RyYXRlZ3kpID0+IHNxbFN0cmF0ZWd5LmVudHJ5ICE9PSB1bmRlZmluZWQpXG4gICAgLnJlZHVjZSgoYWNjLCBzcWxTdHJhdGVneSkgPT4ge1xuICAgICAgY29uc3QgZW50cnkgPSBzcWxTdHJhdGVneS5lbnRyeSE7XG4gICAgICBjb25zdCByZWZlcmVuY2UgPSB0eXBlb2YgZW50cnkgPT09ICdzdHJpbmcnID8gZW50cnkgOiBlbnRyeS5yZWxhdGl2ZVBhdGg7XG4gICAgICBjb25zdCByZXNvbHZlZFBhdGggPSByZXNvbHZlRW50cnlQYXRoKGVudHJ5KTtcblxuICAgICAgYWNjW3JlZmVyZW5jZV0gPSByZWFkRmlsZVN5bmMocmVzb2x2ZWRQYXRoLCAndXRmOCcpO1xuICAgICAgcmV0dXJuIGFjYztcbiAgICB9LCB7fSBhcyBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+KTtcblxuICByZXR1cm4gY3VzdG9tU3FsU3RhdGVtZW50cztcbn07XG4iXX0=