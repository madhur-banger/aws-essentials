"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.LocalConfigurationController = void 0;
const os_1 = __importDefault(require("os"));
const path_1 = __importDefault(require("path"));
const promises_1 = __importDefault(require("fs/promises"));
/**
 * Used to interact with config file based on OS.
 */
class LocalConfigurationController {
    projectName;
    configFileName;
    dirPath;
    configFilePath;
    _store;
    /**
     * Initializes paths to project config dir & config file.
     */
    constructor(projectName = 'amplify', configFileName = 'config.json') {
        this.projectName = projectName;
        this.configFileName = configFileName;
        this.dirPath = this.getConfigDirPath(this.projectName);
        this.configFilePath = path_1.default.join(this.dirPath, this.configFileName);
    }
    /**
     * Gets values from cached config by path.
     */
    async get(path) {
        return path
            .split('.')
            .reduce((acc, current) => {
            return acc?.[current];
        }, await this.store());
    }
    /**
     * Set value by path & update config file to disk.
     */
    async set(path, value) {
        let current = await this.store();
        path.split('.').forEach((key, index, keys) => {
            if (index === keys.length - 1) {
                current[key] = value;
            }
            else {
                if (current[key] == null) {
                    current[key] = {};
                }
                current = current[key];
            }
        });
        await this.write();
    }
    /**
     * Writes config file to disk if found.
     */
    async write() {
        // creates project directory if it doesn't exist.
        await this.mkConfigDir();
        const output = JSON.stringify(this._store ? this._store : {});
        await promises_1.default.writeFile(this.configFilePath, output, 'utf8');
    }
    /**
     * Reset cached config and delete the config file.
     */
    async clear() {
        this._store = {};
        await promises_1.default.rm(this.configFilePath);
    }
    /**
     * Getter for cached config, retrieves config from disk if not cached already.
     * If the store is not cached & config file does not exist, it will create a blank one.
     */
    async store() {
        if (this._store) {
            return this._store;
        }
        // check if file exists & readable.
        let fd;
        try {
            fd = await promises_1.default.open(this.configFilePath, promises_1.default.constants.F_OK, promises_1.default.constants.O_RDWR);
            const fileContent = await promises_1.default.readFile(fd, 'utf-8');
            this._store = JSON.parse(fileContent);
        }
        catch {
            this._store = {};
            await this.write();
        }
        finally {
            await fd?.close();
        }
        return this._store;
    }
    /**
     * Creates project directory to store config if it doesn't exist yet.
     */
    mkConfigDir() {
        return promises_1.default.mkdir(this.dirPath, { recursive: true });
    }
    /**
     * Returns the path to config directory depending on OS
     */
    getConfigDirPath(name) {
        const homedir = os_1.default.homedir();
        const macos = () => path_1.default.join(homedir, 'Library', 'Preferences', name);
        const windows = () => {
            return path_1.default.join(process.env.APPDATA || path_1.default.join(homedir, 'AppData', 'Roaming'), name, 'Config');
        };
        const linux = () => {
            return path_1.default.join(process.env.XDG_STATE_HOME || path_1.default.join(homedir, '.local', 'state'), name);
        };
        switch (process.platform) {
            case 'darwin':
                return macos();
            case 'win32':
                return windows();
            default:
                return linux();
        }
    }
}
exports.LocalConfigurationController = LocalConfigurationController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9jYWxfY29uZmlndXJhdGlvbl9jb250cm9sbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NvbmZpZy9sb2NhbF9jb25maWd1cmF0aW9uX2NvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsNENBQW9CO0FBQ3BCLGdEQUF3QjtBQUN4QiwyREFBNkI7QUFHN0I7O0dBRUc7QUFDSCxNQUFhLDRCQUE0QjtJQVNwQjtJQUNBO0lBVG5CLE9BQU8sQ0FBUztJQUNoQixjQUFjLENBQVM7SUFDdkIsTUFBTSxDQUEwQjtJQUVoQzs7T0FFRztJQUNILFlBQ21CLGNBQWMsU0FBUyxFQUN2QixpQkFBaUIsYUFBYTtRQUQ5QixnQkFBVyxHQUFYLFdBQVcsQ0FBWTtRQUN2QixtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFFL0MsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3ZELElBQUksQ0FBQyxjQUFjLEdBQUcsY0FBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUNyRSxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsR0FBRyxDQUFJLElBQVk7UUFDdkIsT0FBTyxJQUFJO2FBQ1IsS0FBSyxDQUFDLEdBQUcsQ0FBQzthQUNWLE1BQU0sQ0FBQyxDQUFDLEdBQTRCLEVBQUUsT0FBZSxFQUFFLEVBQUU7WUFDeEQsT0FBTyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQTRCLENBQUM7UUFDbkQsQ0FBQyxFQUFFLE1BQU0sSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFNLENBQUM7SUFDaEMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFZLEVBQUUsS0FBZ0M7UUFDdEQsSUFBSSxPQUFPLEdBQTRCLE1BQU0sSUFBSSxDQUFDLEtBQUss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T0FBTyxJQUFJLGNBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxTQUFTLENBQUMsRUFDL0QsSUFBSSxFQUNKLFFBQVEsQ0FDVCxDQUFDO1FBQ0osQ0FBQyxDQUFDO1FBQ0YsTUFBTSxLQUFLLEdBQUcsR0FBRyxFQUFFO1lBQ2pCLE9BQU8sY0FBSSxDQUFDLElBQUksQ0FDZCxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsSUFBSSxjQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxRQUFRLEVBQUUsT0FBTyxDQUFDLEVBQ25FLElBQUksQ0FDTCxDQUFDO1FBQ0osQ0FBQyxDQUFDO1FBRUYsUUFBUSxPQUFPLENBQUMsUUFBUSxFQUFFO1lBQ3hCLEtBQUssUUFBUTtnQkFDWCxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2pCLEtBQUssT0FBTztnQkFDVixPQUFPLE9BQU8sRUFBRSxDQUFDO1lBQ25CO2dCQUNFLE9BQU8sS0FBSyxFQUFFLENBQUM7U0FDbEI7SUFDSCxDQUFDO0NBQ0Y7QUFuSUQsb0VBbUlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IG9zIGZyb20gJ29zJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzL3Byb21pc2VzJztcbmltcG9ydCB7IENvbmZpZ3VyYXRpb25Db250cm9sbGVyIH0gZnJvbSAnLi9sb2NhbF9jb25maWd1cmF0aW9uX2NvbnRyb2xsZXJfZmFjdG9yeSc7XG5cbi8qKlxuICogVXNlZCB0byBpbnRlcmFjdCB3aXRoIGNvbmZpZyBmaWxlIGJhc2VkIG9uIE9TLlxuICovXG5leHBvcnQgY2xhc3MgTG9jYWxDb25maWd1cmF0aW9uQ29udHJvbGxlciBpbXBsZW1lbnRzIENvbmZpZ3VyYXRpb25Db250cm9sbGVyIHtcbiAgZGlyUGF0aDogc3RyaW5nO1xuICBjb25maWdGaWxlUGF0aDogc3RyaW5nO1xuICBfc3RvcmU6IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuXG4gIC8qKlxuICAgKiBJbml0aWFsaXplcyBwYXRocyB0byBwcm9qZWN0IGNvbmZpZyBkaXIgJiBjb25maWcgZmlsZS5cbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJvamVjdE5hbWUgPSAnYW1wbGlmeScsXG4gICAgcHJpdmF0ZSByZWFkb25seSBjb25maWdGaWxlTmFtZSA9ICdjb25maWcuanNvbidcbiAgKSB7XG4gICAgdGhpcy5kaXJQYXRoID0gdGhpcy5nZXRDb25maWdEaXJQYXRoKHRoaXMucHJvamVjdE5hbWUpO1xuICAgIHRoaXMuY29uZmlnRmlsZVBhdGggPSBwYXRoLmpvaW4odGhpcy5kaXJQYXRoLCB0aGlzLmNvbmZpZ0ZpbGVOYW1lKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIHZhbHVlcyBmcm9tIGNhY2hlZCBjb25maWcgYnkgcGF0aC5cbiAgICovXG4gIGFzeW5jIGdldDxUPihwYXRoOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gcGF0aFxuICAgICAgLnNwbGl0KCcuJylcbiAgICAgIC5yZWR1Y2UoKGFjYzogUmVjb3JkPHN0cmluZywgdW5rbm93bj4sIGN1cnJlbnQ6IHN0cmluZykgPT4ge1xuICAgICAgICByZXR1cm4gYWNjPy5bY3VycmVudF0gYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj47XG4gICAgICB9LCBhd2FpdCB0aGlzLnN0b3JlKCkpIGFzIFQ7XG4gIH1cblxuICAvKipcbiAgICogU2V0IHZhbHVlIGJ5IHBhdGggJiB1cGRhdGUgY29uZmlnIGZpbGUgdG8gZGlzay5cbiAgICovXG4gIGFzeW5jIHNldChwYXRoOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcgfCBib29sZWFuIHwgbnVtYmVyKSB7XG4gICAgbGV0IGN1cnJlbnQ6IFJlY29yZDxzdHJpbmcsIHVua25vd24+ID0gYXdhaXQgdGhpcy5zdG9yZSgpO1xuXG4gICAgcGF0aC5zcGxpdCgnLicpLmZvckVhY2goKGtleSwgaW5kZXgsIGtleXMpID0+IHtcbiAgICAgIGlmIChpbmRleCA9PT0ga2V5cy5sZW5ndGggLSAxKSB7XG4gICAgICAgIGN1cnJlbnRba2V5XSA9IHZhbHVlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGN1cnJlbnRba2V5XSA9PSBudWxsKSB7XG4gICAgICAgICAgY3VycmVudFtrZXldID0ge307XG4gICAgICAgIH1cbiAgICAgICAgY3VycmVudCA9IGN1cnJlbnRba2V5XSBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGF3YWl0IHRoaXMud3JpdGUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBXcml0ZXMgY29uZmlnIGZpbGUgdG8gZGlzayBpZiBmb3VuZC5cbiAgICovXG4gIGFzeW5jIHdyaXRlKCkge1xuICAgIC8vIGNyZWF0ZXMgcHJvamVjdCBkaXJlY3RvcnkgaWYgaXQgZG9lc24ndCBleGlzdC5cbiAgICBhd2FpdCB0aGlzLm1rQ29uZmlnRGlyKCk7XG5cbiAgICBjb25zdCBvdXRwdXQgPSBKU09OLnN0cmluZ2lmeSh0aGlzLl9zdG9yZSA/IHRoaXMuX3N0b3JlIDoge30pO1xuICAgIGF3YWl0IGZzLndyaXRlRmlsZSh0aGlzLmNvbmZpZ0ZpbGVQYXRoLCBvdXRwdXQsICd1dGY4Jyk7XG4gIH1cblxuICAvKipcbiAgICogUmVzZXQgY2FjaGVkIGNvbmZpZyBhbmQgZGVsZXRlIHRoZSBjb25maWcgZmlsZS5cbiAgICovXG4gIGFzeW5jIGNsZWFyKCkge1xuICAgIHRoaXMuX3N0b3JlID0ge307XG4gICAgYXdhaXQgZnMucm0odGhpcy5jb25maWdGaWxlUGF0aCk7XG4gIH1cblxuICAvKipcbiAgICogR2V0dGVyIGZvciBjYWNoZWQgY29uZmlnLCByZXRyaWV2ZXMgY29uZmlnIGZyb20gZGlzayBpZiBub3QgY2FjaGVkIGFscmVhZHkuXG4gICAqIElmIHRoZSBzdG9yZSBpcyBub3QgY2FjaGVkICYgY29uZmlnIGZpbGUgZG9lcyBub3QgZXhpc3QsIGl0IHdpbGwgY3JlYXRlIGEgYmxhbmsgb25lLlxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBzdG9yZSgpOiBQcm9taXNlPFJlY29yZDxzdHJpbmcsIHVua25vd24+PiB7XG4gICAgaWYgKHRoaXMuX3N0b3JlKSB7XG4gICAgICByZXR1cm4gdGhpcy5fc3RvcmU7XG4gICAgfVxuICAgIC8vIGNoZWNrIGlmIGZpbGUgZXhpc3RzICYgcmVhZGFibGUuXG4gICAgbGV0IGZkO1xuXG4gICAgdHJ5IHtcbiAgICAgIGZkID0gYXdhaXQgZnMub3BlbihcbiAgICAgICAgdGhpcy5jb25maWdGaWxlUGF0aCxcbiAgICAgICAgZnMuY29uc3RhbnRzLkZfT0ssXG4gICAgICAgIGZzLmNvbnN0YW50cy5PX1JEV1JcbiAgICAgICk7XG4gICAgICBjb25zdCBmaWxlQ29udGVudCA9IGF3YWl0IGZzLnJlYWRGaWxlKGZkLCAndXRmLTgnKTtcbiAgICAgIHRoaXMuX3N0b3JlID0gSlNPTi5wYXJzZShmaWxlQ29udGVudCk7XG4gICAgfSBjYXRjaCB7XG4gICAgICB0aGlzLl9zdG9yZSA9IHt9O1xuICAgICAgYXdhaXQgdGhpcy53cml0ZSgpO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBhd2FpdCBmZD8uY2xvc2UoKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX3N0b3JlO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgcHJvamVjdCBkaXJlY3RvcnkgdG8gc3RvcmUgY29uZmlnIGlmIGl0IGRvZXNuJ3QgZXhpc3QgeWV0LlxuICAgKi9cbiAgcHJpdmF0ZSBta0NvbmZpZ0RpcigpIHtcbiAgICByZXR1cm4gZnMubWtkaXIodGhpcy5kaXJQYXRoLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBwYXRoIHRvIGNvbmZpZyBkaXJlY3RvcnkgZGVwZW5kaW5nIG9uIE9TXG4gICAqL1xuICBwcml2YXRlIGdldENvbmZpZ0RpclBhdGgobmFtZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBjb25zdCBob21lZGlyID0gb3MuaG9tZWRpcigpO1xuXG4gICAgY29uc3QgbWFjb3MgPSAoKSA9PiBwYXRoLmpvaW4oaG9tZWRpciwgJ0xpYnJhcnknLCAnUHJlZmVyZW5jZXMnLCBuYW1lKTtcbiAgICBjb25zdCB3aW5kb3dzID0gKCkgPT4ge1xuICAgICAgcmV0dXJuIHBhdGguam9pbihcbiAgICAgICAgcHJvY2Vzcy5lbnYuQVBQREFUQSB8fCBwYXRoLmpvaW4oaG9tZWRpciwgJ0FwcERhdGEnLCAnUm9hbWluZycpLFxuICAgICAgICBuYW1lLFxuICAgICAgICAnQ29uZmlnJ1xuICAgICAgKTtcbiAgICB9O1xuICAgIGNvbnN0IGxpbnV4ID0gKCkgPT4ge1xuICAgICAgcmV0dXJuIHBhdGguam9pbihcbiAgICAgICAgcHJvY2Vzcy5lbnYuWERHX1NUQVRFX0hPTUUgfHwgcGF0aC5qb2luKGhvbWVkaXIsICcubG9jYWwnLCAnc3RhdGUnKSxcbiAgICAgICAgbmFtZVxuICAgICAgKTtcbiAgICB9O1xuXG4gICAgc3dpdGNoIChwcm9jZXNzLnBsYXRmb3JtKSB7XG4gICAgICBjYXNlICdkYXJ3aW4nOlxuICAgICAgICByZXR1cm4gbWFjb3MoKTtcbiAgICAgIGNhc2UgJ3dpbjMyJzpcbiAgICAgICAgcmV0dXJuIHdpbmRvd3MoKTtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiBsaW51eCgpO1xuICAgIH1cbiAgfVxufVxuIl19