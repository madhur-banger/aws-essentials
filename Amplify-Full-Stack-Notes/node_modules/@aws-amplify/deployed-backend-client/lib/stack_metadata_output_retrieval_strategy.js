import { CloudFormationServiceException, DescribeStacksCommand, GetTemplateSummaryCommand, } from '@aws-sdk/client-cloudformation';
import { backendOutputStackMetadataSchema } from '@aws-amplify/backend-output-schemas';
import { BackendOutputClientError, BackendOutputClientErrorType, } from './index.js';
/**
 * Gets Amplify backend outputs from stack metadata and outputs
 */
export class StackMetadataBackendOutputRetrievalStrategy {
    cfnClient;
    stackNameResolver;
    /**
     * Instantiate with a CloudFormationClient and a StackNameResolver
     */
    constructor(cfnClient, stackNameResolver) {
        this.cfnClient = cfnClient;
        this.stackNameResolver = stackNameResolver;
    }
    /**
     * Resolves the stackName, then queries CFN for the stack metadata and outputs
     *
     * It combines the metadata and outputs to reconstruct the data object that was provided by the Amplify constructs when writing the output.
     * Except now the data contains the resolved values of the deployed resources rather than CFN references
     */
    fetchBackendOutput = async () => {
        const stackName = await this.stackNameResolver.resolveMainStackName();
        let metadataObject;
        try {
            // GetTemplateSummary includes the template metadata as a string
            const templateSummary = await this.cfnClient.send(new GetTemplateSummaryCommand({ StackName: stackName }));
            if (typeof templateSummary.Metadata !== 'string') {
                throw new BackendOutputClientError(BackendOutputClientErrorType.METADATA_RETRIEVAL_ERROR, 'Stack template metadata is not a string');
            }
            metadataObject = JSON.parse(templateSummary.Metadata);
        }
        catch (error) {
            if (error instanceof CloudFormationServiceException &&
                error.message.startsWith('Stack with id') &&
                error.message.endsWith('does not exist')) {
                throw new BackendOutputClientError(BackendOutputClientErrorType.NO_STACK_FOUND, `Stack with id ${stackName} does not exist`);
            }
            if (error instanceof CloudFormationServiceException &&
                ['ExpiredToken', 'InvalidClientTokenId'].includes(error.name)) {
                throw new BackendOutputClientError(BackendOutputClientErrorType.CREDENTIALS_ERROR, error.message);
            }
            if (error instanceof CloudFormationServiceException &&
                error.name === 'AccessDenied') {
                throw new BackendOutputClientError(BackendOutputClientErrorType.ACCESS_DENIED, error.message);
            }
            throw error;
        }
        // parse and validate the metadata object
        const backendOutputMetadata = backendOutputStackMetadataSchema.parse(metadataObject);
        // DescribeStacks includes the template output
        const stackDescription = await this.cfnClient.send(new DescribeStacksCommand({ StackName: stackName }));
        const outputs = stackDescription?.Stacks?.[0]?.Outputs;
        if (stackDescription.Stacks?.[0].StackStatus?.endsWith('_IN_PROGRESS')) {
            const deploymentType = stackDescription.Stacks?.[0].Tags?.find((tag) => tag.Key === 'amplify:deployment-type')?.Value ?? 'sandbox';
            throw new BackendOutputClientError(BackendOutputClientErrorType.DEPLOYMENT_IN_PROGRESS, `This ${deploymentType} deployment is in progress. Re-run this command once the deployment completes.`);
        }
        if (outputs === undefined) {
            throw new BackendOutputClientError(BackendOutputClientErrorType.NO_OUTPUTS_FOUND, 'Stack outputs are undefined');
        }
        // outputs is a list of output entries. here we turn that into a Record<name, value> object
        const stackOutputRecord = outputs
            .filter((output) => !!output.OutputValue && !!output.OutputKey)
            .reduce((accumulator, outputEntry) => ({
            ...accumulator,
            // it's safe to disable this rule because we've already filtered out potentially undefined outputs
            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
            [outputEntry.OutputKey]: outputEntry.OutputValue,
        }), {});
        // now we iterate over the metadata entries and reconstruct the data object based on the stackOutputs that each construct package set
        const result = {};
        Object.entries(backendOutputMetadata).forEach(([outputKeyName, entry]) => {
            const outputData = entry.stackOutputs.reduce((accumulator, outputName) => {
                if (stackOutputRecord[outputName] === undefined ||
                    stackOutputRecord[outputName] === '') {
                    return accumulator;
                }
                return {
                    ...accumulator,
                    [outputName]: stackOutputRecord[outputName],
                };
            }, {});
            result[outputKeyName] = {
                version: entry.version,
                payload: outputData,
            };
        });
        return result;
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhY2tfbWV0YWRhdGFfb3V0cHV0X3JldHJpZXZhbF9zdHJhdGVneS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zdGFja19tZXRhZGF0YV9vdXRwdXRfcmV0cmlldmFsX3N0cmF0ZWd5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFFTCw4QkFBOEIsRUFDOUIscUJBQXFCLEVBQ3JCLHlCQUF5QixHQUMxQixNQUFNLGdDQUFnQyxDQUFDO0FBTXhDLE9BQU8sRUFBRSxnQ0FBZ0MsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ3ZGLE9BQU8sRUFDTCx3QkFBd0IsRUFDeEIsNEJBQTRCLEdBQzdCLE1BQU0sWUFBWSxDQUFDO0FBRXBCOztHQUVHO0FBQ0gsTUFBTSxPQUFPLDJDQUEyQztJQU9uQztJQUNBO0lBTG5COztPQUVHO0lBQ0gsWUFDbUIsU0FBK0IsRUFDL0IsaUJBQXdDO1FBRHhDLGNBQVMsR0FBVCxTQUFTLENBQXNCO1FBQy9CLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBdUI7SUFDeEQsQ0FBQztJQUVKOzs7OztPQUtHO0lBQ0gsa0JBQWtCLEdBQUcsS0FBSyxJQUE0QixFQUFFO1FBQ3RELE1BQU0sU0FBUyxHQUFHLE1BQU0sSUFBSSxDQUFDLGlCQUFpQixDQUFDLG9CQUFvQixFQUFFLENBQUM7UUFFdEUsSUFBSSxjQUFjLENBQUM7UUFFbkIsSUFBSTtZQUNGLGdFQUFnRTtZQUNoRSxNQUFNLGVBQWUsR0FBRyxNQUFNLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUMvQyxJQUFJLHlCQUF5QixDQUFDLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQ3hELENBQUM7WUFFRixJQUFJLE9BQU8sZUFBZSxDQUFDLFFBQVEsS0FBSyxRQUFRLEVBQUU7Z0JBQ2hELE1BQU0sSUFBSSx3QkFBd0IsQ0FDaEMsNEJBQTRCLENBQUMsd0JBQXdCLEVBQ3JELHlDQUF5QyxDQUMxQyxDQUFDO2FBQ0g7WUFFRCxjQUFjLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUM7U0FDdkQ7UUFBQyxPQUFPLEtBQUssRUFBRTtZQUNkLElBQ0UsS0FBSyxZQUFZLDhCQUE4QjtnQkFDL0MsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsZUFBZSxDQUFDO2dCQUN6QyxLQUFLLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxFQUN4QztnQkFDQSxNQUFNLElBQUksd0JBQXdCLENBQ2hDLDRCQUE0QixDQUFDLGNBQWMsRUFDM0MsaUJBQWlCLFNBQVMsaUJBQWlCLENBQzVDLENBQUM7YUFDSDtZQUNELElBQ0UsS0FBSyxZQUFZLDhCQUE4QjtnQkFDL0MsQ0FBQyxjQUFjLEVBQUUsc0JBQXNCLENBQUMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUM3RDtnQkFDQSxNQUFNLElBQUksd0JBQXdCLENBQ2hDLDRCQUE0QixDQUFDLGlCQUFpQixFQUM5QyxLQUFLLENBQUMsT0FBTyxDQUNkLENBQUM7YUFDSDtZQUNELElBQ0UsS0FBSyxZQUFZLDhCQUE4QjtnQkFDL0MsS0FBSyxDQUFDLElBQUksS0FBSyxjQUFjLEVBQzdCO2dCQUNBLE1BQU0sSUFBSSx3QkFBd0IsQ0FDaEMsNEJBQTRCLENBQUMsYUFBYSxFQUMxQyxLQUFLLENBQUMsT0FBTyxDQUNkLENBQUM7YUFDSDtZQUVELE1BQU0sS0FBSyxDQUFDO1NBQ2I7UUFFRCx5Q0FBeUM7UUFDekMsTUFBTSxxQkFBcUIsR0FDekIsZ0NBQWdDLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBRXpELDhDQUE4QztRQUM5QyxNQUFNLGdCQUFnQixHQUFHLE1BQU0sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQ2hELElBQUkscUJBQXFCLENBQUMsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FDcEQsQ0FBQztRQUVGLE1BQU0sT0FBTyxHQUFHLGdCQUFnQixFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLE9BQU8sQ0FBQztRQUN2RCxJQUFJLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxRQUFRLENBQUMsY0FBYyxDQUFDLEVBQUU7WUFDdEUsTUFBTSxjQUFjLEdBQ2xCLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLENBQ3JDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLHlCQUF5QixDQUMvQyxFQUFFLEtBQUssSUFBSSxTQUFTLENBQUM7WUFDeEIsTUFBTSxJQUFJLHdCQUF3QixDQUNoQyw0QkFBNEIsQ0FBQyxzQkFBc0IsRUFDbkQsUUFBUSxjQUFjLGdGQUFnRixDQUN2RyxDQUFDO1NBQ0g7UUFDRCxJQUFJLE9BQU8sS0FBSyxTQUFTLEVBQUU7WUFDekIsTUFBTSxJQUFJLHdCQUF3QixDQUNoQyw0QkFBNEIsQ0FBQyxnQkFBZ0IsRUFDN0MsNkJBQTZCLENBQzlCLENBQUM7U0FDSDtRQUVELDJGQUEyRjtRQUMzRixNQUFNLGlCQUFpQixHQUFHLE9BQU87YUFDOUIsTUFBTSxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFdBQVcsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQzthQUM5RCxNQUFNLENBQ0wsQ0FBQyxXQUFXLEVBQUUsV0FBVyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQzdCLEdBQUcsV0FBVztZQUNkLGtHQUFrRztZQUNsRyxvRUFBb0U7WUFDcEUsQ0FBQyxXQUFXLENBQUMsU0FBVSxDQUFDLEVBQUUsV0FBVyxDQUFDLFdBQVk7U0FDbkQsQ0FBQyxFQUNGLEVBQTRCLENBQzdCLENBQUM7UUFFSixxSUFBcUk7UUFDckksTUFBTSxNQUFNLEdBQWtCLEVBQUUsQ0FBQztRQUNqQyxNQUFNLENBQUMsT0FBTyxDQUFDLHFCQUFxQixDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxhQUFhLEVBQUUsS0FBSyxDQUFDLEVBQUUsRUFBRTtZQUN2RSxNQUFNLFVBQVUsR0FBRyxLQUFLLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FDMUMsQ0FBQyxXQUFXLEVBQUUsVUFBVSxFQUFFLEVBQUU7Z0JBQzFCLElBQ0UsaUJBQWlCLENBQUMsVUFBVSxDQUFDLEtBQUssU0FBUztvQkFDM0MsaUJBQWlCLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxFQUNwQztvQkFDQSxPQUFPLFdBQVcsQ0FBQztpQkFDcEI7Z0JBQ0QsT0FBTztvQkFDTCxHQUFHLFdBQVc7b0JBQ2QsQ0FBQyxVQUFVLENBQUMsRUFBRSxpQkFBaUIsQ0FBQyxVQUFVLENBQUM7aUJBQzVDLENBQUM7WUFDSixDQUFDLEVBQ0QsRUFBNEIsQ0FDN0IsQ0FBQztZQUNGLE1BQU0sQ0FBQyxhQUFhLENBQUMsR0FBRztnQkFDdEIsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPO2dCQUN0QixPQUFPLEVBQUUsVUFBVTthQUNwQixDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENsb3VkRm9ybWF0aW9uQ2xpZW50LFxuICBDbG91ZEZvcm1hdGlvblNlcnZpY2VFeGNlcHRpb24sXG4gIERlc2NyaWJlU3RhY2tzQ29tbWFuZCxcbiAgR2V0VGVtcGxhdGVTdW1tYXJ5Q29tbWFuZCxcbn0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWNsb3VkZm9ybWF0aW9uJztcbmltcG9ydCB7XG4gIEJhY2tlbmRPdXRwdXQsXG4gIEJhY2tlbmRPdXRwdXRSZXRyaWV2YWxTdHJhdGVneSxcbiAgTWFpblN0YWNrTmFtZVJlc29sdmVyLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7IGJhY2tlbmRPdXRwdXRTdGFja01ldGFkYXRhU2NoZW1hIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtb3V0cHV0LXNjaGVtYXMnO1xuaW1wb3J0IHtcbiAgQmFja2VuZE91dHB1dENsaWVudEVycm9yLFxuICBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3JUeXBlLFxufSBmcm9tICcuL2luZGV4LmpzJztcblxuLyoqXG4gKiBHZXRzIEFtcGxpZnkgYmFja2VuZCBvdXRwdXRzIGZyb20gc3RhY2sgbWV0YWRhdGEgYW5kIG91dHB1dHNcbiAqL1xuZXhwb3J0IGNsYXNzIFN0YWNrTWV0YWRhdGFCYWNrZW5kT3V0cHV0UmV0cmlldmFsU3RyYXRlZ3lcbiAgaW1wbGVtZW50cyBCYWNrZW5kT3V0cHV0UmV0cmlldmFsU3RyYXRlZ3lcbntcbiAgLyoqXG4gICAqIEluc3RhbnRpYXRlIHdpdGggYSBDbG91ZEZvcm1hdGlvbkNsaWVudCBhbmQgYSBTdGFja05hbWVSZXNvbHZlclxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBjZm5DbGllbnQ6IENsb3VkRm9ybWF0aW9uQ2xpZW50LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgc3RhY2tOYW1lUmVzb2x2ZXI6IE1haW5TdGFja05hbWVSZXNvbHZlclxuICApIHt9XG5cbiAgLyoqXG4gICAqIFJlc29sdmVzIHRoZSBzdGFja05hbWUsIHRoZW4gcXVlcmllcyBDRk4gZm9yIHRoZSBzdGFjayBtZXRhZGF0YSBhbmQgb3V0cHV0c1xuICAgKlxuICAgKiBJdCBjb21iaW5lcyB0aGUgbWV0YWRhdGEgYW5kIG91dHB1dHMgdG8gcmVjb25zdHJ1Y3QgdGhlIGRhdGEgb2JqZWN0IHRoYXQgd2FzIHByb3ZpZGVkIGJ5IHRoZSBBbXBsaWZ5IGNvbnN0cnVjdHMgd2hlbiB3cml0aW5nIHRoZSBvdXRwdXQuXG4gICAqIEV4Y2VwdCBub3cgdGhlIGRhdGEgY29udGFpbnMgdGhlIHJlc29sdmVkIHZhbHVlcyBvZiB0aGUgZGVwbG95ZWQgcmVzb3VyY2VzIHJhdGhlciB0aGFuIENGTiByZWZlcmVuY2VzXG4gICAqL1xuICBmZXRjaEJhY2tlbmRPdXRwdXQgPSBhc3luYyAoKTogUHJvbWlzZTxCYWNrZW5kT3V0cHV0PiA9PiB7XG4gICAgY29uc3Qgc3RhY2tOYW1lID0gYXdhaXQgdGhpcy5zdGFja05hbWVSZXNvbHZlci5yZXNvbHZlTWFpblN0YWNrTmFtZSgpO1xuXG4gICAgbGV0IG1ldGFkYXRhT2JqZWN0O1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIEdldFRlbXBsYXRlU3VtbWFyeSBpbmNsdWRlcyB0aGUgdGVtcGxhdGUgbWV0YWRhdGEgYXMgYSBzdHJpbmdcbiAgICAgIGNvbnN0IHRlbXBsYXRlU3VtbWFyeSA9IGF3YWl0IHRoaXMuY2ZuQ2xpZW50LnNlbmQoXG4gICAgICAgIG5ldyBHZXRUZW1wbGF0ZVN1bW1hcnlDb21tYW5kKHsgU3RhY2tOYW1lOiBzdGFja05hbWUgfSlcbiAgICAgICk7XG5cbiAgICAgIGlmICh0eXBlb2YgdGVtcGxhdGVTdW1tYXJ5Lk1ldGFkYXRhICE9PSAnc3RyaW5nJykge1xuICAgICAgICB0aHJvdyBuZXcgQmFja2VuZE91dHB1dENsaWVudEVycm9yKFxuICAgICAgICAgIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvclR5cGUuTUVUQURBVEFfUkVUUklFVkFMX0VSUk9SLFxuICAgICAgICAgICdTdGFjayB0ZW1wbGF0ZSBtZXRhZGF0YSBpcyBub3QgYSBzdHJpbmcnXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIG1ldGFkYXRhT2JqZWN0ID0gSlNPTi5wYXJzZSh0ZW1wbGF0ZVN1bW1hcnkuTWV0YWRhdGEpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBpZiAoXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgQ2xvdWRGb3JtYXRpb25TZXJ2aWNlRXhjZXB0aW9uICYmXG4gICAgICAgIGVycm9yLm1lc3NhZ2Uuc3RhcnRzV2l0aCgnU3RhY2sgd2l0aCBpZCcpICYmXG4gICAgICAgIGVycm9yLm1lc3NhZ2UuZW5kc1dpdGgoJ2RvZXMgbm90IGV4aXN0JylcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBuZXcgQmFja2VuZE91dHB1dENsaWVudEVycm9yKFxuICAgICAgICAgIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvclR5cGUuTk9fU1RBQ0tfRk9VTkQsXG4gICAgICAgICAgYFN0YWNrIHdpdGggaWQgJHtzdGFja05hbWV9IGRvZXMgbm90IGV4aXN0YFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIENsb3VkRm9ybWF0aW9uU2VydmljZUV4Y2VwdGlvbiAmJlxuICAgICAgICBbJ0V4cGlyZWRUb2tlbicsICdJbnZhbGlkQ2xpZW50VG9rZW5JZCddLmluY2x1ZGVzKGVycm9yLm5hbWUpXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgbmV3IEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvcihcbiAgICAgICAgICBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3JUeXBlLkNSRURFTlRJQUxTX0VSUk9SLFxuICAgICAgICAgIGVycm9yLm1lc3NhZ2VcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBDbG91ZEZvcm1hdGlvblNlcnZpY2VFeGNlcHRpb24gJiZcbiAgICAgICAgZXJyb3IubmFtZSA9PT0gJ0FjY2Vzc0RlbmllZCdcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBuZXcgQmFja2VuZE91dHB1dENsaWVudEVycm9yKFxuICAgICAgICAgIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvclR5cGUuQUNDRVNTX0RFTklFRCxcbiAgICAgICAgICBlcnJvci5tZXNzYWdlXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cblxuICAgIC8vIHBhcnNlIGFuZCB2YWxpZGF0ZSB0aGUgbWV0YWRhdGEgb2JqZWN0XG4gICAgY29uc3QgYmFja2VuZE91dHB1dE1ldGFkYXRhID1cbiAgICAgIGJhY2tlbmRPdXRwdXRTdGFja01ldGFkYXRhU2NoZW1hLnBhcnNlKG1ldGFkYXRhT2JqZWN0KTtcblxuICAgIC8vIERlc2NyaWJlU3RhY2tzIGluY2x1ZGVzIHRoZSB0ZW1wbGF0ZSBvdXRwdXRcbiAgICBjb25zdCBzdGFja0Rlc2NyaXB0aW9uID0gYXdhaXQgdGhpcy5jZm5DbGllbnQuc2VuZChcbiAgICAgIG5ldyBEZXNjcmliZVN0YWNrc0NvbW1hbmQoeyBTdGFja05hbWU6IHN0YWNrTmFtZSB9KVxuICAgICk7XG5cbiAgICBjb25zdCBvdXRwdXRzID0gc3RhY2tEZXNjcmlwdGlvbj8uU3RhY2tzPy5bMF0/Lk91dHB1dHM7XG4gICAgaWYgKHN0YWNrRGVzY3JpcHRpb24uU3RhY2tzPy5bMF0uU3RhY2tTdGF0dXM/LmVuZHNXaXRoKCdfSU5fUFJPR1JFU1MnKSkge1xuICAgICAgY29uc3QgZGVwbG95bWVudFR5cGUgPVxuICAgICAgICBzdGFja0Rlc2NyaXB0aW9uLlN0YWNrcz8uWzBdLlRhZ3M/LmZpbmQoXG4gICAgICAgICAgKHRhZykgPT4gdGFnLktleSA9PT0gJ2FtcGxpZnk6ZGVwbG95bWVudC10eXBlJ1xuICAgICAgICApPy5WYWx1ZSA/PyAnc2FuZGJveCc7XG4gICAgICB0aHJvdyBuZXcgQmFja2VuZE91dHB1dENsaWVudEVycm9yKFxuICAgICAgICBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3JUeXBlLkRFUExPWU1FTlRfSU5fUFJPR1JFU1MsXG4gICAgICAgIGBUaGlzICR7ZGVwbG95bWVudFR5cGV9IGRlcGxveW1lbnQgaXMgaW4gcHJvZ3Jlc3MuIFJlLXJ1biB0aGlzIGNvbW1hbmQgb25jZSB0aGUgZGVwbG95bWVudCBjb21wbGV0ZXMuYFxuICAgICAgKTtcbiAgICB9XG4gICAgaWYgKG91dHB1dHMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgbmV3IEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvcihcbiAgICAgICAgQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZS5OT19PVVRQVVRTX0ZPVU5ELFxuICAgICAgICAnU3RhY2sgb3V0cHV0cyBhcmUgdW5kZWZpbmVkJ1xuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBvdXRwdXRzIGlzIGEgbGlzdCBvZiBvdXRwdXQgZW50cmllcy4gaGVyZSB3ZSB0dXJuIHRoYXQgaW50byBhIFJlY29yZDxuYW1lLCB2YWx1ZT4gb2JqZWN0XG4gICAgY29uc3Qgc3RhY2tPdXRwdXRSZWNvcmQgPSBvdXRwdXRzXG4gICAgICAuZmlsdGVyKChvdXRwdXQpID0+ICEhb3V0cHV0Lk91dHB1dFZhbHVlICYmICEhb3V0cHV0Lk91dHB1dEtleSlcbiAgICAgIC5yZWR1Y2UoXG4gICAgICAgIChhY2N1bXVsYXRvciwgb3V0cHV0RW50cnkpID0+ICh7XG4gICAgICAgICAgLi4uYWNjdW11bGF0b3IsXG4gICAgICAgICAgLy8gaXQncyBzYWZlIHRvIGRpc2FibGUgdGhpcyBydWxlIGJlY2F1c2Ugd2UndmUgYWxyZWFkeSBmaWx0ZXJlZCBvdXQgcG90ZW50aWFsbHkgdW5kZWZpbmVkIG91dHB1dHNcbiAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW5vbi1udWxsLWFzc2VydGlvblxuICAgICAgICAgIFtvdXRwdXRFbnRyeS5PdXRwdXRLZXkhXTogb3V0cHV0RW50cnkuT3V0cHV0VmFsdWUhLFxuICAgICAgICB9KSxcbiAgICAgICAge30gYXMgUmVjb3JkPHN0cmluZywgc3RyaW5nPlxuICAgICAgKTtcblxuICAgIC8vIG5vdyB3ZSBpdGVyYXRlIG92ZXIgdGhlIG1ldGFkYXRhIGVudHJpZXMgYW5kIHJlY29uc3RydWN0IHRoZSBkYXRhIG9iamVjdCBiYXNlZCBvbiB0aGUgc3RhY2tPdXRwdXRzIHRoYXQgZWFjaCBjb25zdHJ1Y3QgcGFja2FnZSBzZXRcbiAgICBjb25zdCByZXN1bHQ6IEJhY2tlbmRPdXRwdXQgPSB7fTtcbiAgICBPYmplY3QuZW50cmllcyhiYWNrZW5kT3V0cHV0TWV0YWRhdGEpLmZvckVhY2goKFtvdXRwdXRLZXlOYW1lLCBlbnRyeV0pID0+IHtcbiAgICAgIGNvbnN0IG91dHB1dERhdGEgPSBlbnRyeS5zdGFja091dHB1dHMucmVkdWNlKFxuICAgICAgICAoYWNjdW11bGF0b3IsIG91dHB1dE5hbWUpID0+IHtcbiAgICAgICAgICBpZiAoXG4gICAgICAgICAgICBzdGFja091dHB1dFJlY29yZFtvdXRwdXROYW1lXSA9PT0gdW5kZWZpbmVkIHx8XG4gICAgICAgICAgICBzdGFja091dHB1dFJlY29yZFtvdXRwdXROYW1lXSA9PT0gJydcbiAgICAgICAgICApIHtcbiAgICAgICAgICAgIHJldHVybiBhY2N1bXVsYXRvcjtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIC4uLmFjY3VtdWxhdG9yLFxuICAgICAgICAgICAgW291dHB1dE5hbWVdOiBzdGFja091dHB1dFJlY29yZFtvdXRwdXROYW1lXSxcbiAgICAgICAgICB9O1xuICAgICAgICB9LFxuICAgICAgICB7fSBhcyBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+XG4gICAgICApO1xuICAgICAgcmVzdWx0W291dHB1dEtleU5hbWVdID0ge1xuICAgICAgICB2ZXJzaW9uOiBlbnRyeS52ZXJzaW9uLFxuICAgICAgICBwYXlsb2FkOiBvdXRwdXREYXRhLFxuICAgICAgfTtcbiAgICB9KTtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9O1xufVxuIl19