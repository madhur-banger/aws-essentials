import { ListStackResourcesCommand, } from '@aws-sdk/client-cloudformation';
/**
 * Lists deployed resources
 */
export class DeployedResourcesEnumerator {
    stackStatusMapper;
    arnGenerator;
    arnParser;
    /**
     * Constructs a DeployedResourcesEnumerator
     */
    constructor(stackStatusMapper, arnGenerator, arnParser) {
        this.stackStatusMapper = stackStatusMapper;
        this.arnGenerator = arnGenerator;
        this.arnParser = arnParser;
    }
    /**
     * Lists all resources deployed in all nested cfn stacks
     */
    listDeployedResources = async (cfnClient, stackName, accountId, region) => {
        const deployedBackendResources = [];
        const stackResourceSummaries = [];
        let nextToken;
        do {
            const stackResources = await cfnClient.send(new ListStackResourcesCommand({
                StackName: stackName,
                NextToken: nextToken,
            }));
            nextToken = stackResources.NextToken;
            stackResourceSummaries.push(...(stackResources.StackResourceSummaries ?? []));
        } while (nextToken);
        const childStackArns = stackResourceSummaries
            .filter((stackResourceSummary) => {
            return (stackResourceSummary.ResourceType === 'AWS::CloudFormation::Stack');
        })
            .map((stackResourceSummary) => {
            return stackResourceSummary.PhysicalResourceId;
        }) ?? [];
        const promises = childStackArns.map((childStackArn) => {
            const childStackName = childStackArn?.split('/')?.[1];
            if (!childStackArn || !childStackName) {
                return [];
            }
            const parsedArn = this.arnParser.tryParseArn(childStackArn);
            // Recursive call to get all the resources from child stacks
            return this.listDeployedResources(cfnClient, childStackName, parsedArn.accountId, parsedArn.region);
        });
        const deployedResourcesPerChildStack = await Promise.all(promises);
        deployedBackendResources.push(...deployedResourcesPerChildStack.flat());
        const parentStackNonStackResources = stackResourceSummaries.filter((stackResourceSummary) => {
            return (stackResourceSummary.ResourceType !== 'AWS::CloudFormation::Stack');
        }) ?? [];
        const parentDeployedNonStackResources = parentStackNonStackResources.map((stackResourceSummary) => ({
            logicalResourceId: stackResourceSummary.LogicalResourceId,
            lastUpdated: stackResourceSummary.LastUpdatedTimestamp,
            resourceStatus: this.stackStatusMapper.translateStackStatus(stackResourceSummary.ResourceStatus),
            resourceStatusReason: stackResourceSummary.ResourceStatusReason,
            resourceType: stackResourceSummary.ResourceType,
            physicalResourceId: stackResourceSummary.PhysicalResourceId,
            arn: this.arnGenerator.generateArn(stackResourceSummary, region, accountId),
        }));
        deployedBackendResources.push(...parentDeployedNonStackResources);
        return deployedBackendResources;
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVwbG95ZWRfcmVzb3VyY2VzX2VudW1lcmF0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZGVwbG95ZWQtYmFja2VuZC1jbGllbnQvZGVwbG95ZWRfcmVzb3VyY2VzX2VudW1lcmF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUVMLHlCQUF5QixHQUcxQixNQUFNLGdDQUFnQyxDQUFDO0FBTXhDOztHQUVHO0FBQ0gsTUFBTSxPQUFPLDJCQUEyQjtJQUtuQjtJQUNBO0lBQ0E7SUFObkI7O09BRUc7SUFDSCxZQUNtQixpQkFBb0MsRUFDcEMsWUFBMEIsRUFDMUIsU0FBb0I7UUFGcEIsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtRQUNwQyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixjQUFTLEdBQVQsU0FBUyxDQUFXO0lBQ3BDLENBQUM7SUFFSjs7T0FFRztJQUNILHFCQUFxQixHQUFHLEtBQUssRUFDM0IsU0FBK0IsRUFDL0IsU0FBaUIsRUFDakIsU0FBNkIsRUFDN0IsTUFBMEIsRUFDVSxFQUFFO1FBQ3RDLE1BQU0sd0JBQXdCLEdBQThCLEVBQUUsQ0FBQztRQUMvRCxNQUFNLHNCQUFzQixHQUEyQixFQUFFLENBQUM7UUFDMUQsSUFBSSxTQUFTLENBQUM7UUFDZCxHQUFHO1lBQ0QsTUFBTSxjQUFjLEdBQ2xCLE1BQU0sU0FBUyxDQUFDLElBQUksQ0FDbEIsSUFBSSx5QkFBeUIsQ0FBQztnQkFDNUIsU0FBUyxFQUFFLFNBQVM7Z0JBQ3BCLFNBQVMsRUFBRSxTQUFTO2FBQ3JCLENBQUMsQ0FDSCxDQUFDO1lBRUosU0FBUyxHQUFHLGNBQWMsQ0FBQyxTQUFTLENBQUM7WUFDckMsc0JBQXNCLENBQUMsSUFBSSxDQUN6QixHQUFHLENBQUMsY0FBYyxDQUFDLHNCQUFzQixJQUFJLEVBQUUsQ0FBQyxDQUNqRCxDQUFDO1NBQ0gsUUFBUSxTQUFTLEVBQUU7UUFFcEIsTUFBTSxjQUFjLEdBQ2xCLHNCQUFzQjthQUNuQixNQUFNLENBQUMsQ0FBQyxvQkFBMEMsRUFBRSxFQUFFO1lBQ3JELE9BQU8sQ0FDTCxvQkFBb0IsQ0FBQyxZQUFZLEtBQUssNEJBQTRCLENBQ25FLENBQUM7UUFDSixDQUFDLENBQUM7YUFDRCxHQUFHLENBQUMsQ0FBQyxvQkFBMEMsRUFBRSxFQUFFO1lBQ2xELE9BQU8sb0JBQW9CLENBQUMsa0JBQWtCLENBQUM7UUFDakQsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBRWIsTUFBTSxRQUFRLEdBQUcsY0FBYyxDQUFDLEdBQUcsQ0FBQyxDQUFDLGFBQWEsRUFBRSxFQUFFO1lBQ3BELE1BQU0sY0FBYyxHQUFHLGFBQWEsRUFBRSxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN0RCxJQUFJLENBQUMsYUFBYSxJQUFJLENBQUMsY0FBYyxFQUFFO2dCQUNyQyxPQUFPLEVBQUUsQ0FBQzthQUNYO1lBRUQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDNUQsNERBQTREO1lBQzVELE9BQU8sSUFBSSxDQUFDLHFCQUFxQixDQUMvQixTQUFTLEVBQ1QsY0FBYyxFQUNkLFNBQVMsQ0FBQyxTQUFTLEVBQ25CLFNBQVMsQ0FBQyxNQUFNLENBQ2pCLENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztRQUNILE1BQU0sOEJBQThCLEdBQUcsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ25FLHdCQUF3QixDQUFDLElBQUksQ0FBQyxHQUFHLDhCQUE4QixDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7UUFFeEUsTUFBTSw0QkFBNEIsR0FDaEMsc0JBQXNCLENBQUMsTUFBTSxDQUMzQixDQUFDLG9CQUEwQyxFQUFFLEVBQUU7WUFDN0MsT0FBTyxDQUNMLG9CQUFvQixDQUFDLFlBQVksS0FBSyw0QkFBNEIsQ0FDbkUsQ0FBQztRQUNKLENBQUMsQ0FDRixJQUFJLEVBQUUsQ0FBQztRQUVWLE1BQU0sK0JBQStCLEdBQUcsNEJBQTRCLENBQUMsR0FBRyxDQUN0RSxDQUFDLG9CQUEwQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQy9DLGlCQUFpQixFQUFFLG9CQUFvQixDQUFDLGlCQUFpQjtZQUN6RCxXQUFXLEVBQUUsb0JBQW9CLENBQUMsb0JBQW9CO1lBQ3RELGNBQWMsRUFBRSxJQUFJLENBQUMsaUJBQWlCLENBQUMsb0JBQW9CLENBQ3pELG9CQUFvQixDQUFDLGNBQWMsQ0FDcEM7WUFDRCxvQkFBb0IsRUFBRSxvQkFBb0IsQ0FBQyxvQkFBb0I7WUFDL0QsWUFBWSxFQUFFLG9CQUFvQixDQUFDLFlBQVk7WUFDL0Msa0JBQWtCLEVBQUUsb0JBQW9CLENBQUMsa0JBQWtCO1lBQzNELEdBQUcsRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FDaEMsb0JBQW9CLEVBQ3BCLE1BQU0sRUFDTixTQUFTLENBQ1Y7U0FDRixDQUFDLENBQ0gsQ0FBQztRQUVGLHdCQUF3QixDQUFDLElBQUksQ0FBQyxHQUFHLCtCQUErQixDQUFDLENBQUM7UUFDbEUsT0FBTyx3QkFBd0IsQ0FBQztJQUNsQyxDQUFDLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENsb3VkRm9ybWF0aW9uQ2xpZW50LFxuICBMaXN0U3RhY2tSZXNvdXJjZXNDb21tYW5kLFxuICBMaXN0U3RhY2tSZXNvdXJjZXNDb21tYW5kT3V0cHV0LFxuICBTdGFja1Jlc291cmNlU3VtbWFyeSxcbn0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWNsb3VkZm9ybWF0aW9uJztcbmltcG9ydCB7IERlcGxveWVkQmFja2VuZFJlc291cmNlIH0gZnJvbSAnLi4vZGVwbG95ZWRfYmFja2VuZF9jbGllbnRfZmFjdG9yeS5qcyc7XG5pbXBvcnQgeyBTdGFja1N0YXR1c01hcHBlciB9IGZyb20gJy4vc3RhY2tfc3RhdHVzX21hcHBlci5qcyc7XG5pbXBvcnQgeyBBcm5HZW5lcmF0b3IgfSBmcm9tICcuL2Fybl9nZW5lcmF0b3IuanMnO1xuaW1wb3J0IHsgQXJuUGFyc2VyIH0gZnJvbSAnLi9hcm5fcGFyc2VyLmpzJztcblxuLyoqXG4gKiBMaXN0cyBkZXBsb3llZCByZXNvdXJjZXNcbiAqL1xuZXhwb3J0IGNsYXNzIERlcGxveWVkUmVzb3VyY2VzRW51bWVyYXRvciB7XG4gIC8qKlxuICAgKiBDb25zdHJ1Y3RzIGEgRGVwbG95ZWRSZXNvdXJjZXNFbnVtZXJhdG9yXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHN0YWNrU3RhdHVzTWFwcGVyOiBTdGFja1N0YXR1c01hcHBlcixcbiAgICBwcml2YXRlIHJlYWRvbmx5IGFybkdlbmVyYXRvcjogQXJuR2VuZXJhdG9yLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYXJuUGFyc2VyOiBBcm5QYXJzZXJcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBMaXN0cyBhbGwgcmVzb3VyY2VzIGRlcGxveWVkIGluIGFsbCBuZXN0ZWQgY2ZuIHN0YWNrc1xuICAgKi9cbiAgbGlzdERlcGxveWVkUmVzb3VyY2VzID0gYXN5bmMgKFxuICAgIGNmbkNsaWVudDogQ2xvdWRGb3JtYXRpb25DbGllbnQsXG4gICAgc3RhY2tOYW1lOiBzdHJpbmcsXG4gICAgYWNjb3VudElkOiBzdHJpbmcgfCB1bmRlZmluZWQsXG4gICAgcmVnaW9uOiBzdHJpbmcgfCB1bmRlZmluZWRcbiAgKTogUHJvbWlzZTxEZXBsb3llZEJhY2tlbmRSZXNvdXJjZVtdPiA9PiB7XG4gICAgY29uc3QgZGVwbG95ZWRCYWNrZW5kUmVzb3VyY2VzOiBEZXBsb3llZEJhY2tlbmRSZXNvdXJjZVtdID0gW107XG4gICAgY29uc3Qgc3RhY2tSZXNvdXJjZVN1bW1hcmllczogU3RhY2tSZXNvdXJjZVN1bW1hcnlbXSA9IFtdO1xuICAgIGxldCBuZXh0VG9rZW47XG4gICAgZG8ge1xuICAgICAgY29uc3Qgc3RhY2tSZXNvdXJjZXM6IExpc3RTdGFja1Jlc291cmNlc0NvbW1hbmRPdXRwdXQgPVxuICAgICAgICBhd2FpdCBjZm5DbGllbnQuc2VuZChcbiAgICAgICAgICBuZXcgTGlzdFN0YWNrUmVzb3VyY2VzQ29tbWFuZCh7XG4gICAgICAgICAgICBTdGFja05hbWU6IHN0YWNrTmFtZSxcbiAgICAgICAgICAgIE5leHRUb2tlbjogbmV4dFRva2VuLFxuICAgICAgICAgIH0pXG4gICAgICAgICk7XG5cbiAgICAgIG5leHRUb2tlbiA9IHN0YWNrUmVzb3VyY2VzLk5leHRUb2tlbjtcbiAgICAgIHN0YWNrUmVzb3VyY2VTdW1tYXJpZXMucHVzaChcbiAgICAgICAgLi4uKHN0YWNrUmVzb3VyY2VzLlN0YWNrUmVzb3VyY2VTdW1tYXJpZXMgPz8gW10pXG4gICAgICApO1xuICAgIH0gd2hpbGUgKG5leHRUb2tlbik7XG5cbiAgICBjb25zdCBjaGlsZFN0YWNrQXJuczogKHN0cmluZyB8IHVuZGVmaW5lZClbXSA9XG4gICAgICBzdGFja1Jlc291cmNlU3VtbWFyaWVzXG4gICAgICAgIC5maWx0ZXIoKHN0YWNrUmVzb3VyY2VTdW1tYXJ5OiBTdGFja1Jlc291cmNlU3VtbWFyeSkgPT4ge1xuICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICBzdGFja1Jlc291cmNlU3VtbWFyeS5SZXNvdXJjZVR5cGUgPT09ICdBV1M6OkNsb3VkRm9ybWF0aW9uOjpTdGFjaydcbiAgICAgICAgICApO1xuICAgICAgICB9KVxuICAgICAgICAubWFwKChzdGFja1Jlc291cmNlU3VtbWFyeTogU3RhY2tSZXNvdXJjZVN1bW1hcnkpID0+IHtcbiAgICAgICAgICByZXR1cm4gc3RhY2tSZXNvdXJjZVN1bW1hcnkuUGh5c2ljYWxSZXNvdXJjZUlkO1xuICAgICAgICB9KSA/PyBbXTtcblxuICAgIGNvbnN0IHByb21pc2VzID0gY2hpbGRTdGFja0FybnMubWFwKChjaGlsZFN0YWNrQXJuKSA9PiB7XG4gICAgICBjb25zdCBjaGlsZFN0YWNrTmFtZSA9IGNoaWxkU3RhY2tBcm4/LnNwbGl0KCcvJyk/LlsxXTtcbiAgICAgIGlmICghY2hpbGRTdGFja0FybiB8fCAhY2hpbGRTdGFja05hbWUpIHtcbiAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBwYXJzZWRBcm4gPSB0aGlzLmFyblBhcnNlci50cnlQYXJzZUFybihjaGlsZFN0YWNrQXJuKTtcbiAgICAgIC8vIFJlY3Vyc2l2ZSBjYWxsIHRvIGdldCBhbGwgdGhlIHJlc291cmNlcyBmcm9tIGNoaWxkIHN0YWNrc1xuICAgICAgcmV0dXJuIHRoaXMubGlzdERlcGxveWVkUmVzb3VyY2VzKFxuICAgICAgICBjZm5DbGllbnQsXG4gICAgICAgIGNoaWxkU3RhY2tOYW1lLFxuICAgICAgICBwYXJzZWRBcm4uYWNjb3VudElkLFxuICAgICAgICBwYXJzZWRBcm4ucmVnaW9uXG4gICAgICApO1xuICAgIH0pO1xuICAgIGNvbnN0IGRlcGxveWVkUmVzb3VyY2VzUGVyQ2hpbGRTdGFjayA9IGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKTtcbiAgICBkZXBsb3llZEJhY2tlbmRSZXNvdXJjZXMucHVzaCguLi5kZXBsb3llZFJlc291cmNlc1BlckNoaWxkU3RhY2suZmxhdCgpKTtcblxuICAgIGNvbnN0IHBhcmVudFN0YWNrTm9uU3RhY2tSZXNvdXJjZXM6IFN0YWNrUmVzb3VyY2VTdW1tYXJ5W10gPVxuICAgICAgc3RhY2tSZXNvdXJjZVN1bW1hcmllcy5maWx0ZXIoXG4gICAgICAgIChzdGFja1Jlc291cmNlU3VtbWFyeTogU3RhY2tSZXNvdXJjZVN1bW1hcnkpID0+IHtcbiAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgc3RhY2tSZXNvdXJjZVN1bW1hcnkuUmVzb3VyY2VUeXBlICE9PSAnQVdTOjpDbG91ZEZvcm1hdGlvbjo6U3RhY2snXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgKSA/PyBbXTtcblxuICAgIGNvbnN0IHBhcmVudERlcGxveWVkTm9uU3RhY2tSZXNvdXJjZXMgPSBwYXJlbnRTdGFja05vblN0YWNrUmVzb3VyY2VzLm1hcChcbiAgICAgIChzdGFja1Jlc291cmNlU3VtbWFyeTogU3RhY2tSZXNvdXJjZVN1bW1hcnkpID0+ICh7XG4gICAgICAgIGxvZ2ljYWxSZXNvdXJjZUlkOiBzdGFja1Jlc291cmNlU3VtbWFyeS5Mb2dpY2FsUmVzb3VyY2VJZCxcbiAgICAgICAgbGFzdFVwZGF0ZWQ6IHN0YWNrUmVzb3VyY2VTdW1tYXJ5Lkxhc3RVcGRhdGVkVGltZXN0YW1wLFxuICAgICAgICByZXNvdXJjZVN0YXR1czogdGhpcy5zdGFja1N0YXR1c01hcHBlci50cmFuc2xhdGVTdGFja1N0YXR1cyhcbiAgICAgICAgICBzdGFja1Jlc291cmNlU3VtbWFyeS5SZXNvdXJjZVN0YXR1c1xuICAgICAgICApLFxuICAgICAgICByZXNvdXJjZVN0YXR1c1JlYXNvbjogc3RhY2tSZXNvdXJjZVN1bW1hcnkuUmVzb3VyY2VTdGF0dXNSZWFzb24sXG4gICAgICAgIHJlc291cmNlVHlwZTogc3RhY2tSZXNvdXJjZVN1bW1hcnkuUmVzb3VyY2VUeXBlLFxuICAgICAgICBwaHlzaWNhbFJlc291cmNlSWQ6IHN0YWNrUmVzb3VyY2VTdW1tYXJ5LlBoeXNpY2FsUmVzb3VyY2VJZCxcbiAgICAgICAgYXJuOiB0aGlzLmFybkdlbmVyYXRvci5nZW5lcmF0ZUFybihcbiAgICAgICAgICBzdGFja1Jlc291cmNlU3VtbWFyeSxcbiAgICAgICAgICByZWdpb24sXG4gICAgICAgICAgYWNjb3VudElkXG4gICAgICAgICksXG4gICAgICB9KVxuICAgICk7XG5cbiAgICBkZXBsb3llZEJhY2tlbmRSZXNvdXJjZXMucHVzaCguLi5wYXJlbnREZXBsb3llZE5vblN0YWNrUmVzb3VyY2VzKTtcbiAgICByZXR1cm4gZGVwbG95ZWRCYWNrZW5kUmVzb3VyY2VzO1xuICB9O1xufVxuIl19