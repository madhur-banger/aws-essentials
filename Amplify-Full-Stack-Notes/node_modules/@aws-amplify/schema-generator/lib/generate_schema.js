import { EmptySchemaError, InvalidSchemaError, TypescriptDataSchemaGenerator, } from '@aws-amplify/graphql-schema-generator';
import fs from 'fs/promises';
import { AmplifyUserError } from '@aws-amplify/platform-core';
/**
 * Schema generator class.
 */
export class SchemaGenerator {
    generate = async (props) => {
        const dbConfig = parseDatabaseUrl(props.connectionUri.value);
        try {
            const schema = await TypescriptDataSchemaGenerator.generate({
                ...dbConfig,
                connectionUriSecretName: props.connectionUri.secretName,
                ...(props.sslCert &&
                    props.sslCert.secretName && {
                    sslCertificateSecretName: props.sslCert.secretName,
                    sslCertificate: props.sslCert.value,
                }),
            });
            await fs.writeFile(props.out, schema);
        }
        catch (err) {
            if (err instanceof EmptySchemaError ||
                err instanceof InvalidSchemaError) {
                throw new AmplifyUserError('DatabaseSchemaError', {
                    // the message already contains descriptive error.
                    message: err.message,
                    resolution: 'Check the database schema.',
                }, err);
            }
            const databaseError = err;
            if (databaseError.code === 'ETIMEDOUT') {
                throw new AmplifyUserError('DatabaseConnectionError', {
                    message: `Unable to connect to the database at ${dbConfig.host}:${dbConfig.port}. `,
                    resolution: 'Check if the credentials are correct. Also, check if the database is running and accessible from the network.',
                }, databaseError);
            }
            throw err;
        }
    };
}
const DEFAULT_ENGINE = 'mysql';
/**
 * Error for database connection failures.
 * This class is intended to be used for casting database connection errors.
 * Do not create instances of this class directly.
 */
class DatabaseConnectError extends Error {
    code;
    /**
     * Creates database connection error.
     */
    constructor(code) {
        super(`Database connection error: ${code}`);
        this.code = code;
    }
}
/**
 * Parses database URL into a configuration object.
 */
export const parseDatabaseUrl = (databaseUrl) => {
    try {
        const parsedDatabaseUrl = new URL(databaseUrl);
        const { username: encodedUsername, password: encodedPassword, hostname: encodedHost, } = parsedDatabaseUrl;
        const username = decodeURIComponent(encodedUsername);
        const password = decodeURIComponent(encodedPassword);
        const host = decodeURIComponent(encodedHost);
        const database = decodeURIComponent(parsedDatabaseUrl?.pathname?.slice(1));
        // Default engine is MySQL
        const engine = constructDBEngine(parsedDatabaseUrl?.protocol?.slice(0, -1) ?? DEFAULT_ENGINE);
        const port = parsedDatabaseUrl?.port
            ? parseInt(parsedDatabaseUrl?.port, 10)
            : getDefaultPort(engine);
        const config = {
            engine,
            username,
            password,
            database,
            host,
            port,
        };
        const missingParts = Object.keys(config).filter((part) => !config[part]);
        if (missingParts.length > 0) {
            throw new AmplifyUserError('DatabaseUrlParseError', {
                message: `One or more parts of the database URL is missing. Missing [${missingParts.join(', ')}].`,
                resolution: 'Ensure the database URL follows the pattern "[mysql|postgresql]://username:password@hostname:port/database".',
            });
        }
        return config;
    }
    catch (err) {
        const error = err;
        throw new AmplifyUserError('DatabaseUrlParseError', {
            message: `Unable to parse the database URL. ${error.message}`,
            resolution: 'Check if the database URL is correct and accessible.',
        });
    }
};
const constructDBEngine = (engine) => {
    switch (engine) {
        case 'mysql':
            return 'mysql';
        case 'postgresql':
        case 'postgres':
            return 'postgresql';
        default:
            throw new AmplifyUserError('DatabaseUnsupportedEngineError', {
                message: `Unsupported database engine: ${engine}`,
                resolution: 'Ensure that database URL specifies supported engine. Supported engines are "mysql", "postgresql", "postgres".',
            });
    }
};
const getDefaultPort = (engine) => {
    switch (engine) {
        case 'mysql':
            return 3306;
        case 'postgresql':
            return 5432;
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGVfc2NoZW1hLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2dlbmVyYXRlX3NjaGVtYS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsZ0JBQWdCLEVBQ2hCLGtCQUFrQixFQUNsQiw2QkFBNkIsR0FDOUIsTUFBTSx1Q0FBdUMsQ0FBQztBQUMvQyxPQUFPLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDN0IsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFvQjlEOztHQUVHO0FBQ0gsTUFBTSxPQUFPLGVBQWU7SUFDMUIsUUFBUSxHQUFHLEtBQUssRUFBRSxLQUE0QixFQUFFLEVBQUU7UUFDaEQsTUFBTSxRQUFRLEdBQUcsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUU3RCxJQUFJO1lBQ0YsTUFBTSxNQUFNLEdBQUcsTUFBTSw2QkFBNkIsQ0FBQyxRQUFRLENBQUM7Z0JBQzFELEdBQUcsUUFBUTtnQkFDWCx1QkFBdUIsRUFBRSxLQUFLLENBQUMsYUFBYSxDQUFDLFVBQVU7Z0JBQ3ZELEdBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTztvQkFDZixLQUFLLENBQUMsT0FBTyxDQUFDLFVBQVUsSUFBSTtvQkFDMUIsd0JBQXdCLEVBQUUsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFVO29CQUNsRCxjQUFjLEVBQUUsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLO2lCQUNwQyxDQUFDO2FBQ0wsQ0FBQyxDQUFDO1lBQ0gsTUFBTSxFQUFFLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUM7U0FDdkM7UUFBQyxPQUFPLEdBQUcsRUFBRTtZQUNaLElBQ0UsR0FBRyxZQUFZLGdCQUFnQjtnQkFDL0IsR0FBRyxZQUFZLGtCQUFrQixFQUNqQztnQkFDQSxNQUFNLElBQUksZ0JBQWdCLENBQ3hCLHFCQUFxQixFQUNyQjtv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RUFDdkI7WUFDRSxPQUFPLEVBQUUscUNBQXFDLEtBQUssQ0FBQyxPQUFPLEVBQUU7WUFDN0QsVUFBVSxFQUFFLHNEQUFzRDtTQUNuRSxDQUNGLENBQUM7S0FDSDtBQUNILENBQUMsQ0FBQztBQUVGLE1BQU0saUJBQWlCLEdBQUcsQ0FBQyxNQUFjLEVBQWEsRUFBRTtJQUN0RCxRQUFRLE1BQU0sRUFBRTtRQUNkLEtBQUssT0FBTztZQUNWLE9BQU8sT0FBTyxDQUFDO1FBQ2pCLEtBQUssWUFBWSxDQUFDO1FBQ2xCLEtBQUssVUFBVTtZQUNiLE9BQU8sWUFBWSxDQUFDO1FBQ3RCO1lBQ0UsTUFBTSxJQUFJLGdCQUFnQixDQUN4QixnQ0FBZ0MsRUFDaEM7Z0JBQ0UsT0FBTyxFQUFFLGdDQUFnQyxNQUFNLEVBQUU7Z0JBQ2pELFVBQVUsRUFDUiwrR0FBK0c7YUFDbEgsQ0FDRixDQUFDO0tBQ0w7QUFDSCxDQUFDLENBQUM7QUFFRixNQUFNLGNBQWMsR0FBRyxDQUFDLE1BQWlCLEVBQVUsRUFBRTtJQUNuRCxRQUFRLE1BQU0sRUFBRTtRQUNkLEtBQUssT0FBTztZQUNWLE9BQU8sSUFBSSxDQUFDO1FBQ2QsS0FBSyxZQUFZO1lBQ2YsT0FBTyxJQUFJLENBQUM7S0FDZjtBQUNILENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEVtcHR5U2NoZW1hRXJyb3IsXG4gIEludmFsaWRTY2hlbWFFcnJvcixcbiAgVHlwZXNjcmlwdERhdGFTY2hlbWFHZW5lcmF0b3IsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9ncmFwaHFsLXNjaGVtYS1nZW5lcmF0b3InO1xuaW1wb3J0IGZzIGZyb20gJ2ZzL3Byb21pc2VzJztcbmltcG9ydCB7IEFtcGxpZnlVc2VyRXJyb3IgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5cbmV4cG9ydCB0eXBlIFNjaGVtYUdlbmVyYXRvckNvbmZpZyA9IHtcbiAgY29ubmVjdGlvblVyaToge1xuICAgIHNlY3JldE5hbWU6IHN0cmluZztcbiAgICB2YWx1ZTogc3RyaW5nO1xuICB9O1xuICBzc2xDZXJ0Pzoge1xuICAgIHNlY3JldE5hbWU6IHN0cmluZztcbiAgICB2YWx1ZTogc3RyaW5nO1xuICB9O1xuICBvdXQ6IHN0cmluZztcbn07XG5cbnR5cGUgQW1wbGlmeUdlbmVyYXRlU2NoZW1hRXJyb3IgPVxuICB8ICdEYXRhYmFzZUNvbm5lY3Rpb25FcnJvcidcbiAgfCAnRGF0YWJhc2VTY2hlbWFFcnJvcidcbiAgfCAnRGF0YWJhc2VVbnN1cHBvcnRlZEVuZ2luZUVycm9yJ1xuICB8ICdEYXRhYmFzZVVybFBhcnNlRXJyb3InO1xuXG4vKipcbiAqIFNjaGVtYSBnZW5lcmF0b3IgY2xhc3MuXG4gKi9cbmV4cG9ydCBjbGFzcyBTY2hlbWFHZW5lcmF0b3Ige1xuICBnZW5lcmF0ZSA9IGFzeW5jIChwcm9wczogU2NoZW1hR2VuZXJhdG9yQ29uZmlnKSA9PiB7XG4gICAgY29uc3QgZGJDb25maWcgPSBwYXJzZURhdGFiYXNlVXJsKHByb3BzLmNvbm5lY3Rpb25VcmkudmFsdWUpO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHNjaGVtYSA9IGF3YWl0IFR5cGVzY3JpcHREYXRhU2NoZW1hR2VuZXJhdG9yLmdlbmVyYXRlKHtcbiAgICAgICAgLi4uZGJDb25maWcsXG4gICAgICAgIGNvbm5lY3Rpb25VcmlTZWNyZXROYW1lOiBwcm9wcy5jb25uZWN0aW9uVXJpLnNlY3JldE5hbWUsXG4gICAgICAgIC4uLihwcm9wcy5zc2xDZXJ0ICYmXG4gICAgICAgICAgcHJvcHMuc3NsQ2VydC5zZWNyZXROYW1lICYmIHtcbiAgICAgICAgICAgIHNzbENlcnRpZmljYXRlU2VjcmV0TmFtZTogcHJvcHMuc3NsQ2VydC5zZWNyZXROYW1lLFxuICAgICAgICAgICAgc3NsQ2VydGlmaWNhdGU6IHByb3BzLnNzbENlcnQudmFsdWUsXG4gICAgICAgICAgfSksXG4gICAgICB9KTtcbiAgICAgIGF3YWl0IGZzLndyaXRlRmlsZShwcm9wcy5vdXQsIHNjaGVtYSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoXG4gICAgICAgIGVyciBpbnN0YW5jZW9mIEVtcHR5U2NoZW1hRXJyb3IgfHxcbiAgICAgICAgZXJyIGluc3RhbmNlb2YgSW52YWxpZFNjaGVtYUVycm9yXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3I8QW1wbGlmeUdlbmVyYXRlU2NoZW1hRXJyb3I+KFxuICAgICAgICAgICdEYXRhYmFzZVNjaGVtYUVycm9yJyxcbiAgICAgICAgICB7XG4gICAgICAgICAgICAvLyB0aGUgbWVzc2FnZSBhbHJlYWR5IGNvbnRhaW5zIGRlc2NyaXB0aXZlIGVycm9yLlxuICAgICAgICAgICAgbWVzc2FnZTogZXJyLm1lc3NhZ2UsXG4gICAgICAgICAgICByZXNvbHV0aW9uOiAnQ2hlY2sgdGhlIGRhdGFiYXNlIHNjaGVtYS4nLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgZXJyXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBjb25zdCBkYXRhYmFzZUVycm9yID0gZXJyIGFzIERhdGFiYXNlQ29ubmVjdEVycm9yO1xuICAgICAgaWYgKGRhdGFiYXNlRXJyb3IuY29kZSA9PT0gJ0VUSU1FRE9VVCcpIHtcbiAgICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3I8QW1wbGlmeUdlbmVyYXRlU2NoZW1hRXJyb3I+KFxuICAgICAgICAgICdEYXRhYmFzZUNvbm5lY3Rpb25FcnJvcicsXG4gICAgICAgICAge1xuICAgICAgICAgICAgbWVzc2FnZTogYFVuYWJsZSB0byBjb25uZWN0IHRvIHRoZSBkYXRhYmFzZSBhdCAke2RiQ29uZmlnLmhvc3R9OiR7ZGJDb25maWcucG9ydH0uIGAsXG4gICAgICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICAgICAnQ2hlY2sgaWYgdGhlIGNyZWRlbnRpYWxzIGFyZSBjb3JyZWN0LiBBbHNvLCBjaGVjayBpZiB0aGUgZGF0YWJhc2UgaXMgcnVubmluZyBhbmQgYWNjZXNzaWJsZSBmcm9tIHRoZSBuZXR3b3JrLicsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBkYXRhYmFzZUVycm9yXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICB9O1xufVxuXG5leHBvcnQgdHlwZSBTUUxFbmdpbmUgPSAnbXlzcWwnIHwgJ3Bvc3RncmVzcWwnO1xuY29uc3QgREVGQVVMVF9FTkdJTkUgPSAnbXlzcWwnO1xuXG5leHBvcnQgdHlwZSBTUUxEYXRhU291cmNlQ29uZmlnID0ge1xuICBlbmdpbmU6IFNRTEVuZ2luZTtcbiAgdXNlcm5hbWU6IHN0cmluZztcbiAgcGFzc3dvcmQ6IHN0cmluZztcbiAgaG9zdDogc3RyaW5nO1xuICBkYXRhYmFzZTogc3RyaW5nO1xuICBwb3J0OiBudW1iZXI7XG59O1xuXG4vKipcbiAqIEVycm9yIGZvciBkYXRhYmFzZSBjb25uZWN0aW9uIGZhaWx1cmVzLlxuICogVGhpcyBjbGFzcyBpcyBpbnRlbmRlZCB0byBiZSB1c2VkIGZvciBjYXN0aW5nIGRhdGFiYXNlIGNvbm5lY3Rpb24gZXJyb3JzLlxuICogRG8gbm90IGNyZWF0ZSBpbnN0YW5jZXMgb2YgdGhpcyBjbGFzcyBkaXJlY3RseS5cbiAqL1xuYWJzdHJhY3QgY2xhc3MgRGF0YWJhc2VDb25uZWN0RXJyb3IgZXh0ZW5kcyBFcnJvciB7XG4gIC8qKlxuICAgKiBDcmVhdGVzIGRhdGFiYXNlIGNvbm5lY3Rpb24gZXJyb3IuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihyZWFkb25seSBjb2RlPzogc3RyaW5nKSB7XG4gICAgc3VwZXIoYERhdGFiYXNlIGNvbm5lY3Rpb24gZXJyb3I6ICR7Y29kZX1gKTtcbiAgfVxufVxuXG4vKipcbiAqIFBhcnNlcyBkYXRhYmFzZSBVUkwgaW50byBhIGNvbmZpZ3VyYXRpb24gb2JqZWN0LlxuICovXG5leHBvcnQgY29uc3QgcGFyc2VEYXRhYmFzZVVybCA9IChkYXRhYmFzZVVybDogc3RyaW5nKTogU1FMRGF0YVNvdXJjZUNvbmZpZyA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgcGFyc2VkRGF0YWJhc2VVcmwgPSBuZXcgVVJMKGRhdGFiYXNlVXJsKTtcbiAgICBjb25zdCB7XG4gICAgICB1c2VybmFtZTogZW5jb2RlZFVzZXJuYW1lLFxuICAgICAgcGFzc3dvcmQ6IGVuY29kZWRQYXNzd29yZCxcbiAgICAgIGhvc3RuYW1lOiBlbmNvZGVkSG9zdCxcbiAgICB9ID0gcGFyc2VkRGF0YWJhc2VVcmw7XG4gICAgY29uc3QgdXNlcm5hbWUgPSBkZWNvZGVVUklDb21wb25lbnQoZW5jb2RlZFVzZXJuYW1lKTtcbiAgICBjb25zdCBwYXNzd29yZCA9IGRlY29kZVVSSUNvbXBvbmVudChlbmNvZGVkUGFzc3dvcmQpO1xuICAgIGNvbnN0IGhvc3QgPSBkZWNvZGVVUklDb21wb25lbnQoZW5jb2RlZEhvc3QpO1xuICAgIGNvbnN0IGRhdGFiYXNlID0gZGVjb2RlVVJJQ29tcG9uZW50KHBhcnNlZERhdGFiYXNlVXJsPy5wYXRobmFtZT8uc2xpY2UoMSkpO1xuICAgIC8vIERlZmF1bHQgZW5naW5lIGlzIE15U1FMXG4gICAgY29uc3QgZW5naW5lID0gY29uc3RydWN0REJFbmdpbmUoXG4gICAgICBwYXJzZWREYXRhYmFzZVVybD8ucHJvdG9jb2w/LnNsaWNlKDAsIC0xKSA/PyBERUZBVUxUX0VOR0lORVxuICAgICk7XG4gICAgY29uc3QgcG9ydCA9IHBhcnNlZERhdGFiYXNlVXJsPy5wb3J0XG4gICAgICA/IHBhcnNlSW50KHBhcnNlZERhdGFiYXNlVXJsPy5wb3J0LCAxMClcbiAgICAgIDogZ2V0RGVmYXVsdFBvcnQoZW5naW5lKTtcblxuICAgIGNvbnN0IGNvbmZpZyA9IHtcbiAgICAgIGVuZ2luZSxcbiAgICAgIHVzZXJuYW1lLFxuICAgICAgcGFzc3dvcmQsXG4gICAgICBkYXRhYmFzZSxcbiAgICAgIGhvc3QsXG4gICAgICBwb3J0LFxuICAgIH0gYXMgU1FMRGF0YVNvdXJjZUNvbmZpZztcblxuICAgIGNvbnN0IG1pc3NpbmdQYXJ0cyA9IChcbiAgICAgIE9iamVjdC5rZXlzKGNvbmZpZykgYXMgQXJyYXk8a2V5b2YgU1FMRGF0YVNvdXJjZUNvbmZpZz5cbiAgICApLmZpbHRlcigocGFydCkgPT4gIWNvbmZpZ1twYXJ0XSk7XG5cbiAgICBpZiAobWlzc2luZ1BhcnRzLmxlbmd0aCA+IDApIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yPEFtcGxpZnlHZW5lcmF0ZVNjaGVtYUVycm9yPihcbiAgICAgICAgJ0RhdGFiYXNlVXJsUGFyc2VFcnJvcicsXG4gICAgICAgIHtcbiAgICAgICAgICBtZXNzYWdlOiBgT25lIG9yIG1vcmUgcGFydHMgb2YgdGhlIGRhdGFiYXNlIFVSTCBpcyBtaXNzaW5nLiBNaXNzaW5nIFske21pc3NpbmdQYXJ0cy5qb2luKFxuICAgICAgICAgICAgJywgJ1xuICAgICAgICAgICl9XS5gLFxuICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAnRW5zdXJlIHRoZSBkYXRhYmFzZSBVUkwgZm9sbG93cyB0aGUgcGF0dGVybiBcIltteXNxbHxwb3N0Z3Jlc3FsXTovL3VzZXJuYW1lOnBhc3N3b3JkQGhvc3RuYW1lOnBvcnQvZGF0YWJhc2VcIi4nLFxuICAgICAgICB9XG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBjb25maWc7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGNvbnN0IGVycm9yID0gZXJyIGFzIEVycm9yO1xuICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yPEFtcGxpZnlHZW5lcmF0ZVNjaGVtYUVycm9yPihcbiAgICAgICdEYXRhYmFzZVVybFBhcnNlRXJyb3InLFxuICAgICAge1xuICAgICAgICBtZXNzYWdlOiBgVW5hYmxlIHRvIHBhcnNlIHRoZSBkYXRhYmFzZSBVUkwuICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICByZXNvbHV0aW9uOiAnQ2hlY2sgaWYgdGhlIGRhdGFiYXNlIFVSTCBpcyBjb3JyZWN0IGFuZCBhY2Nlc3NpYmxlLicsXG4gICAgICB9XG4gICAgKTtcbiAgfVxufTtcblxuY29uc3QgY29uc3RydWN0REJFbmdpbmUgPSAoZW5naW5lOiBzdHJpbmcpOiBTUUxFbmdpbmUgPT4ge1xuICBzd2l0Y2ggKGVuZ2luZSkge1xuICAgIGNhc2UgJ215c3FsJzpcbiAgICAgIHJldHVybiAnbXlzcWwnO1xuICAgIGNhc2UgJ3Bvc3RncmVzcWwnOlxuICAgIGNhc2UgJ3Bvc3RncmVzJzpcbiAgICAgIHJldHVybiAncG9zdGdyZXNxbCc7XG4gICAgZGVmYXVsdDpcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yPEFtcGxpZnlHZW5lcmF0ZVNjaGVtYUVycm9yPihcbiAgICAgICAgJ0RhdGFiYXNlVW5zdXBwb3J0ZWRFbmdpbmVFcnJvcicsXG4gICAgICAgIHtcbiAgICAgICAgICBtZXNzYWdlOiBgVW5zdXBwb3J0ZWQgZGF0YWJhc2UgZW5naW5lOiAke2VuZ2luZX1gLFxuICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAnRW5zdXJlIHRoYXQgZGF0YWJhc2UgVVJMIHNwZWNpZmllcyBzdXBwb3J0ZWQgZW5naW5lLiBTdXBwb3J0ZWQgZW5naW5lcyBhcmUgXCJteXNxbFwiLCBcInBvc3RncmVzcWxcIiwgXCJwb3N0Z3Jlc1wiLicsXG4gICAgICAgIH1cbiAgICAgICk7XG4gIH1cbn07XG5cbmNvbnN0IGdldERlZmF1bHRQb3J0ID0gKGVuZ2luZTogU1FMRW5naW5lKTogbnVtYmVyID0+IHtcbiAgc3dpdGNoIChlbmdpbmUpIHtcbiAgICBjYXNlICdteXNxbCc6XG4gICAgICByZXR1cm4gMzMwNjtcbiAgICBjYXNlICdwb3N0Z3Jlc3FsJzpcbiAgICAgIHJldHVybiA1NDMyO1xuICB9XG59O1xuIl19