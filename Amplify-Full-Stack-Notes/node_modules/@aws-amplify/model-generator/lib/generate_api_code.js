import { createGraphqlModelsGenerator } from './create_graphql_models_generator.js';
import { createGraphqlTypesGenerator } from './create_graphql_types_generator.js';
import { createGraphqlDocumentGenerator } from './create_graphql_document_generator.js';
import { getOutputFileName } from '@aws-amplify/graphql-types-generator';
import path from 'path';
export var GenerateApiCodeFormat;
(function (GenerateApiCodeFormat) {
    GenerateApiCodeFormat["MODELGEN"] = "modelgen";
    GenerateApiCodeFormat["GRAPHQL_CODEGEN"] = "graphql-codegen";
    GenerateApiCodeFormat["INTROSPECTION"] = "introspection";
})(GenerateApiCodeFormat || (GenerateApiCodeFormat = {}));
export var GenerateApiCodeModelTarget;
(function (GenerateApiCodeModelTarget) {
    GenerateApiCodeModelTarget["JAVA"] = "java";
    GenerateApiCodeModelTarget["SWIFT"] = "swift";
    GenerateApiCodeModelTarget["JAVASCRIPT"] = "javascript";
    GenerateApiCodeModelTarget["TYPESCRIPT"] = "typescript";
    GenerateApiCodeModelTarget["DART"] = "dart";
})(GenerateApiCodeModelTarget || (GenerateApiCodeModelTarget = {}));
export var GenerateApiCodeStatementTarget;
(function (GenerateApiCodeStatementTarget) {
    GenerateApiCodeStatementTarget["JAVASCRIPT"] = "javascript";
    GenerateApiCodeStatementTarget["GRAPHQL"] = "graphql";
    GenerateApiCodeStatementTarget["FLOW"] = "flow";
    GenerateApiCodeStatementTarget["TYPESCRIPT"] = "typescript";
    GenerateApiCodeStatementTarget["ANGULAR"] = "angular";
})(GenerateApiCodeStatementTarget || (GenerateApiCodeStatementTarget = {}));
export var GenerateApiCodeTypeTarget;
(function (GenerateApiCodeTypeTarget) {
    GenerateApiCodeTypeTarget["JSON"] = "json";
    GenerateApiCodeTypeTarget["SWIFT"] = "swift";
    GenerateApiCodeTypeTarget["TYPESCRIPT"] = "typescript";
    GenerateApiCodeTypeTarget["FLOW"] = "flow";
    GenerateApiCodeTypeTarget["SCALA"] = "scala";
    GenerateApiCodeTypeTarget["FLOW_MODERN"] = "flow-modern";
    GenerateApiCodeTypeTarget["ANGULAR"] = "angular";
})(GenerateApiCodeTypeTarget || (GenerateApiCodeTypeTarget = {}));
/**
 * Generate api code using Api Code Generator with default generators.
 */
export const generateApiCode = async (props) => {
    const backendIdentifier = props;
    return new ApiCodeGenerator(createGraphqlDocumentGenerator({
        backendIdentifier,
        awsClientProvider: props.awsClientProvider,
    }), createGraphqlTypesGenerator({
        backendIdentifier,
        awsClientProvider: props.awsClientProvider,
    }), createGraphqlModelsGenerator({
        backendIdentifier,
        awsClientProvider: props.awsClientProvider,
    })).generate(props);
};
/**
 * Generator for Api Code resources.
 */
export class ApiCodeGenerator {
    graphqlDocumentGenerator;
    graphqlTypesGenerator;
    graphqlModelsGenerator;
    /**
     * Construct generator, passing in nested generators.
     * @param graphqlDocumentGenerator the graphql document generator
     * @param graphqlTypesGenerator the type generator
     * @param graphqlModelsGenerator the model object generator
     */
    constructor(graphqlDocumentGenerator, graphqlTypesGenerator, graphqlModelsGenerator) {
        this.graphqlDocumentGenerator = graphqlDocumentGenerator;
        this.graphqlTypesGenerator = graphqlTypesGenerator;
        this.graphqlModelsGenerator = graphqlModelsGenerator;
    }
    /**
     * Execute the generation.
     * @param props the required generate options.
     * @returns a promise with the generation results
     */
    generate(props) {
        switch (props.format) {
            case 'graphql-codegen': {
                return this.generateGraphqlCodegenApiCode(props);
            }
            case 'modelgen': {
                return this.generateModelgenApiCode(props);
            }
            case 'introspection': {
                return this.generateIntrospectionApiCode();
            }
            default:
                // eslint-disable-next-line amplify-backend-rules/prefer-amplify-errors
                throw new Error(`${props.format} is not a supported format.`);
        }
    }
    /**
     * Execute document, and optionally type generation with relevant targets, wiring through types into statements if possible.
     */
    async generateGraphqlCodegenApiCode(props) {
        const generateModelsParams = {
            targetFormat: props.statementTarget,
            maxDepth: props.maxDepth,
            typenameIntrospection: props.typeNameIntrospection,
        };
        if (props.statementTarget === GenerateApiCodeStatementTarget.TYPESCRIPT &&
            props.typeTarget === GenerateApiCodeTypeTarget.TYPESCRIPT) {
            // Cast to unknown to string since the original input to this is typed as a required string, but expects an optional
            // value, and we want to rely on that behavior.
            const typeOutputFilepath = getOutputFileName(null, props.typeTarget);
            const fileName = path.parse(typeOutputFilepath).name;
            // This is an node import path, so we don't want to use path.join, since that'll produce invalid paths on windows platforms
            // Hard-coding since this method explicitly writes to the same directory if types are enabled.
            generateModelsParams.relativeTypesPath = `./${fileName}`;
        }
        const documents = await this.graphqlDocumentGenerator.generateModels(generateModelsParams);
        if (props.typeTarget) {
            const types = await this.graphqlTypesGenerator.generateTypes({
                target: props.typeTarget,
                multipleSwiftFiles: props.multipleSwiftFiles,
                maxDepth: props.maxDepth,
                typenameIntrospection: props.typeNameIntrospection,
            });
            return {
                writeToDirectory: async (directoryPath) => {
                    const filesWritten = [];
                    const { filesWritten: documentsFilesWritten } = await documents.writeToDirectory(directoryPath);
                    const { filesWritten: typesFilesWritten } = await types.writeToDirectory(directoryPath);
                    filesWritten.push(...documentsFilesWritten, ...typesFilesWritten);
                    return {
                        filesWritten,
                    };
                },
                getResults: async () => ({
                    ...(await documents.getResults()),
                    ...(await types.getResults()),
                }),
            };
        }
        return documents;
    }
    /**
     * Execute model generation with model target.
     */
    async generateModelgenApiCode(props) {
        return this.graphqlModelsGenerator.generateModels({
            target: props.modelTarget,
            generateIndexRules: props.generateIndexRules,
            emitAuthProvider: props.emitAuthProvider,
            useExperimentalPipelinedTransformer: props.useExperimentalPipelinedTransformer,
            transformerVersion: props.transformerVersion,
            respectPrimaryKeyAttributesOnConnectionField: props.respectPrimaryKeyAttributesOnConnectionField,
            generateModelsForLazyLoadAndCustomSelectionSet: props.generateModelsForLazyLoadAndCustomSelectionSet,
            addTimestampFields: props.addTimestampFields,
            handleListNullabilityTransparently: props.handleListNullabilityTransparently,
        });
    }
    /**
     * Execute model generation with introspection target.
     */
    async generateIntrospectionApiCode() {
        return this.graphqlModelsGenerator.generateModels({
            target: 'introspection',
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGVfYXBpX2NvZGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZ2VuZXJhdGVfYXBpX2NvZGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBUUEsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDcEYsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDbEYsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFDeEYsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDekUsT0FBTyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBT3hCLE1BQU0sQ0FBTixJQUFZLHFCQUlYO0FBSkQsV0FBWSxxQkFBcUI7SUFDL0IsOENBQXFCLENBQUE7SUFDckIsNERBQW1DLENBQUE7SUFDbkMsd0RBQStCLENBQUE7QUFDakMsQ0FBQyxFQUpXLHFCQUFxQixLQUFyQixxQkFBcUIsUUFJaEM7QUFFRCxNQUFNLENBQU4sSUFBWSwwQkFNWDtBQU5ELFdBQVksMEJBQTBCO0lBQ3BDLDJDQUFhLENBQUE7SUFDYiw2Q0FBZSxDQUFBO0lBQ2YsdURBQXlCLENBQUE7SUFDekIsdURBQXlCLENBQUE7SUFDekIsMkNBQWEsQ0FBQTtBQUNmLENBQUMsRUFOVywwQkFBMEIsS0FBMUIsMEJBQTBCLFFBTXJDO0FBRUQsTUFBTSxDQUFOLElBQVksOEJBTVg7QUFORCxXQUFZLDhCQUE4QjtJQUN4QywyREFBeUIsQ0FBQTtJQUN6QixxREFBbUIsQ0FBQTtJQUNuQiwrQ0FBYSxDQUFBO0lBQ2IsMkRBQXlCLENBQUE7SUFDekIscURBQW1CLENBQUE7QUFDckIsQ0FBQyxFQU5XLDhCQUE4QixLQUE5Qiw4QkFBOEIsUUFNekM7QUFFRCxNQUFNLENBQU4sSUFBWSx5QkFRWDtBQVJELFdBQVkseUJBQXlCO0lBQ25DLDBDQUFhLENBQUE7SUFDYiw0Q0FBZSxDQUFBO0lBQ2Ysc0RB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QUFnQixFQUFFLEtBQUssQ0FBQyxnQkFBZ0I7WUFDeEMsbUNBQW1DLEVBQ2pDLEtBQUssQ0FBQyxtQ0FBbUM7WUFDM0Msa0JBQWtCLEVBQUUsS0FBSyxDQUFDLGtCQUFrQjtZQUM1Qyw0Q0FBNEMsRUFDMUMsS0FBSyxDQUFDLDRDQUE0QztZQUNwRCw4Q0FBOEMsRUFDNUMsS0FBSyxDQUFDLDhDQUE4QztZQUN0RCxrQkFBa0IsRUFBRSxLQUFLLENBQUMsa0JBQWtCO1lBQzVDLGtDQUFrQyxFQUNoQyxLQUFLLENBQUMsa0NBQWtDO1NBQzNDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7T0FFRztJQUNLLEtBQUssQ0FBQyw0QkFBNEI7UUFDeEMsT0FBTyxJQUFJLENBQUMsc0JBQXNCLENBQUMsY0FBYyxDQUFDO1lBQ2hELE1BQU0sRUFBRSxlQUFlO1NBQ3hCLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIERvY3VtZW50R2VuZXJhdGlvblBhcmFtZXRlcnMsXG4gIEdlbmVyYXRlR3JhcGhxbENvZGVnZW5Ub0ZpbGVSZXN1bHQsXG4gIEdlbmVyYXRpb25SZXN1bHQsXG4gIEdyYXBocWxEb2N1bWVudEdlbmVyYXRvcixcbiAgR3JhcGhxbE1vZGVsc0dlbmVyYXRvcixcbiAgR3JhcGhxbFR5cGVzR2VuZXJhdG9yLFxufSBmcm9tICcuL21vZGVsX2dlbmVyYXRvci5qcyc7XG5pbXBvcnQgeyBjcmVhdGVHcmFwaHFsTW9kZWxzR2VuZXJhdG9yIH0gZnJvbSAnLi9jcmVhdGVfZ3JhcGhxbF9tb2RlbHNfZ2VuZXJhdG9yLmpzJztcbmltcG9ydCB7IGNyZWF0ZUdyYXBocWxUeXBlc0dlbmVyYXRvciB9IGZyb20gJy4vY3JlYXRlX2dyYXBocWxfdHlwZXNfZ2VuZXJhdG9yLmpzJztcbmltcG9ydCB7IGNyZWF0ZUdyYXBocWxEb2N1bWVudEdlbmVyYXRvciB9IGZyb20gJy4vY3JlYXRlX2dyYXBocWxfZG9jdW1lbnRfZ2VuZXJhdG9yLmpzJztcbmltcG9ydCB7IGdldE91dHB1dEZpbGVOYW1lIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2dyYXBocWwtdHlwZXMtZ2VuZXJhdG9yJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgRGVwbG95ZWRCYWNrZW5kSWRlbnRpZmllciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9kZXBsb3llZC1iYWNrZW5kLWNsaWVudCc7XG5pbXBvcnQgeyBBV1NDbGllbnRQcm92aWRlciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHsgQW1wbGlmeUNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1hbXBsaWZ5JztcbmltcG9ydCB7IENsb3VkRm9ybWF0aW9uQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWNsb3VkZm9ybWF0aW9uJztcbmltcG9ydCB7IFMzQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXMzJztcblxuZXhwb3J0IGVudW0gR2VuZXJhdGVBcGlDb2RlRm9ybWF0IHtcbiAgTU9ERUxHRU4gPSAnbW9kZWxnZW4nLFxuICBHUkFQSFFMX0NPREVHRU4gPSAnZ3JhcGhxbC1jb2RlZ2VuJyxcbiAgSU5UUk9TUEVDVElPTiA9ICdpbnRyb3NwZWN0aW9uJyxcbn1cblxuZXhwb3J0IGVudW0gR2VuZXJhdGVBcGlDb2RlTW9kZWxUYXJnZXQge1xuICBKQVZBID0gJ2phdmEnLFxuICBTV0lGVCA9ICdzd2lmdCcsXG4gIEpBVkFTQ1JJUFQgPSAnamF2YXNjcmlwdCcsXG4gIFRZUEVTQ1JJUFQgPSAndHlwZXNjcmlwdCcsXG4gIERBUlQgPSAnZGFydCcsXG59XG5cbmV4cG9ydCBlbnVtIEdlbmVyYXRlQXBpQ29kZVN0YXRlbWVudFRhcmdldCB7XG4gIEpBVkFTQ1JJUFQgPSAnamF2YXNjcmlwdCcsXG4gIEdSQVBIUUwgPSAnZ3JhcGhxbCcsXG4gIEZMT1cgPSAnZmxvdycsXG4gIFRZUEVTQ1JJUFQgPSAndHlwZXNjcmlwdCcsXG4gIEFOR1VMQVIgPSAnYW5ndWxhcicsXG59XG5cbmV4cG9ydCBlbnVtIEdlbmVyYXRlQXBpQ29kZVR5cGVUYXJnZXQge1xuICBKU09OID0gJ2pzb24nLFxuICBTV0lGVCA9ICdzd2lmdCcsXG4gIFRZUEVTQ1JJUFQgPSAndHlwZXNjcmlwdCcsXG4gIEZMT1cgPSAnZmxvdycsXG4gIFNDQUxBID0gJ3NjYWxhJyxcbiAgRkxPV19NT0RFUk4gPSAnZmxvdy1tb2Rlcm4nLFxuICBBTkdVTEFSID0gJ2FuZ3VsYXInLFxufVxuXG5leHBvcnQgdHlwZSBHZW5lcmF0ZU1vZGVsc09wdGlvbnMgPSB7XG4gIGZvcm1hdDogR2VuZXJhdGVBcGlDb2RlRm9ybWF0Lk1PREVMR0VOO1xuICBtb2RlbFRhcmdldDogR2VuZXJhdGVBcGlDb2RlTW9kZWxUYXJnZXQ7XG4gIGdlbmVyYXRlSW5kZXhSdWxlcz86IGJvb2xlYW47XG4gIGVtaXRBdXRoUHJvdmlkZXI/OiBib29sZWFuO1xuICB1c2VFeHBlcmltZW50YWxQaXBlbGluZWRUcmFuc2Zvcm1lcj86IGJvb2xlYW47XG4gIHRyYW5zZm9ybWVyVmVyc2lvbj86IG51bWJlcjtcbiAgcmVzcGVjdFByaW1hcnlLZXlBdHRyaWJ1dGVzT25Db25uZWN0aW9uRmllbGQ/OiBib29sZWFuO1xuICBnZW5lcmF0ZU1vZGVsc0ZvckxhenlMb2FkQW5kQ3VzdG9tU2VsZWN0aW9uU2V0PzogYm9vbGVhbjtcbiAgYWRkVGltZXN0YW1wRmllbGRzPzogYm9vbGVhbjtcbiAgaGFuZGxlTGlzdE51bGxhYmlsaXR5VHJhbnNwYXJlbnRseT86IGJvb2xlYW47XG59O1xuXG5leHBvcnQgdHlwZSBHZW5lcmF0ZUdyYXBocWxDb2RlZ2VuT3B0aW9ucyA9IHtcbiAgZm9ybWF0OiBHZW5lcmF0ZUFwaUNvZGVGb3JtYXQuR1JBUEhRTF9DT0RFR0VOO1xuICBzdGF0ZW1lbnRUYXJnZXQ6IEdlbmVyYXRlQXBpQ29kZVN0YXRlbWVudFRhcmdldDtcbiAgbWF4RGVwdGg/OiBudW1iZXI7XG4gIHR5cGVOYW1lSW50cm9zcGVjdGlvbj86IGJvb2xlYW47XG4gIHR5cGVUYXJnZXQ/OiBHZW5lcmF0ZUFwaUNvZGVUeXBlVGFyZ2V0O1xuICBtdWx0aXBsZVN3aWZ0RmlsZXM/OiBib29sZWFuO1xufTtcblxuZXhwb3J0IHR5cGUgR2VuZXJhdGVJbnRyb3NwZWN0aW9uT3B0aW9ucyA9IHtcbiAgZm9ybWF0OiBHZW5lcmF0ZUFwaUNvZGVGb3JtYXQuSU5UUk9TUEVDVElPTjtcbn07XG5cbmV4cG9ydCB0eXBlIEdlbmVyYXRlT3B0aW9ucyA9XG4gIHwgR2VuZXJhdGVHcmFwaHFsQ29kZWdlbk9wdGlvbnNcbiAgfCBHZW5lcmF0ZU1vZGVsc09wdGlvbnNcbiAgfCBHZW5lcmF0ZUludHJvc3BlY3Rpb25PcHRpb25zO1xuXG5leHBvcnQgdHlwZSBHZW5lcmF0ZUFwaUNvZGVQcm9wcyA9IEdlbmVyYXRlT3B0aW9ucyAmXG4gIERlcGxveWVkQmFja2VuZElkZW50aWZpZXIgJiB7XG4gICAgYXdzQ2xpZW50UHJvdmlkZXI6IEFXU0NsaWVudFByb3ZpZGVyPHtcbiAgICAgIGdldEFtcGxpZnlDbGllbnQ6IEFtcGxpZnlDbGllbnQ7XG4gICAgICBnZXRDbG91ZEZvcm1hdGlvbkNsaWVudDogQ2xvdWRGb3JtYXRpb25DbGllbnQ7XG4gICAgICBnZXRTM0NsaWVudDogUzNDbGllbnQ7XG4gICAgfT47XG4gIH07XG5cbi8qKlxuICogR2VuZXJhdGUgYXBpIGNvZGUgdXNpbmcgQXBpIENvZGUgR2VuZXJhdG9yIHdpdGggZGVmYXVsdCBnZW5lcmF0b3JzLlxuICovXG5leHBvcnQgY29uc3QgZ2VuZXJhdGVBcGlDb2RlID0gYXN5bmMgKFxuICBwcm9wczogR2VuZXJhdGVBcGlDb2RlUHJvcHNcbik6IFByb21pc2U8R2VuZXJhdGlvblJlc3VsdD4gPT4ge1xuICBjb25zdCBiYWNrZW5kSWRlbnRpZmllciA9IHByb3BzO1xuICByZXR1cm4gbmV3IEFwaUNvZGVHZW5lcmF0b3IoXG4gICAgY3JlYXRlR3JhcGhxbERvY3VtZW50R2VuZXJhdG9yKHtcbiAgICAgIGJhY2tlbmRJZGVudGlmaWVyLFxuICAgICAgYXdzQ2xpZW50UHJvdmlkZXI6IHByb3BzLmF3c0NsaWVudFByb3ZpZGVyLFxuICAgIH0pLFxuICAgIGNyZWF0ZUdyYXBocWxUeXBlc0dlbmVyYXRvcih7XG4gICAgICBiYWNrZW5kSWRlbnRpZmllcixcbiAgICAgIGF3c0NsaWVudFByb3ZpZGVyOiBwcm9wcy5hd3NDbGllbnRQcm92aWRlcixcbiAgICB9KSxcbiAgICBjcmVhdGVHcmFwaHFsTW9kZWxzR2VuZXJhdG9yKHtcbiAgICAgIGJhY2tlbmRJZGVudGlmaWVyLFxuICAgICAgYXdzQ2xpZW50UHJvdmlkZXI6IHByb3BzLmF3c0NsaWVudFByb3ZpZGVyLFxuICAgIH0pXG4gICkuZ2VuZXJhdGUocHJvcHMpO1xufTtcblxuLyoqXG4gKiBHZW5lcmF0b3IgZm9yIEFwaSBDb2RlIHJlc291cmNlcy5cbiAqL1xuZXhwb3J0IGNsYXNzIEFwaUNvZGVHZW5lcmF0b3Ige1xuICAvKipcbiAgICogQ29uc3RydWN0IGdlbmVyYXRvciwgcGFzc2luZyBpbiBuZXN0ZWQgZ2VuZXJhdG9ycy5cbiAgICogQHBhcmFtIGdyYXBocWxEb2N1bWVudEdlbmVyYXRvciB0aGUgZ3JhcGhxbCBkb2N1bWVudCBnZW5lcmF0b3JcbiAgICogQHBhcmFtIGdyYXBocWxUeXBlc0dlbmVyYXRvciB0aGUgdHlwZSBnZW5lcmF0b3JcbiAgICogQHBhcmFtIGdyYXBocWxNb2RlbHNHZW5lcmF0b3IgdGhlIG1vZGVsIG9iamVjdCBnZW5lcmF0b3JcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZ3JhcGhxbERvY3VtZW50R2VuZXJhdG9yOiBHcmFwaHFsRG9jdW1lbnRHZW5lcmF0b3IsXG4gICAgcHJpdmF0ZSByZWFkb25seSBncmFwaHFsVHlwZXNHZW5lcmF0b3I6IEdyYXBocWxUeXBlc0dlbmVyYXRvcixcbiAgICBwcml2YXRlIHJlYWRvbmx5IGdyYXBocWxNb2RlbHNHZW5lcmF0b3I6IEdyYXBocWxNb2RlbHNHZW5lcmF0b3JcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBFeGVjdXRlIHRoZSBnZW5lcmF0aW9uLlxuICAgKiBAcGFyYW0gcHJvcHMgdGhlIHJlcXVpcmVkIGdlbmVyYXRlIG9wdGlvbnMuXG4gICAqIEByZXR1cm5zIGEgcHJvbWlzZSB3aXRoIHRoZSBnZW5lcmF0aW9uIHJlc3VsdHNcbiAgICovXG4gIGdlbmVyYXRlKHByb3BzOiBHZW5lcmF0ZU9wdGlvbnMpOiBQcm9taXNlPEdlbmVyYXRpb25SZXN1bHQ+IHtcbiAgICBzd2l0Y2ggKHByb3BzLmZvcm1hdCkge1xuICAgICAgY2FzZSAnZ3JhcGhxbC1jb2RlZ2VuJzoge1xuICAgICAgICByZXR1cm4gdGhpcy5nZW5lcmF0ZUdyYXBocWxDb2RlZ2VuQXBpQ29kZShwcm9wcyk7XG4gICAgICB9XG4gICAgICBjYXNlICdtb2RlbGdlbic6IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2VuZXJhdGVNb2RlbGdlbkFwaUNvZGUocHJvcHMpO1xuICAgICAgfVxuICAgICAgY2FzZSAnaW50cm9zcGVjdGlvbic6IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2VuZXJhdGVJbnRyb3NwZWN0aW9uQXBpQ29kZSgpO1xuICAgICAgfVxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGFtcGxpZnktYmFja2VuZC1ydWxlcy9wcmVmZXItYW1wbGlmeS1lcnJvcnNcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGAke1xuICAgICAgICAgICAgKHByb3BzIGFzIEdlbmVyYXRlQXBpQ29kZVByb3BzKS5mb3JtYXQgYXMgc3RyaW5nXG4gICAgICAgICAgfSBpcyBub3QgYSBzdXBwb3J0ZWQgZm9ybWF0LmBcbiAgICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRXhlY3V0ZSBkb2N1bWVudCwgYW5kIG9wdGlvbmFsbHkgdHlwZSBnZW5lcmF0aW9uIHdpdGggcmVsZXZhbnQgdGFyZ2V0cywgd2lyaW5nIHRocm91Z2ggdHlwZXMgaW50byBzdGF0ZW1lbnRzIGlmIHBvc3NpYmxlLlxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBnZW5lcmF0ZUdyYXBocWxDb2RlZ2VuQXBpQ29kZShcbiAgICBwcm9wczogR2VuZXJhdGVHcmFwaHFsQ29kZWdlbk9wdGlvbnNcbiAgKTogUHJvbWlzZTxHZW5lcmF0aW9uUmVzdWx0PiB7XG4gICAgY29uc3QgZ2VuZXJhdGVNb2RlbHNQYXJhbXM6IERvY3VtZW50R2VuZXJhdGlvblBhcmFtZXRlcnMgPSB7XG4gICAgICB0YXJnZXRGb3JtYXQ6IHByb3BzLnN0YXRlbWVudFRhcmdldCxcbiAgICAgIG1heERlcHRoOiBwcm9wcy5tYXhEZXB0aCxcbiAgICAgIHR5cGVuYW1lSW50cm9zcGVjdGlvbjogcHJvcHMudHlwZU5hbWVJbnRyb3NwZWN0aW9uLFxuICAgIH07XG4gICAgaWYgKFxuICAgICAgcHJvcHMuc3RhdGVtZW50VGFyZ2V0ID09PSBHZW5lcmF0ZUFwaUNvZGVTdGF0ZW1lbnRUYXJnZXQuVFlQRVNDUklQVCAmJlxuICAgICAgcHJvcHMudHlwZVRhcmdldCA9PT0gR2VuZXJhdGVBcGlDb2RlVHlwZVRhcmdldC5UWVBFU0NSSVBUXG4gICAgKSB7XG4gICAgICAvLyBDYXN0IHRvIHVua25vd24gdG8gc3RyaW5nIHNpbmNlIHRoZSBvcmlnaW5hbCBpbnB1dCB0byB0aGlzIGlzIHR5cGVkIGFzIGEgcmVxdWlyZWQgc3RyaW5nLCBidXQgZXhwZWN0cyBhbiBvcHRpb25hbFxuICAgICAgLy8gdmFsdWUsIGFuZCB3ZSB3YW50IHRvIHJlbHkgb24gdGhhdCBiZWhhdmlvci5cbiAgICAgIGNvbnN0IHR5cGVPdXRwdXRGaWxlcGF0aCA9IGdldE91dHB1dEZpbGVOYW1lKFxuICAgICAgICBudWxsIGFzIHVua25vd24gYXMgc3RyaW5nLFxuICAgICAgICBwcm9wcy50eXBlVGFyZ2V0XG4gICAgICApO1xuICAgICAgY29uc3QgZmlsZU5hbWUgPSBwYXRoLnBhcnNlKHR5cGVPdXRwdXRGaWxlcGF0aCkubmFtZTtcbiAgICAgIC8vIFRoaXMgaXMgYW4gbm9kZSBpbXBvcnQgcGF0aCwgc28gd2UgZG9uJ3Qgd2FudCB0byB1c2UgcGF0aC5qb2luLCBzaW5jZSB0aGF0J2xsIHByb2R1Y2UgaW52YWxpZCBwYXRocyBvbiB3aW5kb3dzIHBsYXRmb3Jtc1xuICAgICAgLy8gSGFyZC1jb2Rpbmcgc2luY2UgdGhpcyBtZXRob2QgZXhwbGljaXRseSB3cml0ZXMgdG8gdGhlIHNhbWUgZGlyZWN0b3J5IGlmIHR5cGVzIGFyZSBlbmFibGVkLlxuICAgICAgZ2VuZXJhdGVNb2RlbHNQYXJhbXMucmVsYXRpdmVUeXBlc1BhdGggPSBgLi8ke2ZpbGVOYW1lfWA7XG4gICAgfVxuICAgIGNvbnN0IGRvY3VtZW50cyA9IGF3YWl0IHRoaXMuZ3JhcGhxbERvY3VtZW50R2VuZXJhdG9yLmdlbmVyYXRlTW9kZWxzKFxuICAgICAgZ2VuZXJhdGVNb2RlbHNQYXJhbXNcbiAgICApO1xuXG4gICAgaWYgKHByb3BzLnR5cGVUYXJnZXQpIHtcbiAgICAgIGNvbnN0IHR5cGVzID0gYXdhaXQgdGhpcy5ncmFwaHFsVHlwZXNHZW5lcmF0b3IuZ2VuZXJhdGVUeXBlcyh7XG4gICAgICAgIHRhcmdldDogcHJvcHMudHlwZVRhcmdldCxcbiAgICAgICAgbXVsdGlwbGVTd2lmdEZpbGVzOiBwcm9wcy5tdWx0aXBsZVN3aWZ0RmlsZXMsXG4gICAgICAgIG1heERlcHRoOiBwcm9wcy5tYXhEZXB0aCxcbiAgICAgICAgdHlwZW5hbWVJbnRyb3NwZWN0aW9uOiBwcm9wcy50eXBlTmFtZUludHJvc3BlY3Rpb24sXG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgd3JpdGVUb0RpcmVjdG9yeTogYXN5bmMgKFxuICAgICAgICAgIGRpcmVjdG9yeVBhdGg6IHN0cmluZ1xuICAgICAgICApOiBQcm9taXNlPEdlbmVyYXRlR3JhcGhxbENvZGVnZW5Ub0ZpbGVSZXN1bHQ+ID0+IHtcbiAgICAgICAgICBjb25zdCBmaWxlc1dyaXR0ZW46IHN0cmluZ1tdID0gW107XG4gICAgICAgICAgY29uc3QgeyBmaWxlc1dyaXR0ZW46IGRvY3VtZW50c0ZpbGVzV3JpdHRlbiB9ID1cbiAgICAgICAgICAgIGF3YWl0IGRvY3VtZW50cy53cml0ZVRvRGlyZWN0b3J5KGRpcmVjdG9yeVBhdGgpO1xuICAgICAgICAgIGNvbnN0IHsgZmlsZXNXcml0dGVuOiB0eXBlc0ZpbGVzV3JpdHRlbiB9ID1cbiAgICAgICAgICAgIGF3YWl0IHR5cGVzLndyaXRlVG9EaXJlY3RvcnkoZGlyZWN0b3J5UGF0aCk7XG4gICAgICAgICAgZmlsZXNXcml0dGVuLnB1c2goLi4uZG9jdW1lbnRzRmlsZXNXcml0dGVuLCAuLi50eXBlc0ZpbGVzV3JpdHRlbik7XG5cbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgZmlsZXNXcml0dGVuLFxuICAgICAgICAgIH07XG4gICAgICAgIH0sXG4gICAgICAgIGdldFJlc3VsdHM6IGFzeW5jICgpID0+ICh7XG4gICAgICAgICAgLi4uKGF3YWl0IGRvY3VtZW50cy5nZXRSZXN1bHRzKCkpLFxuICAgICAgICAgIC4uLihhd2FpdCB0eXBlcy5nZXRSZXN1bHRzKCkpLFxuICAgICAgICB9KSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIGRvY3VtZW50cztcbiAgfVxuXG4gIC8qKlxuICAgKiBFeGVjdXRlIG1vZGVsIGdlbmVyYXRpb24gd2l0aCBtb2RlbCB0YXJnZXQuXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGdlbmVyYXRlTW9kZWxnZW5BcGlDb2RlKFxuICAgIHByb3BzOiBHZW5lcmF0ZU1vZGVsc09wdGlvbnNcbiAgKTogUHJvbWlzZTxHZW5lcmF0aW9uUmVzdWx0PiB7XG4gICAgcmV0dXJuIHRoaXMuZ3JhcGhxbE1vZGVsc0dlbmVyYXRvci5nZW5lcmF0ZU1vZGVscyh7XG4gICAgICB0YXJnZXQ6IHByb3BzLm1vZGVsVGFyZ2V0LFxuICAgICAgZ2VuZXJhdGVJbmRleFJ1bGVzOiBwcm9wcy5nZW5lcmF0ZUluZGV4UnVsZXMsXG4gICAgICBlbWl0QXV0aFByb3ZpZGVyOiBwcm9wcy5lbWl0QXV0aFByb3ZpZGVyLFxuICAgICAgdXNlRXhwZXJpbWVudGFsUGlwZWxpbmVkVHJhbnNmb3JtZXI6XG4gICAgICAgIHByb3BzLnVzZUV4cGVyaW1lbnRhbFBpcGVsaW5lZFRyYW5zZm9ybWVyLFxuICAgICAgdHJhbnNmb3JtZXJWZXJzaW9uOiBwcm9wcy50cmFuc2Zvcm1lclZlcnNpb24sXG4gICAgICByZXNwZWN0UHJpbWFyeUtleUF0dHJpYnV0ZXNPbkNvbm5lY3Rpb25GaWVsZDpcbiAgICAgICAgcHJvcHMucmVzcGVjdFByaW1hcnlLZXlBdHRyaWJ1dGVzT25Db25uZWN0aW9uRmllbGQsXG4gICAgICBnZW5lcmF0ZU1vZGVsc0ZvckxhenlMb2FkQW5kQ3VzdG9tU2VsZWN0aW9uU2V0OlxuICAgICAgICBwcm9wcy5nZW5lcmF0ZU1vZGVsc0ZvckxhenlMb2FkQW5kQ3VzdG9tU2VsZWN0aW9uU2V0LFxuICAgICAgYWRkVGltZXN0YW1wRmllbGRzOiBwcm9wcy5hZGRUaW1lc3RhbXBGaWVsZHMsXG4gICAgICBoYW5kbGVMaXN0TnVsbGFiaWxpdHlUcmFuc3BhcmVudGx5OlxuICAgICAgICBwcm9wcy5oYW5kbGVMaXN0TnVsbGFiaWxpdHlUcmFuc3BhcmVudGx5LFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4ZWN1dGUgbW9kZWwgZ2VuZXJhdGlvbiB3aXRoIGludHJvc3BlY3Rpb24gdGFyZ2V0LlxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBnZW5lcmF0ZUludHJvc3BlY3Rpb25BcGlDb2RlKCk6IFByb21pc2U8R2VuZXJhdGlvblJlc3VsdD4ge1xuICAgIHJldHVybiB0aGlzLmdyYXBocWxNb2RlbHNHZW5lcmF0b3IuZ2VuZXJhdGVNb2RlbHMoe1xuICAgICAgdGFyZ2V0OiAnaW50cm9zcGVjdGlvbicsXG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==