import { SecretError } from './secret_error.js';
import { ParameterPathConversions } from '@aws-amplify/platform-core';
/**
 * This class implements Amplify Secret using SSM parameter store.
 */
export class SSMSecretClient {
    ssmClient;
    /**
     * Creates a new instance of SSMSecret.
     */
    constructor(ssmClient) {
        this.ssmClient = ssmClient;
    }
    /**
     * Get a secret from SSM parameter store.
     */
    getSecret = async (backendIdentifier, secretIdentifier) => {
        let secret;
        const name = ParameterPathConversions.toParameterFullPath(backendIdentifier, secretIdentifier.name);
        try {
            const resp = await this.ssmClient.getParameter({
                Name: secretIdentifier.version
                    ? `${name}:${secretIdentifier.version}`
                    : name,
                WithDecryption: true,
            });
            if (resp.Parameter?.Value) {
                secret = {
                    name: secretIdentifier.name,
                    version: resp.Parameter.Version,
                    value: resp.Parameter.Value,
                    lastUpdated: resp.Parameter.LastModifiedDate,
                };
            }
        }
        catch (err) {
            throw SecretError.createInstance(err);
        }
        if (!secret) {
            throw new SecretError(`The value of secret '${secretIdentifier.name}' is undefined`);
        }
        return secret;
    };
    /**
     * List secrets from SSM parameter store.
     */
    listSecrets = async (backendIdentifier) => {
        const path = ParameterPathConversions.toParameterPrefix(backendIdentifier);
        const result = [];
        try {
            let nextToken;
            do {
                const resp = await this.ssmClient.getParametersByPath({
                    Path: path,
                    WithDecryption: true,
                    NextToken: nextToken,
                });
                resp.Parameters?.forEach((param) => {
                    if (!param.Name || !param.Value) {
                        return;
                    }
                    const secretName = param.Name.split('/').pop();
                    if (secretName) {
                        result.push({
                            name: secretName,
                            version: param.Version,
                            lastUpdated: param.LastModifiedDate,
                        });
                    }
                });
                nextToken = resp.NextToken;
            } while (nextToken);
            return result;
        }
        catch (err) {
            throw SecretError.createInstance(err);
        }
    };
    /**
     * Set a secret in SSM parameter store.
     */
    setSecret = async (backendIdentifier, secretName, secretValue) => {
        const name = ParameterPathConversions.toParameterFullPath(backendIdentifier, secretName);
        try {
            const resp = await this.ssmClient.putParameter({
                Name: name,
                Type: 'SecureString',
                Value: secretValue,
                Description: `Amplify Secret`,
                Overwrite: true,
            });
            return {
                name: secretName,
                version: resp.Version,
            };
        }
        catch (err) {
            throw SecretError.createInstance(err);
        }
    };
    /**
     * Remove a secret from SSM parameter store.
     */
    removeSecret = async (backendIdentifier, secretName) => {
        const name = ParameterPathConversions.toParameterFullPath(backendIdentifier, secretName);
        try {
            await this.ssmClient.deleteParameter({
                Name: name,
            });
        }
        catch (err) {
            throw SecretError.createInstance(err);
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3NtX3NlY3JldC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zc21fc2VjcmV0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQVFoRCxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUV0RTs7R0FFRztBQUNILE1BQU0sT0FBTyxlQUFlO0lBSUc7SUFIN0I7O09BRUc7SUFDSCxZQUE2QixTQUFjO1FBQWQsY0FBUyxHQUFULFNBQVMsQ0FBSztJQUFHLENBQUM7SUFFL0M7O09BRUc7SUFDSSxTQUFTLEdBQUcsS0FBSyxFQUN0QixpQkFBNEMsRUFDNUMsZ0JBQWtDLEVBQ2pCLEVBQUU7UUFDbkIsSUFBSSxNQUEwQixDQUFDO1FBQy9CLE1BQU0sSUFBSSxHQUFXLHdCQUF3QixDQUFDLG1CQUFtQixDQUMvRCxpQkFBaUIsRUFDakIsZ0JBQWdCLENBQUMsSUFBSSxDQUN0QixDQUFDO1FBQ0YsSUFBSTtZQUNGLE1BQU0sSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUM7Z0JBQzdDLElBQUksRUFBRSxnQkFBZ0IsQ0FBQyxPQUFPO29CQUM1QixDQUFDLENBQUMsR0FBRyxJQUFJLElBQUksZ0JBQWdCLENBQUMsT0FBTyxFQUFFO29CQUN2QyxDQUFDLENBQUMsSUFBSTtnQkFDUixjQUFjLEVBQUUsSUFBSTthQUNyQixDQUFDLENBQUM7WUFDSCxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUUsS0FBSyxFQUFFO2dCQUN6QixNQUFNLEdBQUc7b0JBQ1AsSUFBSSxFQUFFLGdCQUFnQixDQUFDLElBQUk7b0JBQzNCLE9BQU8sRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU87b0JBQy9CLEtBQUssRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUs7b0JBQzNCLFdBQVcsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLGdC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QUksQ0FBQyxTQUFTLENBQUMsZUFBZSxDQUFDO2dCQUNuQyxJQUFJLEVBQUUsSUFBSTthQUNYLENBQUMsQ0FBQztTQUNKO1FBQUMsT0FBTyxHQUFHLEVBQUU7WUFDWixNQUFNLFdBQVcsQ0FBQyxjQUFjLENBQUMsR0FBWSxDQUFDLENBQUM7U0FDaEQ7SUFDSCxDQUFDLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFNTTSB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zc20nO1xuaW1wb3J0IHsgU2VjcmV0RXJyb3IgfSBmcm9tICcuL3NlY3JldF9lcnJvci5qcyc7XG5pbXBvcnQge1xuICBTZWNyZXQsXG4gIFNlY3JldENsaWVudCxcbiAgU2VjcmV0SWRlbnRpZmllcixcbiAgU2VjcmV0TGlzdEl0ZW0sXG59IGZyb20gJy4vc2VjcmV0LmpzJztcbmltcG9ydCB7IEFwcElkLCBCYWNrZW5kSWRlbnRpZmllciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHsgUGFyYW1ldGVyUGF0aENvbnZlcnNpb25zIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsYXRmb3JtLWNvcmUnO1xuXG4vKipcbiAqIFRoaXMgY2xhc3MgaW1wbGVtZW50cyBBbXBsaWZ5IFNlY3JldCB1c2luZyBTU00gcGFyYW1ldGVyIHN0b3JlLlxuICovXG5leHBvcnQgY2xhc3MgU1NNU2VjcmV0Q2xpZW50IGltcGxlbWVudHMgU2VjcmV0Q2xpZW50IHtcbiAgLyoqXG4gICAqIENyZWF0ZXMgYSBuZXcgaW5zdGFuY2Ugb2YgU1NNU2VjcmV0LlxuICAgKi9cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBzc21DbGllbnQ6IFNTTSkge31cblxuICAvKipcbiAgICogR2V0IGEgc2VjcmV0IGZyb20gU1NNIHBhcmFtZXRlciBzdG9yZS5cbiAgICovXG4gIHB1YmxpYyBnZXRTZWNyZXQgPSBhc3luYyAoXG4gICAgYmFja2VuZElkZW50aWZpZXI6IEJhY2tlbmRJZGVudGlmaWVyIHwgQXBwSWQsXG4gICAgc2VjcmV0SWRlbnRpZmllcjogU2VjcmV0SWRlbnRpZmllclxuICApOiBQcm9taXNlPFNlY3JldD4gPT4ge1xuICAgIGxldCBzZWNyZXQ6IFNlY3JldCB8IHVuZGVmaW5lZDtcbiAgICBjb25zdCBuYW1lOiBzdHJpbmcgPSBQYXJhbWV0ZXJQYXRoQ29udmVyc2lvbnMudG9QYXJhbWV0ZXJGdWxsUGF0aChcbiAgICAgIGJhY2tlbmRJZGVudGlmaWVyLFxuICAgICAgc2VjcmV0SWRlbnRpZmllci5uYW1lXG4gICAgKTtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzcCA9IGF3YWl0IHRoaXMuc3NtQ2xpZW50LmdldFBhcmFtZXRlcih7XG4gICAgICAgIE5hbWU6IHNlY3JldElkZW50aWZpZXIudmVyc2lvblxuICAgICAgICAgID8gYCR7bmFtZX06JHtzZWNyZXRJZGVudGlmaWVyLnZlcnNpb259YFxuICAgICAgICAgIDogbmFtZSxcbiAgICAgICAgV2l0aERlY3J5cHRpb246IHRydWUsXG4gICAgICB9KTtcbiAgICAgIGlmIChyZXNwLlBhcmFtZXRlcj8uVmFsdWUpIHtcbiAgICAgICAgc2VjcmV0ID0ge1xuICAgICAgICAgIG5hbWU6IHNlY3JldElkZW50aWZpZXIubmFtZSxcbiAgICAgICAgICB2ZXJzaW9uOiByZXNwLlBhcmFtZXRlci5WZXJzaW9uLFxuICAgICAgICAgIHZhbHVlOiByZXNwLlBhcmFtZXRlci5WYWx1ZSxcbiAgICAgICAgICBsYXN0VXBkYXRlZDogcmVzcC5QYXJhbWV0ZXIuTGFzdE1vZGlmaWVkRGF0ZSxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRocm93IFNlY3JldEVycm9yLmNyZWF0ZUluc3RhbmNlKGVyciBhcyBFcnJvcik7XG4gICAgfVxuXG4gICAgaWYgKCFzZWNyZXQpIHtcbiAgICAgIHRocm93IG5ldyBTZWNyZXRFcnJvcihcbiAgICAgICAgYFRoZSB2YWx1ZSBvZiBzZWNyZXQgJyR7c2VjcmV0SWRlbnRpZmllci5uYW1lfScgaXMgdW5kZWZpbmVkYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc2VjcmV0O1xuICB9O1xuXG4gIC8qKlxuICAgKiBMaXN0IHNlY3JldHMgZnJvbSBTU00gcGFyYW1ldGVyIHN0b3JlLlxuICAgKi9cbiAgcHVibGljIGxpc3RTZWNyZXRzID0gYXN5bmMgKFxuICAgIGJhY2tlbmRJZGVudGlmaWVyOiBCYWNrZW5kSWRlbnRpZmllciB8IEFwcElkXG4gICk6IFByb21pc2U8U2VjcmV0TGlzdEl0ZW1bXT4gPT4ge1xuICAgIGNvbnN0IHBhdGggPSBQYXJhbWV0ZXJQYXRoQ29udmVyc2lvbnMudG9QYXJhbWV0ZXJQcmVmaXgoYmFja2VuZElkZW50aWZpZXIpO1xuICAgIGNvbnN0IHJlc3VsdDogU2VjcmV0TGlzdEl0ZW1bXSA9IFtdO1xuXG4gICAgdHJ5IHtcbiAgICAgIGxldCBuZXh0VG9rZW46IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICAgIGRvIHtcbiAgICAgICAgY29uc3QgcmVzcCA9IGF3YWl0IHRoaXMuc3NtQ2xpZW50LmdldFBhcmFtZXRlcnNCeVBhdGgoe1xuICAgICAgICAgIFBhdGg6IHBhdGgsXG4gICAgICAgICAgV2l0aERlY3J5cHRpb246IHRydWUsXG4gICAgICAgICAgTmV4dFRva2VuOiBuZXh0VG9rZW4sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJlc3AuUGFyYW1ldGVycz8uZm9yRWFjaCgocGFyYW0pID0+IHtcbiAgICAgICAgICBpZiAoIXBhcmFtLk5hbWUgfHwgIXBhcmFtLlZhbHVlKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IHNlY3JldE5hbWUgPSBwYXJhbS5OYW1lLnNwbGl0KCcvJykucG9wKCk7XG4gICAgICAgICAgaWYgKHNlY3JldE5hbWUpIHtcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHtcbiAgICAgICAgICAgICAgbmFtZTogc2VjcmV0TmFtZSxcbiAgICAgICAgICAgICAgdmVyc2lvbjogcGFyYW0uVmVyc2lvbixcbiAgICAgICAgICAgICAgbGFzdFVwZGF0ZWQ6IHBhcmFtLkxhc3RNb2RpZmllZERhdGUsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBuZXh0VG9rZW4gPSByZXNwLk5leHRUb2tlbjtcbiAgICAgIH0gd2hpbGUgKG5leHRUb2tlbik7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhyb3cgU2VjcmV0RXJyb3IuY3JlYXRlSW5zdGFuY2UoZXJyIGFzIEVycm9yKTtcbiAgICB9XG4gIH07XG5cbiAgLyoqXG4gICAqIFNldCBhIHNlY3JldCBpbiBTU00gcGFyYW1ldGVyIHN0b3JlLlxuICAgKi9cbiAgcHVibGljIHNldFNlY3JldCA9IGFzeW5jIChcbiAgICBiYWNrZW5kSWRlbnRpZmllcjogQmFja2VuZElkZW50aWZpZXIgfCBBcHBJZCxcbiAgICBzZWNyZXROYW1lOiBzdHJpbmcsXG4gICAgc2VjcmV0VmFsdWU6IHN0cmluZ1xuICApOiBQcm9taXNlPFNlY3JldElkZW50aWZpZXI+ID0+IHtcbiAgICBjb25zdCBuYW1lID0gUGFyYW1ldGVyUGF0aENvbnZlcnNpb25zLnRvUGFyYW1ldGVyRnVsbFBhdGgoXG4gICAgICBiYWNrZW5kSWRlbnRpZmllcixcbiAgICAgIHNlY3JldE5hbWVcbiAgICApO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXNwID0gYXdhaXQgdGhpcy5zc21DbGllbnQucHV0UGFyYW1ldGVyKHtcbiAgICAgICAgTmFtZTogbmFtZSxcbiAgICAgICAgVHlwZTogJ1NlY3VyZVN0cmluZycsXG4gICAgICAgIFZhbHVlOiBzZWNyZXRWYWx1ZSxcbiAgICAgICAgRGVzY3JpcHRpb246IGBBbXBsaWZ5IFNlY3JldGAsXG4gICAgICAgIE92ZXJ3cml0ZTogdHJ1ZSxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgbmFtZTogc2VjcmV0TmFtZSxcbiAgICAgICAgdmVyc2lvbjogcmVzcC5WZXJzaW9uLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRocm93IFNlY3JldEVycm9yLmNyZWF0ZUluc3RhbmNlKGVyciBhcyBFcnJvcik7XG4gICAgfVxuICB9O1xuXG4gIC8qKlxuICAgKiBSZW1vdmUgYSBzZWNyZXQgZnJvbSBTU00gcGFyYW1ldGVyIHN0b3JlLlxuICAgKi9cbiAgcHVibGljIHJlbW92ZVNlY3JldCA9IGFzeW5jIChcbiAgICBiYWNrZW5kSWRlbnRpZmllcjogQmFja2VuZElkZW50aWZpZXIgfCBBcHBJZCxcbiAgICBzZWNyZXROYW1lOiBzdHJpbmdcbiAgKSA9PiB7XG4gICAgY29uc3QgbmFtZSA9IFBhcmFtZXRlclBhdGhDb252ZXJzaW9ucy50b1BhcmFtZXRlckZ1bGxQYXRoKFxuICAgICAgYmFja2VuZElkZW50aWZpZXIsXG4gICAgICBzZWNyZXROYW1lXG4gICAgKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5zc21DbGllbnQuZGVsZXRlUGFyYW1ldGVyKHtcbiAgICAgICAgTmFtZTogbmFtZSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhyb3cgU2VjcmV0RXJyb3IuY3JlYXRlSW5zdGFuY2UoZXJyIGFzIEVycm9yKTtcbiAgICB9XG4gIH07XG59XG4iXX0=